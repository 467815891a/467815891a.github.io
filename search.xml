<?xml version="1.0" encoding="utf-8"?>
<search>
  <entry>
    <title>Ubuntu下配置Lineage OS编译环境</title>
    <url>/2019/10/06/Android-envsetup/</url>
    <content><![CDATA[<p>系统为Ubuntu18.04<br>物理内存至少8G起步，16G以上最好，建议SWAP+RAM&gt;=20G，太小会爆内存。<br>硬盘空闲空间必须大于200G，因为光源码就70G左右了。</p>
<span id="more"></span>
<h1 id="安装依赖软件包"><a href="#安装依赖软件包" class="headerlink" title="安装依赖软件包"></a>安装依赖软件包</h1><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="built_in">sudo</span> apt update &amp;&amp; <span class="built_in">sudo</span> apt install -y git curl python-socks libncurses5-dev xclip &amp;&amp; git <span class="built_in">clone</span> https://github.com/467815891a/AndroidEnv_setup.git &amp;&amp; <span class="built_in">cd</span> AndroidEnv_setup &amp;&amp; <span class="built_in">sudo</span> bash setup/android_build_env.sh &amp;&amp; <span class="built_in">cd</span> ..</span><br></pre></td></tr></table></figure>
<h1 id="设置-git用户名和邮箱"><a href="#设置-git用户名和邮箱" class="headerlink" title="设置 git用户名和邮箱"></a>设置 git用户名和邮箱</h1><p>这一步其实可以省略，git clone的时候告诉远程仓库的托管服务商（如github）你的个人信息，用于认证，可以减少你被ban的几率。<br>示例如下：</p>
<figure class="highlight nginx"><table><tr><td class="code"><pre><span class="line"><span class="attribute">git</span> config --global user.email <span class="string">&quot;you<span class="variable">@example</span>.com&quot;</span></span><br></pre></td></tr></table></figure>
<figure class="highlight stylus"><table><tr><td class="code"><pre><span class="line">git config <span class="attr">--global</span> user<span class="selector-class">.name</span> <span class="string">&quot;Your Name&quot;</span></span><br></pre></td></tr></table></figure>
<p>双引号中的 <code>“you@example.com” </code>填写您的 github 所使用的邮箱。注意格式，不要把双引号去掉。<br>双引号中的 <code>“Your Name” </code>填写您的 github 用户名，不要把双引号去掉。</p>
<h1 id="生成-ssh-并添加到-github"><a href="#生成-ssh-并添加到-github" class="headerlink" title="生成 ssh 并添加到 github"></a>生成 ssh 并添加到 github</h1><figure class="highlight excel"><table><tr><td class="code"><pre><span class="line">ssh-keygen -<span class="built_in">t</span> <span class="symbol">ed25519</span> -C <span class="string">&quot;you@example.com&quot;</span></span><br></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="built_in">eval</span> <span class="string">&quot;<span class="subst">$(ssh-agent -s)</span>&quot;</span></span><br><span class="line">ssh-add ~/.ssh/id_ed25519</span><br><span class="line">xclip -selection clipboard &lt; ~/.ssh/id_ed25519.pub</span><br></pre></td></tr></table></figure>
<p>然后将剪切板的内容粘贴到Github网站的个人设置中，详见<a target="_blank" rel="noopener" href="https://docs.github.com/articles/generating-an-ssh-key/">Github官方指导</a></p>
<h1 id="自行repo-init项目-以lineageos为例"><a href="#自行repo-init项目-以lineageos为例" class="headerlink" title="自行repo init项目(以lineageos为例)"></a>自行repo init项目(以lineageos为例)</h1><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="built_in">mkdir</span> lineageos &amp;&amp; <span class="built_in">cd</span> lineageos &amp;&amp; repo init -u git://github.com/LineageOS/android.git -b lineage-17.0</span><br></pre></td></tr></table></figure>
<h1 id="新建local-manifests（或者手动同步device-tree，kernel-tree，vendor-tree）"><a href="#新建local-manifests（或者手动同步device-tree，kernel-tree，vendor-tree）" class="headerlink" title="新建local_manifests（或者手动同步device tree，kernel tree，vendor tree）"></a>新建local_manifests（或者手动同步device tree，kernel tree，vendor tree）</h1><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="built_in">mkdir</span> .repo/local_manifests</span><br></pre></td></tr></table></figure>
<h1 id="同步项目"><a href="#同步项目" class="headerlink" title="同步项目"></a>同步项目</h1><p>因为网络环境不好，需要脚本自动化同步，失败不停重试。<br>在lineageos文件夹中新建<code>repo.sh</code>并写入脚本</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="built_in">cat</span> &gt; repo.sh &lt;&lt; <span class="string">&#x27;EOF&#x27;</span></span><br><span class="line"><span class="comment">#!/bin/bash</span></span><br><span class="line"><span class="comment">#是否启用本地代理同步源码 (需要配合ss-local开启使用)</span></span><br><span class="line">ENABLE_PROXY=0</span><br><span class="line"><span class="comment">#SS的服务器地址</span></span><br><span class="line">SERVER=</span><br><span class="line"><span class="comment">#SS的远程端口</span></span><br><span class="line">PORT=</span><br><span class="line"><span class="comment">#SS的密码</span></span><br><span class="line">PASSWD=</span><br><span class="line"><span class="comment">#SS的加密方式</span></span><br><span class="line">METHOD=chacha20-ietf-poly1305</span><br><span class="line"><span class="comment">#SS的本地监听端口</span></span><br><span class="line">LOCAL=1080</span><br><span class="line">NAME=Shadowsocks-<span class="built_in">local</span></span><br><span class="line">PID_FILE=<span class="variable">$HOME</span>/shadowsocks-local.pid</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="title">check_running</span></span>() &#123;</span><br><span class="line">    <span class="keyword">if</span> [ -r <span class="variable">$PID_FILE</span> ]; <span class="keyword">then</span></span><br><span class="line">        <span class="built_in">read</span> PID &lt; <span class="variable">$PID_FILE</span></span><br><span class="line">        <span class="keyword">if</span> [ -d <span class="string">&quot;/proc/<span class="variable">$PID</span>&quot;</span> ]; <span class="keyword">then</span></span><br><span class="line">            <span class="built_in">return</span> 0</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">            <span class="built_in">rm</span> -f <span class="variable">$PID_FILE</span></span><br><span class="line">            <span class="built_in">return</span> 1</span><br><span class="line">        <span class="keyword">fi</span></span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        <span class="built_in">return</span> 2</span><br><span class="line">    <span class="keyword">fi</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="title">proxy_off</span></span>() &#123;</span><br><span class="line">    <span class="keyword">if</span> check_running; <span class="keyword">then</span></span><br><span class="line">        <span class="built_in">kill</span> -9 <span class="variable">$PID</span></span><br><span class="line">        <span class="built_in">rm</span> -f <span class="variable">$PID_FILE</span></span><br><span class="line">        <span class="built_in">echo</span> <span class="string">&quot;Stopping <span class="variable">$NAME</span> success&quot;</span></span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        <span class="built_in">echo</span> <span class="string">&quot;<span class="variable">$NAME</span> is stopped&quot;</span></span><br><span class="line">    <span class="keyword">fi</span></span><br><span class="line">    <span class="built_in">return</span> 0</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="title">proxy_on</span></span>() &#123;</span><br><span class="line">    check_running</span><br><span class="line">    <span class="keyword">case</span> $? <span class="keyword">in</span></span><br><span class="line">        0)</span><br><span class="line">        <span class="built_in">echo</span> <span class="string">&quot;<span class="variable">$NAME</span> (pid <span class="variable">$PID</span>) is running..., trying to restart&quot;</span></span><br><span class="line">        proxy_off</span><br><span class="line">        ;;</span><br><span class="line">        1|2)</span><br><span class="line">        <span class="built_in">command</span> -v ss-local &gt;/dev/null 2&gt;&amp;1 || &#123; <span class="built_in">echo</span> &gt;&amp;2 <span class="string">&quot;你好像没有安装ss-local&quot;</span>;<span class="built_in">exit</span> 1;&#125;</span><br><span class="line">        ;;</span><br><span class="line">    <span class="keyword">esac</span></span><br><span class="line">    ss-local -b 127.0.0.1 -s <span class="variable">$SERVER</span> -p <span class="variable">$PORT</span> -l <span class="variable">$LOCAL</span> -m <span class="variable">$METHOD</span> -k <span class="variable">$PASSWD</span> -f <span class="variable">$PID_FILE</span></span><br><span class="line">    <span class="keyword">if</span> check_running; <span class="keyword">then</span></span><br><span class="line">        <span class="built_in">echo</span> <span class="string">&quot;Starting <span class="variable">$NAME</span> success&quot;</span></span><br><span class="line">        <span class="built_in">export</span> http_proxy=<span class="string">&quot;socks5://127.0.0.1:<span class="variable">$&#123;LOCAL&#125;</span>&quot;</span></span><br><span class="line">        <span class="built_in">export</span> https_proxy=<span class="string">&quot;socks5://127.0.0.1:<span class="variable">$&#123;LOCAL&#125;</span>&quot;</span></span><br><span class="line">        <span class="built_in">echo</span> <span class="string">&quot;Setting Socks5 proxy for this shell success&quot;</span></span><br><span class="line">        <span class="built_in">return</span> 0</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        <span class="built_in">echo</span> <span class="string">&quot;Starting <span class="variable">$NAME</span> failed&quot;</span></span><br><span class="line">        <span class="built_in">unset</span> https_proxy</span><br><span class="line">        <span class="built_in">unset</span> http_proxy</span><br><span class="line">        <span class="built_in">echo</span> <span class="string">&quot;Unsetting Socks5 proxy for this shell success&quot;</span></span><br><span class="line">        retrun 1</span><br><span class="line">    <span class="keyword">fi</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="title">repo_sync</span></span>() &#123;</span><br><span class="line">    <span class="keyword">if</span> [ <span class="variable">$ENABLE_PROXY</span> == <span class="string">&#x27;0&#x27;</span> ]; <span class="keyword">then</span></span><br><span class="line">        <span class="built_in">echo</span> <span class="string">&quot;==========不使用代理同步源码=========&quot;</span></span><br><span class="line">        proxy_off</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        <span class="keyword">if</span> proxy_on; <span class="keyword">then</span> </span><br><span class="line">            <span class="built_in">echo</span> <span class="string">&quot;=========开始使用代理同步源码=========&quot;</span></span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">            <span class="built_in">echo</span> <span class="string">&quot;========开启代理失败,不使用代理同步源码========&quot;</span></span><br><span class="line">        <span class="keyword">fi</span></span><br><span class="line">    <span class="keyword">fi</span></span><br><span class="line">    <span class="built_in">sleep</span> 3</span><br><span class="line">    repo <span class="built_in">sync</span> -j4 --no-clone-bundle --no-tags --force-sync</span><br><span class="line">    <span class="keyword">while</span> [ $? -ne 0 ]; <span class="keyword">do</span></span><br><span class="line">        <span class="built_in">echo</span> <span class="string">&quot;======同步中断，重试中======&quot;</span> </span><br><span class="line">        repo_sync</span><br><span class="line">    <span class="keyword">done</span></span><br><span class="line">    proxy_off</span><br><span class="line">    <span class="built_in">return</span> 0</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">case</span> <span class="string">&quot;<span class="variable">$1</span>&quot;</span> <span class="keyword">in</span></span><br><span class="line">    <span class="built_in">sync</span>)</span><br><span class="line">        repo_sync</span><br><span class="line">	;;</span><br><span class="line">    status)</span><br><span class="line">        <span class="keyword">if</span> [ ! -n <span class="string">&quot;<span class="variable">$https_proxy</span>&quot;</span> ]; <span class="keyword">then</span></span><br><span class="line">            <span class="built_in">echo</span> <span class="string">&quot;当前终端代理设置为空&quot;</span></span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">            <span class="built_in">echo</span> <span class="string">&quot;当前终端代理设置为<span class="variable">$&#123;https_proxy&#125;</span>&quot;</span></span><br><span class="line">        <span class="keyword">fi</span></span><br><span class="line">        check_running</span><br><span class="line">            <span class="keyword">case</span> $? <span class="keyword">in</span></span><br><span class="line">                0)</span><br><span class="line">                <span class="built_in">echo</span> <span class="string">&quot;<span class="variable">$NAME</span> (pid <span class="variable">$PID</span>) is running...&quot;</span></span><br><span class="line">                ;;</span><br><span class="line">                1|2)</span><br><span class="line">                <span class="built_in">echo</span> <span class="string">&quot;<span class="variable">$NAME</span> is stopped&quot;</span></span><br><span class="line">                ;;</span><br><span class="line">            <span class="keyword">esac</span></span><br><span class="line">    ;;</span><br><span class="line">    proxy)</span><br><span class="line">        proxy_on</span><br><span class="line">    ;;</span><br><span class="line">    unproxy)</span><br><span class="line">        proxy_off</span><br><span class="line">        <span class="built_in">unset</span> http_proxy</span><br><span class="line">        <span class="built_in">unset</span> https_proxy</span><br><span class="line">        <span class="built_in">echo</span> <span class="string">&quot;Unsetting Socks5 proxy for this shell success&quot;</span></span><br><span class="line">    ;;</span><br><span class="line">    *)</span><br><span class="line">        repo_sync</span><br><span class="line">    ;;</span><br><span class="line"><span class="keyword">esac</span></span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>
<p>赋予脚本执行权限并开始同步源码。</p>
<figure class="highlight css"><table><tr><td class="code"><pre><span class="line">chmod <span class="selector-tag">a</span>+<span class="attribute">x</span> repo<span class="selector-class">.sh</span></span><br><span class="line">bash repo<span class="selector-class">.sh</span></span><br></pre></td></tr></table></figure>
<h1 id="添加一些环境变量"><a href="#添加一些环境变量" class="headerlink" title="添加一些环境变量"></a>添加一些环境变量</h1><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="built_in">echo</span> <span class="string">&#x27;export ALLOW_MISSING_DEPENDENCIES=true&#x27;</span> &gt;&gt; ~/.bashrc</span><br><span class="line"><span class="built_in">echo</span> <span class="string">&#x27;export USE_CCACHE=1&#x27;</span> &gt;&gt; ~/.bashrc</span><br><span class="line"><span class="built_in">echo</span> <span class="string">&#x27;export  _JAVA_OPTIONS=&quot;-Dfile.encoding=UTF-8 -XX:+TieredCompilation -Xmx8g&quot;&#x27;</span> &gt;&gt; ~/.bashrc</span><br><span class="line"><span class="built_in">source</span> ~/.bashrc &amp;&amp; <span class="built_in">export</span> LANG=C</span><br></pre></td></tr></table></figure>
<h1 id="开始编译"><a href="#开始编译" class="headerlink" title="开始编译"></a>开始编译</h1><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="built_in">source</span> build/envsetup.sh</span><br><span class="line">lunch</span><br><span class="line"></span><br></pre></td></tr></table></figure>


]]></content>
      <tags>
        <tag>Android</tag>
      </tags>
  </entry>
  <entry>
    <title>利用ESPHome自制万能遥控器</title>
    <url>/2022/03/06/ESPHome-IRomte/</url>
    <content><![CDATA[<p>最近捣鼓智能家居，用ESP32/ESP8266控制家里传统红外遥控的空调。其他红外的机顶盒、电视盒子也同理。</p>
<h1 id="硬件与软件准备工作"><a href="#硬件与软件准备工作" class="headerlink" title="硬件与软件准备工作"></a>硬件与软件准备工作</h1><table>
<thead>
<tr>
<th align="left">硬件</th>
<th align="right">软件</th>
</tr>
</thead>
<tbody><tr>
<td align="left">ESP32</td>
<td align="right">ESPHome v2022.2.1</td>
</tr>
<tr>
<td align="left">NAS/软路由</td>
<td align="right">Homeassistant 2021.11.4</td>
</tr>
<tr>
<td align="left">5mm红外发射头（940nm)</td>
<td align="right"></td>
</tr>
<tr>
<td align="left">红外接收头(型号随意)</td>
<td align="right"></td>
</tr>
</tbody></table>
<p><img src="IR-rx.png" alt="IR_RX"><br><img src="IR_tx.png" alt="IR_TX"><br>红外发射和接受按照上面电路连接，红外发射头由ESP32的GPIO27控制，红外接收头由GPIO14输入。</p>
<h1 id="红外接收与遥控器学习"><a href="#红外接收与遥控器学习" class="headerlink" title="红外接收与遥控器学习"></a>红外接收与遥控器学习</h1><p>详细参见<a target="_blank" rel="noopener" href="https://esphome.io/components/remote_receiver.html">ESPHome的Remote Receiver章节</a>，下面粘贴我的ESPHome的编译配置yaml。</p>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">esphome:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">esp32</span></span><br><span class="line"></span><br><span class="line"><span class="attr">esp32:</span></span><br><span class="line">  <span class="attr">board:</span> <span class="string">esp32dev</span></span><br><span class="line">  <span class="attr">framework:</span></span><br><span class="line">    <span class="attr">type:</span> <span class="string">esp-idf</span></span><br><span class="line">    <span class="attr">version:</span> <span class="string">latest</span></span><br><span class="line">    <span class="comment"># Custom sdkconfig options</span></span><br><span class="line">    <span class="attr">sdkconfig_options:</span></span><br><span class="line">      <span class="attr">CONFIG_COMPILER_OPTIMIZATION_SIZE:</span> <span class="string">y</span></span><br><span class="line">    <span class="comment"># Advanced tweaking options</span></span><br><span class="line">    <span class="attr">advanced:</span></span><br><span class="line">      <span class="attr">ignore_efuse_mac_crc:</span> <span class="literal">false</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Enable logging</span></span><br><span class="line"><span class="attr">logger:</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Enable Home Assistant API</span></span><br><span class="line"><span class="attr">api:</span></span><br><span class="line"></span><br><span class="line"><span class="attr">ota:</span></span><br><span class="line">  <span class="attr">password:</span> <span class="string">&quot;&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="attr">wifi:</span></span><br><span class="line">  <span class="attr">ssid:</span> <span class="type">!secret</span> <span class="string">wifi_ssid</span></span><br><span class="line">  <span class="attr">password:</span> <span class="type">!secret</span> <span class="string">wifi_password</span></span><br><span class="line"></span><br><span class="line"><span class="attr">remote_receiver:</span></span><br><span class="line">  <span class="attr">pin:</span> </span><br><span class="line">    <span class="attr">number:</span> <span class="string">GPIO14</span></span><br><span class="line">    <span class="attr">inverted:</span> <span class="literal">True</span></span><br><span class="line">  <span class="attr">dump:</span> <span class="string">raw</span></span><br><span class="line">  <span class="attr">tolerance:</span> </span><br><span class="line">    <span class="attr">type:</span> <span class="string">percentage</span></span><br><span class="line">    <span class="attr">value:</span> <span class="number">70</span><span class="string">%</span></span><br><span class="line">  <span class="attr">idle:</span> <span class="string">50ms</span></span><br></pre></td></tr></table></figure>
<p>这里说明一下官方文档没有详细说明的地方：</p>
<ol>
<li>在<code>remote_receiver:</code>中<code>inverted: True</code>目的是设置电平反转，我一开始忽略了，获取的红外编码正好是反的，一堆乱七八糟。后来发现ESPHome在开机的logs中对我发出警告和建议，我才知道要设置这个。</li>
<li>在<code>remote_receiver:</code>中<code>dump: raw</code>的目的是接收到的所有红外编码一律不解析，按照raw格式记录。dump的可选类型很多，其中nec编码据说是使用类型最广泛的红外编码，兼容90%以上的电器。但是我觉得事实并不是这样，不然ESPHome就不会还有其他那么多其他类型可以选择了。千万不要选择<code>all</code>类型，这样一段红外编码可能会被错误得尝试解析成各种类型，非常糟糕。</li>
<li>在<code>remote_receiver:</code>中<code>idle: 50ms</code>非常重要，你可以理解为红外信号的超时等待时间。在一些私有协议的红外编码中（比如我家的格力空调），一条指令有可能里面的某段红外代码之间间隔比较长，会被ESPHome识别为两段甚至是多段单独的红外代码。将idle值设当设置偏大可以规避这个问题。<br>编译固件并上传到ESP32，打开logs，然后你就可以对准红外接收头，按下你想要学习的按键，比如以下是我抓取到的日志。<figure class="highlight subunit"><table><tr><td class="code"><pre><span class="line">INFO Reading configuration /config/esp32.yaml...</span><br><span class="line">INFO Starting log output from esp32.local using esphome API</span><br><span class="line">INFO Successfully connected to esp32.local</span><br><span class="line">[21:03:57][I][app:102]: ESPHome version 2022.2.4 compiled on Mar  5 2022, 20:52:27</span><br><span class="line">[21:03:58][C][wifi:491]: WiFi:</span><br><span class="line">[21:03:58][C][wifi:353]:   Local MAC: 78:E3:6D:19:11:C4</span><br><span class="line">[21:03:58][C][wifi:354]:   SSID: &#x27;GECOOS&#x27;[redacted]</span><br><span class="line">[21:03:58][C][wifi:355]:   IP Address: 192.168.0.178</span><br><span class="line">[21:03:58][C][wifi:357]:   BSSID: 1C:88:79:5F:E5:E2[redacted]</span><br><span class="line">[21:03:58][C][wifi:358]:   Hostname: &#x27;esp32&#x27;</span><br><span class="line">[21:03:58][C][wifi:360]:   Signal strength: <span class="string">-47</span> dB ▂▄▆█</span><br><span class="line">[21:03:58][C][wifi:364]:   Channel: 6</span><br><span class="line">[21:03:58][C][wifi:365]:   Subnet: 255.255.255.0</span><br><span class="line">[21:03:58][C][wifi:366]:   Gateway: 192.168.0.1</span><br><span class="line">[21:03:58][C][wifi:367]:   DNS1: 192.168.0.1</span><br><span class="line">[21:03:58][C][wifi:368]:   DNS2: 0.0.0.0</span><br><span class="line">[21:03:58][C][logger:233]: Logger:</span><br><span class="line">[21:03:58][C][logger:234]:   Level: DEBUG</span><br><span class="line">[21:03:58][C][logger:235]:   Log Baud Rate: 115200</span><br><span class="line">[21:03:58][C][logger:236]:   Hardware UART: UART0</span><br><span class="line">[21:03:58][C][remote_receiver.esp32:054]: Remote Receiver:</span><br><span class="line">[21:03:58][C][remote_receiver.esp32:055]:   Pin: GPIO14</span><br><span class="line">[21:03:58][C][remote_receiver.esp32:060]:   Channel: 0</span><br><span class="line">[21:03:58][C][remote_receiver.esp32:061]:   RMT memory blocks: 3</span><br><span class="line">[21:03:58][C][remote_receiver.esp32:062]:   Clock divider: 80</span><br><span class="line">[21:03:58][C][remote_receiver.esp32:063]:   Tolerance: 25%</span><br><span class="line">[21:03:58][C][remote_receiver.esp32:064]:   Filter out pulses shorter than: 50 us</span><br><span class="line">[21:03:58][C][remote_receiver.esp32:065]:   Signal is done after 40000 us of no changes</span><br><span class="line">[21:03:58][C][mdns:084]: mDNS:</span><br><span class="line">[21:03:58][C][mdns:085]:   Hostname: esp32</span><br><span class="line">[21:03:58][C][ota:085]: Over-The-Air Updates:</span><br><span class="line">[21:03:58][C][ota:086]:   Address: esp32.local:3232</span><br><span class="line">[21:03:58][C][ota:089]:   Using Password.</span><br><span class="line">[21:03:58][C][api:138]: API Server:</span><br><span class="line">[21:03:58][C][api:139]:   Address: esp32.local:6053</span><br><span class="line">[21:03:58][C][api:143]:   Using noise encryption: NO</span><br><span class="line">[21:04:13][D][remote.raw:028]: Received Raw: 9021, <span class="string">-4476</span>, 625, <span class="string">-1666</span>, 624, <span class="string">-565</span>, 624, <span class="string">-567</span>, 625, <span class="string">-567</span>, 621, <span class="string">-567</span>, 626, <span class="string">-566</span>, 622, <span class="string">-1666</span>, 624, <span class="string">-566</span>, 623, <span class="string">-1666</span>, 626, <span class="string">-1691</span>, 597, <span class="string">-566</span>, 626, <span class="string">-1664</span>, 625, <span class="string">-593</span>, 597, <span class="string">-566</span>, 624, <span class="string">-566</span>, 625, <span class="string">-565</span>, 624, <span class="string">-565</span>, 622, <span class="string">-569</span>, 624, <span class="string">-565</span>, 625, <span class="string">-565</span>, 625, <span class="string">-592</span>, 599, <span class="string">-564</span>, 624, <span class="string">-566</span>, 626, <span class="string">-564</span>, 626, <span class="string">-565</span>, 625, <span class="string">-566</span>, 623, <span class="string">-565</span>, 624, <span class="string">-566</span>, 624, <span class="string">-1666</span>, 625, <span class="string">-565</span>, 625, <span class="string">-1665</span>, 626, <span class="string">-564</span>, 623, <span class="string">-567</span>, 624, <span class="string">-1666</span>, 623, <span class="string">-567</span>, 626, <span class="string">-19983</span>, 625, <span class="string">-1665</span>, 624, <span class="string">-567</span>, 625, <span class="string">-564</span>, 624, <span class="string">-566</span>, 626, <span class="string">-1664</span>, 623, <span class="string">-593</span>, 599, <span class="string">-565</span>, 624, <span class="string">-566</span>, 624, <span class="string">-566</span>, 624, <span class="string">-594</span>, 598, <span class="string">-566</span>, 622, <span class="string">-567</span>, 624, <span class="string">-591</span>, 598, <span class="string">-1666</span>, 625, <span class="string">-565</span>, 623, <span class="string">-567</span>, 624, <span class="string">-569</span>, 622, <span class="string">-564</span>, 625, <span class="string">-568</span>, 621, <span class="string">-569</span>, 624, <span class="string">-564</span>, 623, <span class="string">-567</span>, 625, <span class="string">-564</span>, 624, <span class="string">-566</span>, 623, <span class="string">-568</span>, 624, <span class="string">-566</span>, 623, <span class="string">-566</span>, 626, <span class="string">-566</span>, 622, <span class="string">-1666</span>, 623, <span class="string">-568</span>, 623, <span class="string">-567</span>, 624, <span class="string">-1665</span>, 624, <span class="string">-7194</span>, 9041, <span class="string">-4481</span>, 626, <span class="string">-1665</span>, 624, <span class="string">-568</span>, 621, <span class="string">-566</span>, 622, <span class="string">-569</span>, 625, <span class="string">-567</span>, 622, <span class="string">-568</span>, 621, <span class="string">-1668</span>, 622, <span class="string">-566</span>, 624, <span class="string">-1666</span>, 625, <span class="string">-1666</span>, 623, <span class="string">-567</span>, 625, <span class="string">-1664</span>, 623, <span class="string">-594</span>, 598, <span class="string">-591</span>, 599, <span class="string">-566</span>, 621, <span class="string">-595</span>, 599, <span class="string">-565</span>, 625, <span class="string">-564</span>, 624, <span class="string">-566</span>, 625, <span class="string">-567</span>, 622, <span class="string">-569</span>, 622, <span class="string">-565</span>, 623, <span class="string">-569</span>, 623, <span class="string">-568</span>, 622, <span class="string">-567</span>, 622, <span class="string">-568</span>, 621, <span class="string">-567</span>, 624, <span class="string">-566</span>, 623, <span class="string">-1669</span>, 623, <span class="string">-1692</span>, 597, <span class="string">-1666</span>, 624, <span class="string">-565</span>, 625, <span class="string">-566</span>, 624, <span class="string">-1668</span>, 622, <span class="string">-565</span>, 623, <span class="string">-19985</span>, 627, <span class="string">-565</span>, 626, <span class="string">-564</span>, 626, <span class="string">-565</span>, 623, <span class="string">-566</span>, 625, <span class="string">-566</span>, 623, <span class="string">-593</span>, 595, <span class="string">-594</span>, 600, <span class="string">-565</span>, 622, <span class="string">-593</span>, 597, <span class="string">-567</span>, 624, <span class="string">-566</span>, 623, <span class="string">-567</span>, 624, <span class="string">-566</span>, 625, <span class="string">-565</span>, 625, <span class="string">-565</span>, 626, <span class="string">-564</span>, 623, <span class="string">-567</span>, 623, <span class="string">-567</span>, 623, <span class="string">-569</span>, 622, <span class="string">-566</span>, 622, <span class="string">-568</span>, 622, <span class="string">-569</span>, 623, <span class="string">-566</span>, 623, <span class="string">-567</span>, 623, <span class="string">-566</span>, 624, <span class="string">-567</span>, 623, <span class="string">-566</span>, 624, <span class="string">-568</span>, 623, <span class="string">-566</span>, 622, <span class="string">-1667</span>, 625, <span class="string">-1665</span>, 623, <span class="string">-594</span>, 596</span><br><span class="line">[21:04:13][D][remote.raw:041]: Received Raw: 81</span><br><span class="line">[21:04:13][D][remote.raw:041]: Received Raw: 153</span><br><span class="line">[21:04:29][D][remote.raw:041]: Received Raw: 178</span><br><span class="line">[21:04:29][D][remote.raw:028]: Received Raw: 9048, <span class="string">-4448</span>, 653, <span class="string">-1665</span>, 623, <span class="string">-539</span>, 653, <span class="string">-537</span>, 650, <span class="string">-1668</span>, 625, <span class="string">-537</span>, 654, <span class="string">-537</span>, 650, <span class="string">-1640</span>, 650, <span class="string">-539</span>, 652, <span class="string">-1639</span>, 651, <span class="string">-1638</span>, 651, <span class="string">-539</span>, 652, <span class="string">-1638</span>, 653, <span class="string">-538</span>, 651, <span class="string">-539</span>, 650, <span class="string">-540</span>, 652, <span class="string">-538</span>, 650, <span class="string">-539</span>, 652, <span class="string">-539</span>, 651, <span class="string">-537</span>, 652, <span class="string">-538</span>, 652, <span class="string">-538</span>, 652, <span class="string">-1638</span>, 651, <span class="string">-540</span>, 652, <span class="string">-537</span>, 653, <span class="string">-538</span>, 650, <span class="string">-567</span>, 623, <span class="string">-539</span>, 651, <span class="string">-539</span>, 651, <span class="string">-1639</span>, 652, <span class="string">-566</span>, 623, <span class="string">-1639</span>, 652, <span class="string">-538</span>, 653, <span class="string">-537</span>, 652, <span class="string">-1638</span>, 652, <span class="string">-539</span>, 651, <span class="string">-19956</span>, 653, <span class="string">-1638</span>, 653, <span class="string">-539</span>, 652, <span class="string">-536</span>, 650, <span class="string">-541</span>, 650, <span class="string">-1666</span>, 627, <span class="string">-536</span>, 654, <span class="string">-536</span>, 650, <span class="string">-541</span>, 653, <span class="string">-537</span>, 650, <span class="string">-539</span>, 653, <span class="string">-565</span>, 625, <span class="string">-537</span>, 652, <span class="string">-538</span>, 652, <span class="string">-1638</span>, 652, <span class="string">-540</span>, 650, <span class="string">-541</span>, 649, <span class="string">-565</span>, 625, <span class="string">-566</span>, 624, <span class="string">-538</span>, 651, <span class="string">-539</span>, 651, <span class="string">-539</span>, 653, <span class="string">-537</span>, 652, <span class="string">-565</span>, 624, <span class="string">-539</span>, 652, <span class="string">-538</span>, 652, <span class="string">-539</span>, 649, <span class="string">-539</span>, 653, <span class="string">-564</span>, 625, <span class="string">-1639</span>, 652, <span class="string">-539</span>, 650, <span class="string">-539</span>, 652, <span class="string">-565</span>, 625, <span class="string">-7187</span>, 9047, <span class="string">-4453</span>, 653, <span class="string">-1640</span>, 649, <span class="string">-566</span>, 625, <span class="string">-540</span>, 651, <span class="string">-1637</span>, 652, <span class="string">-538</span>, 651, <span class="string">-539</span>, 651, <span class="string">-1638</span>, 653, <span class="string">-538</span>, 650, <span class="string">-1640</span>, 651, <span class="string">-1640</span>, 652, <span class="string">-537</span>, 652, <span class="string">-1637</span>, 653, <span class="string">-537</span>, 652, <span class="string">-541</span>, 649, <span class="string">-538</span>, 653, <span class="string">-538</span>, 652,  <span class="string">-540</span>, 649, <span class="string">-565</span>, 626, <span class="string">-539</span>, 651, <span class="string">-539</span>, 653, <span class="string">-537</span>, 652, <span class="string">-1637</span>, 652, <span class="string">-538</span>, 653, <span class="string">-537</span>, 652, <span class="string">-565</span>, 625, <span class="string">-564</span>, 627, <span class="string">-537</span>, 653, <span class="string">-537</span>, 652, <span class="string">-1664</span>, 627, <span class="string">-1636</span>, 653, <span class="string">-1637</span>, 654, <span class="string">-563</span>, 626, <span class="string">-538</span>, 653, <span class="string">-1637</span>, 653, <span class="string">-537</span>, 651, <span class="string">-19956</span>, 653, <span class="string">-539</span>, 654, <span class="string">-537</span>, 650,  <span class="string">-566</span>, 625, <span class="string">-538</span>, 652, <span class="string">-538</span>, 652, <span class="string">-538</span>, 654, <span class="string">-536</span>, 651, <span class="string">-539</span>, 652, <span class="string">-538</span>, 653, <span class="string">-564</span>, 624, <span class="string">-539</span>, 651, <span class="string">-539</span>, 651, <span class="string">-539</span>, 651, <span class="string">-538</span>, 651, <span class="string">-540</span>, 651, <span class="string">-538</span>, 653, <span class="string">-538</span>, 652, <span class="string">-537</span>, 652, <span class="string">-538</span>, 652, <span class="string">-565</span>, 624, <span class="string">-567</span>, 625, <span class="string">-538</span>, 653, <span class="string">-562</span>, 626, <span class="string">-538</span>, 652, <span class="string">-538</span>, 651,  <span class="string">-540</span>, 651, <span class="string">-538</span>, 654, <span class="string">-536</span>, 653, <span class="string">-537</span>, 651, <span class="string">-1665</span>, 627, <span class="string">-1637</span>, 652, <span class="string">-1638</span>, 652</span><br><span class="line">[21:04:29][D][remote.raw:041]: Received Raw: 132</span><br></pre></td></tr></table></figure>
我按了一个关闭空调和打开空调制冷的按钮，可以看到学习到了两段红外代码。要注意，有时候一段红外代码显示不完，ESPHome会把一段红外代码分成多条不同时间戳的log，大家不要以时间戳作为分开红外指令的标准，而是以一个<code>Received Raw:</code>字样到下一个<code>Received Raw:</code>之间的数字数组作为一条完整的红外代码。可以看到我的日志里面还有很多干扰的红外代码，这是由于我的供电不稳定导致的，可以忽略。</li>
</ol>
<h1 id="红外发射与Home-Assistant控制"><a href="#红外发射与Home-Assistant控制" class="headerlink" title="红外发射与Home Assistant控制"></a>红外发射与Home Assistant控制</h1><p>详细参见<a target="_blank" rel="noopener" href="https://esphome.io/components/remote_transmitter.html">ESPHome的Remote Transmitter章节</a><br>废话不说，直接上ESPHome的编译yaml文件。</p>
<figure class="highlight subunit"><table><tr><td class="code"><pre><span class="line">esphome:</span><br><span class="line">  name: esp32</span><br><span class="line"></span><br><span class="line">esp32:</span><br><span class="line">  board: esp32dev</span><br><span class="line">  framework:</span><br><span class="line">    type: esp-idf</span><br><span class="line">    version: latest</span><br><span class="line">    # Custom sdkconfig options</span><br><span class="line">    sdkconfig_options:</span><br><span class="line">      CONFIG_COMPILER_OPTIMIZATION_SIZE: y</span><br><span class="line">    # Advanced tweaking options</span><br><span class="line">    advanced:</span><br><span class="line">      ignore_efuse_mac_crc: false</span><br><span class="line"></span><br><span class="line"># Enable logging</span><br><span class="line">logger:</span><br><span class="line"></span><br><span class="line"># Enable Home Assistant API</span><br><span class="line">api:</span><br><span class="line"></span><br><span class="line">ota:</span><br><span class="line">  password: &quot;&quot;</span><br><span class="line"></span><br><span class="line">wifi:</span><br><span class="line">  ssid: !secret wifi_ssid</span><br><span class="line">  password: !secret wifi_password</span><br><span class="line"></span><br><span class="line">remote_receiver:</span><br><span class="line">  pin: </span><br><span class="line">    number: GPIO14</span><br><span class="line">    inverted: True</span><br><span class="line">  dump: raw</span><br><span class="line">  tolerance: </span><br><span class="line">    type: percentage</span><br><span class="line">    value: 70%</span><br><span class="line">  idle: 50ms</span><br><span class="line"></span><br><span class="line"> remote_transmitter:</span><br><span class="line">  pin: </span><br><span class="line">    number: GPIO27</span><br><span class="line">  carrier_duty_percent: 50%</span><br><span class="line"></span><br><span class="line"> switch:</span><br><span class="line">  - platform: template</span><br><span class="line">    name: &quot;BedRoom AC Switch&quot;</span><br><span class="line">    id: esp32_ac_swi</span><br><span class="line">    turn_on_action:</span><br><span class="line">      then:</span><br><span class="line">        - switch.template.publish:</span><br><span class="line">            id: esp32_ac_swi</span><br><span class="line">            state: ON</span><br><span class="line">        - remote_transmitter.transmit_raw:</span><br><span class="line">          	carrier_frequency: 38kHz</span><br><span class="line">          	code: [9048, <span class="string">-4448</span>, 653, <span class="string">-1665</span>, 623, <span class="string">-539</span>, 653, <span class="string">-537</span>, 650, <span class="string">-1668</span>, 625, <span class="string">-537</span>, 654, <span class="string">-537</span>, 650, <span class="string">-1640</span>, 650, <span class="string">-539</span>, 652, <span class="string">-1639</span>, 651, <span class="string">-1638</span>, 651, <span class="string">-539</span>, 652, <span class="string">-1638</span>, 653, <span class="string">-538</span>, 651, <span class="string">-539</span>, 650, <span class="string">-540</span>, 652, <span class="string">-538</span>, 650, <span class="string">-539</span>, 652, <span class="string">-539</span>, 651, <span class="string">-537</span>, 652, <span class="string">-538</span>, 652, <span class="string">-538</span>, 652, <span class="string">-1638</span>, 651, <span class="string">-540</span>, 652, <span class="string">-537</span>, 653, <span class="string">-538</span>, 650, <span class="string">-567</span>, 623, <span class="string">-539</span>, 651, <span class="string">-539</span>, 651, <span class="string">-1639</span>, 652, <span class="string">-566</span>, 623, <span class="string">-1639</span>, 652, <span class="string">-538</span>, 653, <span class="string">-537</span>, 652, <span class="string">-1638</span>, 652, <span class="string">-539</span>, 651, <span class="string">-19956</span>, 653, <span class="string">-1638</span>, 653, <span class="string">-539</span>, 652, <span class="string">-536</span>, 650, <span class="string">-541</span>, 650, <span class="string">-1666</span>, 627, <span class="string">-536</span>, 654, <span class="string">-536</span>, 650, <span class="string">-541</span>, 653, <span class="string">-537</span>, 650, <span class="string">-539</span>, 653, <span class="string">-565</span>, 625, <span class="string">-537</span>, 652, <span class="string">-538</span>, 652, <span class="string">-1638</span>, 652, <span class="string">-540</span>, 650, <span class="string">-541</span>, 649, <span class="string">-565</span>, 625, <span class="string">-566</span>, 624, <span class="string">-538</span>, 651, <span class="string">-539</span>, 651, <span class="string">-539</span>, 653, <span class="string">-537</span>, 652, <span class="string">-565</span>, 624, <span class="string">-539</span>, 652, <span class="string">-538</span>, 652, <span class="string">-539</span>, 649, <span class="string">-539</span>, 653, <span class="string">-564</span>, 625, <span class="string">-1639</span>, 652, <span class="string">-539</span>, 650, <span class="string">-539</span>, 652, <span class="string">-565</span>, 625, <span class="string">-7187</span>, 9047, <span class="string">-4453</span>, 653, <span class="string">-1640</span>, 649, <span class="string">-566</span>, 625, <span class="string">-540</span>, 651, <span class="string">-1637</span>, 652, <span class="string">-538</span>, 651, <span class="string">-539</span>, 651, <span class="string">-1638</span>, 653, <span class="string">-538</span>, 650, <span class="string">-1640</span>, 651, <span class="string">-1640</span>, 652, <span class="string">-537</span>, 652, <span class="string">-1637</span>, 653, <span class="string">-537</span>, 652, <span class="string">-541</span>, 649, <span class="string">-538</span>, 653, <span class="string">-538</span>, 652,  <span class="string">-540</span>, 649, <span class="string">-565</span>, 626, <span class="string">-539</span>, 651, <span class="string">-539</span>, 653, <span class="string">-537</span>, 652, <span class="string">-1637</span>, 652, <span class="string">-538</span>, 653, <span class="string">-537</span>, 652, <span class="string">-565</span>, 625, <span class="string">-564</span>, 627, <span class="string">-537</span>, 653, <span class="string">-537</span>, 652, <span class="string">-1664</span>, 627, <span class="string">-1636</span>, 653, <span class="string">-1637</span>, 654, <span class="string">-563</span>, 626, <span class="string">-538</span>, 653, <span class="string">-1637</span>, 653, <span class="string">-537</span>, 651, <span class="string">-19956</span>, 653, <span class="string">-539</span>, 654, <span class="string">-537</span>, 650,  <span class="string">-566</span>, 625, <span class="string">-538</span>, 652, <span class="string">-538</span>, 652, <span class="string">-538</span>, 654, <span class="string">-536</span>, 651, <span class="string">-539</span>, 652, <span class="string">-538</span>, 653, <span class="string">-564</span>, 624, <span class="string">-539</span>, 651, <span class="string">-539</span>, 651, <span class="string">-539</span>, 651, <span class="string">-538</span>, 651, <span class="string">-540</span>, 651, <span class="string">-538</span>, 653, <span class="string">-538</span>, 652, <span class="string">-537</span>, 652, <span class="string">-538</span>, 652, <span class="string">-565</span>, 624, <span class="string">-567</span>, 625, <span class="string">-538</span>, 653, <span class="string">-562</span>, 626, <span class="string">-538</span>, 652, <span class="string">-538</span>, 651,  <span class="string">-540</span>, 651, <span class="string">-538</span>, 654, <span class="string">-536</span>, 653, <span class="string">-537</span>, 651, <span class="string">-1665</span>, 627, <span class="string">-1637</span>, 652, <span class="string">-1638</span>, 652]</span><br><span class="line"></span><br><span class="line">    turn_off_action:</span><br><span class="line">      then:</span><br><span class="line">        - switch.template.publish:</span><br><span class="line">            id: esp32_ac_swi</span><br><span class="line">            state: OFF</span><br><span class="line">        - remote_transmitter.transmit_raw:</span><br><span class="line">          	carrier_frequency: 38kHz</span><br><span class="line">          	code: [9021, <span class="string">-4476</span>, 625, <span class="string">-1666</span>, 624, <span class="string">-565</span>, 624, <span class="string">-567</span>, 625, <span class="string">-567</span>, 621, <span class="string">-567</span>, 626, <span class="string">-566</span>, 622, <span class="string">-1666</span>, 624, <span class="string">-566</span>, 623, <span class="string">-1666</span>, 626, <span class="string">-1691</span>, 597, <span class="string">-566</span>, 626, <span class="string">-1664</span>, 625, <span class="string">-593</span>, 597, <span class="string">-566</span>, 624, <span class="string">-566</span>, 625, <span class="string">-565</span>, 624, <span class="string">-565</span>, 622, <span class="string">-569</span>, 624, <span class="string">-565</span>, 625, <span class="string">-565</span>, 625, <span class="string">-592</span>, 599, <span class="string">-564</span>, 624, <span class="string">-566</span>, 626, <span class="string">-564</span>, 626, <span class="string">-565</span>, 625, <span class="string">-566</span>, 623, <span class="string">-565</span>, 624, <span class="string">-566</span>, 624, <span class="string">-1666</span>, 625, <span class="string">-565</span>, 625, <span class="string">-1665</span>, 626, <span class="string">-564</span>, 623, <span class="string">-567</span>, 624, <span class="string">-1666</span>, 623, <span class="string">-567</span>, 626, <span class="string">-19983</span>, 625, <span class="string">-1665</span>, 624, <span class="string">-567</span>, 625, <span class="string">-564</span>, 624, <span class="string">-566</span>, 626, <span class="string">-1664</span>, 623, <span class="string">-593</span>, 599, <span class="string">-565</span>, 624, <span class="string">-566</span>, 624, <span class="string">-566</span>, 624, <span class="string">-594</span>, 598, <span class="string">-566</span>, 622, <span class="string">-567</span>, 624, <span class="string">-591</span>, 598, <span class="string">-1666</span>, 625, <span class="string">-565</span>, 623, <span class="string">-567</span>, 624, <span class="string">-569</span>, 622, <span class="string">-564</span>, 625, <span class="string">-568</span>, 621, <span class="string">-569</span>, 624, <span class="string">-564</span>, 623, <span class="string">-567</span>, 625, <span class="string">-564</span>, 624, <span class="string">-566</span>, 623, <span class="string">-568</span>, 624, <span class="string">-566</span>, 623, <span class="string">-566</span>, 626, <span class="string">-566</span>, 622, <span class="string">-1666</span>, 623, <span class="string">-568</span>, 623, <span class="string">-567</span>, 624, <span class="string">-1665</span>, 624, <span class="string">-7194</span>, 9041, <span class="string">-4481</span>, 626, <span class="string">-1665</span>, 624, <span class="string">-568</span>, 621, <span class="string">-566</span>, 622, <span class="string">-569</span>, 625, <span class="string">-567</span>, 622, <span class="string">-568</span>, 621, <span class="string">-1668</span>, 622, <span class="string">-566</span>, 624, <span class="string">-1666</span>, 625, <span class="string">-1666</span>, 623, <span class="string">-567</span>, 625, <span class="string">-1664</span>, 623, <span class="string">-594</span>, 598, <span class="string">-591</span>, 599, <span class="string">-566</span>, 621, <span class="string">-595</span>, 599, <span class="string">-565</span>, 625, <span class="string">-564</span>, 624, <span class="string">-566</span>, 625, <span class="string">-567</span>, 622, <span class="string">-569</span>, 622, <span class="string">-565</span>, 623, <span class="string">-569</span>, 623, <span class="string">-568</span>, 622, <span class="string">-567</span>, 622, <span class="string">-568</span>, 621, <span class="string">-567</span>, 624, <span class="string">-566</span>, 623, <span class="string">-1669</span>, 623, <span class="string">-1692</span>, 597, <span class="string">-1666</span>, 624, <span class="string">-565</span>, 625, <span class="string">-566</span>, 624, <span class="string">-1668</span>, 622, <span class="string">-565</span>, 623, <span class="string">-19985</span>, 627, <span class="string">-565</span>, 626, <span class="string">-564</span>, 626, <span class="string">-565</span>, 623, <span class="string">-566</span>, 625, <span class="string">-566</span>, 623, <span class="string">-593</span>, 595, <span class="string">-594</span>, 600, <span class="string">-565</span>, 622, <span class="string">-593</span>, 597, <span class="string">-567</span>, 624, <span class="string">-566</span>, 623, <span class="string">-567</span>, 624, <span class="string">-566</span>, 625, <span class="string">-565</span>, 625, <span class="string">-565</span>, 626, <span class="string">-564</span>, 623, <span class="string">-567</span>, 623, <span class="string">-567</span>, 623, <span class="string">-569</span>, 622, <span class="string">-566</span>, 622, <span class="string">-568</span>, 622, <span class="string">-569</span>, 623, <span class="string">-566</span>, 623, <span class="string">-567</span>, 623, <span class="string">-566</span>, 624, <span class="string">-567</span>, 623, <span class="string">-566</span>, 624, <span class="string">-568</span>, 623, <span class="string">-566</span>, 622, <span class="string">-1667</span>, 625, <span class="string">-1665</span>, 623, <span class="string">-594</span>, 596]</span><br></pre></td></tr></table></figure>
<p>我创建了一个switch实体，这样在Home Assistant面板上就可以直接添加空调的开关。<br>这里注意一个细节<code>carrier_frequency: 38kHz</code>必须要有，貌似是红外的载波频率，如果没有也不能正常遥控。<br>现在编译上传固件，然后在你的HA面板中添加<code>BedRoom AC Switch</code>，然后尝试一下控制空调。</p>
<h1 id="后续改进"><a href="#后续改进" class="headerlink" title="后续改进"></a>后续改进</h1><p>录制开机制热和开机制冷两种红外代码，并且优化代码结构，并且根据外部气温，判断打开空调的时候让它制热还是制冷。</p>
<figure class="highlight subunit"><table><tr><td class="code"><pre><span class="line">esphome:</span><br><span class="line">  name: esp32</span><br><span class="line"></span><br><span class="line">esp32:</span><br><span class="line">  board: esp32dev</span><br><span class="line">  framework:</span><br><span class="line">    type: esp-idf</span><br><span class="line">    version: latest</span><br><span class="line">    # Custom sdkconfig options</span><br><span class="line">    sdkconfig_options:</span><br><span class="line">      CONFIG_COMPILER_OPTIMIZATION_SIZE: y</span><br><span class="line">    # Advanced tweaking options</span><br><span class="line">    advanced:</span><br><span class="line">      ignore_efuse_mac_crc: false</span><br><span class="line"></span><br><span class="line"># Enable logging</span><br><span class="line">logger:</span><br><span class="line"></span><br><span class="line"># Enable Home Assistant API</span><br><span class="line">api:</span><br><span class="line"></span><br><span class="line">ota:</span><br><span class="line">  password: &quot;&quot;</span><br><span class="line"></span><br><span class="line">wifi:</span><br><span class="line">  ssid: !secret wifi_ssid</span><br><span class="line">  password: !secret wifi_password</span><br><span class="line"></span><br><span class="line">remote_receiver:</span><br><span class="line">  pin: </span><br><span class="line">    number: GPIO14</span><br><span class="line">    inverted: True</span><br><span class="line">  dump: raw</span><br><span class="line">  tolerance: </span><br><span class="line">    type: percentage</span><br><span class="line">    value: 70%</span><br><span class="line">  idle: 50ms</span><br><span class="line"></span><br><span class="line"> remote_transmitter:</span><br><span class="line">  pin: </span><br><span class="line">    number: GPIO27</span><br><span class="line">  carrier_duty_percent: 50%</span><br><span class="line"></span><br><span class="line">sensor:</span><br><span class="line">  - platform: homeassistant</span><br><span class="line">    entity_id: weather.wo_de_jia</span><br><span class="line">    id: temperature</span><br><span class="line">    attribute: temperature</span><br><span class="line"></span><br><span class="line"> switch:</span><br><span class="line">  - platform: template</span><br><span class="line">    name: &quot;BedRoom AC Switch&quot;</span><br><span class="line">    id: esp32_ac_swi</span><br><span class="line">    turn_on_action:</span><br><span class="line">      then:</span><br><span class="line">        - switch.template.publish:</span><br><span class="line">            id: esp32_ac_swi</span><br><span class="line">            state: ON</span><br><span class="line">        - if:</span><br><span class="line">            condition:</span><br><span class="line">              lambda: &#x27;return id(temperature).state &lt; 20;&#x27;</span><br><span class="line">            then:</span><br><span class="line">              - script.execute: turn_ac_20c</span><br><span class="line">            else:</span><br><span class="line">              - script.execute: turn_ac_27c</span><br><span class="line"></span><br><span class="line">    turn_off_action:</span><br><span class="line">      then:</span><br><span class="line">        - switch.template.publish:</span><br><span class="line">            id: esp32_ac_swi</span><br><span class="line">            state: OFF</span><br><span class="line">        - script.execute: turn_ac_off</span><br><span class="line"></span><br><span class="line">script:</span><br><span class="line">  - id: turn_ac_20c</span><br><span class="line">    then:</span><br><span class="line">      - remote_transmitter.transmit_raw:</span><br><span class="line">          carrier_frequency: 38kHz</span><br><span class="line">          code: [9016, <span class="string">-4481</span>, 620, <span class="string">-570</span>, 620, <span class="string">-570</span>, 619, <span class="string">-1670</span>, 620, <span class="string">-1671</span>, 620, <span class="string">-570</span>, 621, <span class="string">-569</span>, 621, <span class="string">-1668</span>, 619, <span class="string">-572</span>, 620, <span class="string">-569</span>, 620, <span class="string">-570</span>, 621, <span class="string">-1669</span>, 621, <span class="string">-570</span>, 621, <span class="string">-568</span>, 620, <span class="string">-570</span>, 621, <span class="string">-569</span>, 621, <span class="string">-569</span>, 622, <span class="string">-568</span>, 619, <span class="string">-572</span>, 619, <span class="string">-570</span>, 621, <span class="string">-569</span>, 619, <span class="string">-572</span>, 619, <span class="string">-1671</span>, 618, <span class="string">-571</span>, 620, <span class="string">-1670</span>, 620, <span class="string">-571</span>, 619, <span class="string">-571</span>, 618, <span class="string">-571</span>, 619, <span class="string">-570</span>, 621, <span class="string">-1670</span>, 620, <span class="string">-570</span>, 646, <span class="string">-1643</span>, 621, <span class="string">-569</span>, 621, <span class="string">-569</span>, 621, <span class="string">-1669</span>, 620, <span class="string">-571</span>, 619, <span class="string">-19990</span>, 620, <span class="string">-1670</span>, 620, <span class="string">-571</span>, 620, <span class="string">-568</span>, 622, <span class="string">-569</span>, 621, <span class="string">-1669</span>, 621, <span class="string">-569</span>, 617, <span class="string">-573</span>, 617, <span class="string">-573</span>, 620, <span class="string">-570</span>, 645, <span class="string">-545</span>, 621, <span class="string">-569</span>, 620, <span class="string">-570</span>, 619, <span class="string">-570</span>, 621, <span class="string">-1669</span>, 618, <span class="string">-572</span>, 645, <span class="string">-546</span>, 619, <span class="string">-571</span>, 645, <span class="string">-544</span>, 620, <span class="string">-571</span>, 617, <span class="string">-573</span>, 643, <span class="string">-547</span>, 620, <span class="string">-569</span>, 620, <span class="string">-571</span>, 617, <span class="string">-572</span>, 644, <span class="string">-546</span>, 618, <span class="string">-572</span>, 612, <span class="string">-578</span>, 621, <span class="string">-569</span>, 619, <span class="string">-1671</span>, 617, <span class="string">-573</span>, 620, <span class="string">-1670</span>, 644, <span class="string">-1646</span>, 619, <span class="string">-7223</span>, 9010, <span class="string">-4489</span>, 617, <span class="string">-573</span>, 615, <span class="string">-575</span>, 643, <span class="string">-1647</span>, 620, <span class="string">-1670</span>, 643, <span class="string">-546</span>, 619, <span class="string">-572</span>, 616, <span class="string">-1674</span>, 617, <span class="string">-573</span>, 644, <span class="string">-545</span>, 618, <span class="string">-573</span>, 617, <span class="string">-1673</span>, 615, <span class="string">-574</span>, 642, <span class="string">-549</span>, 617, <span class="string">-572</span>, 618, <span class="string">-572</span>, 617, <span class="string">-573</span>, 643, <span class="string">-547</span>, 644, <span class="string">-546</span>, 614, <span class="string">-576</span>, 643, <span class="string">-547</span>, 593, <span class="string">-598</span>, 643, <span class="string">-1646</span>, 643, <span class="string">-547</span>, 616, <span class="string">-1674</span>, 639, <span class="string">-551</span>, 610, <span class="string">-580</span>, 616, <span class="string">-574</span>, 641, <span class="string">-549</span>, 617, <span class="string">-1673</span>, 592, <span class="string">-1699</span>, 617, <span class="string">-1672</span>, 639, <span class="string">-551</span>, 642, <span class="string">-547</span>, 593, <span class="string">-1698</span>, 592, <span class="string">-598</span>, 640, <span class="string">-19969</span>, 637, <span class="string">-553</span>, 593, <span class="string">-597</span>, 642, <span class="string">-548</span>, 642, <span class="string">-548</span>, 640, <span class="string">-550</span>, 592, <span class="string">-598</span>, 592, <span class="string">-598</span>, 593, <span class="string">-597</span>, 592, <span class="string">-597</span>, 642, <span class="string">-549</span>, 593, <span class="string">-597</span>, 594, <span class="string">-596</span>, 593, <span class="string">-597</span>, 592, <span class="string">-598</span>, 640, <span class="string">-550</span>, 593, <span class="string">-597</span>, 593, <span class="string">-597</span>, 593, <span class="string">-597</span>, 592, <span class="string">-597</span>, 593, <span class="string">-598</span>, 641, <span class="string">-548</span>, 640, <span class="string">-551</span>, 592, <span class="string">-597</span>, 642, <span class="string">-549</span>, 593, <span class="string">-597</span>, 593, <span class="string">-596</span>, 594, <span class="string">-597</span>, 593, <span class="string">-596</span>, 594, <span class="string">-596</span>, 593, <span class="string">-1697</span>, 594, <span class="string">-596</span>, 594, <span class="string">-1696</span>, 594]</span><br><span class="line">  - id: turn_ac_off</span><br><span class="line">    then:</span><br><span class="line">      - remote_transmitter.transmit_raw:</span><br><span class="line">          carrier_frequency: 38kHz</span><br><span class="line">          code: [9021, <span class="string">-4476</span>, 625, <span class="string">-1666</span>, 624, <span class="string">-565</span>, 624, <span class="string">-567</span>, 625, <span class="string">-567</span>, 621, <span class="string">-567</span>, 626, <span class="string">-566</span>, 622, <span class="string">-1666</span>, 624, <span class="string">-566</span>, 623, <span class="string">-1666</span>, 626, <span class="string">-1691</span>, 597, <span class="string">-566</span>, 626, <span class="string">-1664</span>, 625, <span class="string">-593</span>, 597, <span class="string">-566</span>, 624, <span class="string">-566</span>, 625, <span class="string">-565</span>, 624, <span class="string">-565</span>, 622, <span class="string">-569</span>, 624, <span class="string">-565</span>, 625, <span class="string">-565</span>, 625, <span class="string">-592</span>, 599, <span class="string">-564</span>, 624, <span class="string">-566</span>, 626, <span class="string">-564</span>, 626, <span class="string">-565</span>, 625, <span class="string">-566</span>, 623, <span class="string">-565</span>, 624, <span class="string">-566</span>, 624, <span class="string">-1666</span>, 625, <span class="string">-565</span>, 625, <span class="string">-1665</span>, 626, <span class="string">-564</span>, 623, <span class="string">-567</span>, 624, <span class="string">-1666</span>, 623, <span class="string">-567</span>, 626, <span class="string">-19983</span>, 625, <span class="string">-1665</span>, 624, <span class="string">-567</span>, 625, <span class="string">-564</span>, 624, <span class="string">-566</span>, 626, <span class="string">-1664</span>, 623, <span class="string">-593</span>, 599, <span class="string">-565</span>, 624, <span class="string">-566</span>, 624, <span class="string">-566</span>, 624, <span class="string">-594</span>, 598, <span class="string">-566</span>, 622, <span class="string">-567</span>, 624, <span class="string">-591</span>, 598, <span class="string">-1666</span>, 625, <span class="string">-565</span>, 623, <span class="string">-567</span>, 624, <span class="string">-569</span>, 622, <span class="string">-564</span>, 625, <span class="string">-568</span>, 621, <span class="string">-569</span>, 624, <span class="string">-564</span>, 623, <span class="string">-567</span>, 625, <span class="string">-564</span>, 624, <span class="string">-566</span>, 623, <span class="string">-568</span>, 624, <span class="string">-566</span>, 623, <span class="string">-566</span>, 626, <span class="string">-566</span>, 622, <span class="string">-1666</span>, 623, <span class="string">-568</span>, 623, <span class="string">-567</span>, 624, <span class="string">-1665</span>, 624, <span class="string">-7194</span>, 9041, <span class="string">-4481</span>, 626, <span class="string">-1665</span>, 624, <span class="string">-568</span>, 621, <span class="string">-566</span>, 622, <span class="string">-569</span>, 625, <span class="string">-567</span>, 622, <span class="string">-568</span>, 621, <span class="string">-1668</span>, 622, <span class="string">-566</span>, 624, <span class="string">-1666</span>, 625, <span class="string">-1666</span>, 623, <span class="string">-567</span>, 625, <span class="string">-1664</span>, 623, <span class="string">-594</span>, 598, <span class="string">-591</span>, 599, <span class="string">-566</span>, 621, <span class="string">-595</span>, 599, <span class="string">-565</span>, 625, <span class="string">-564</span>, 624, <span class="string">-566</span>, 625, <span class="string">-567</span>, 622, <span class="string">-569</span>, 622, <span class="string">-565</span>, 623, <span class="string">-569</span>, 623, <span class="string">-568</span>, 622, <span class="string">-567</span>, 622, <span class="string">-568</span>, 621, <span class="string">-567</span>, 624, <span class="string">-566</span>, 623, <span class="string">-1669</span>, 623, <span class="string">-1692</span>, 597, <span class="string">-1666</span>, 624, <span class="string">-565</span>, 625, <span class="string">-566</span>, 624, <span class="string">-1668</span>, 622, <span class="string">-565</span>, 623, <span class="string">-19985</span>, 627, <span class="string">-565</span>, 626, <span class="string">-564</span>, 626, <span class="string">-565</span>, 623, <span class="string">-566</span>, 625, <span class="string">-566</span>, 623, <span class="string">-593</span>, 595, <span class="string">-594</span>, 600, <span class="string">-565</span>, 622, <span class="string">-593</span>, 597, <span class="string">-567</span>, 624, <span class="string">-566</span>, 623, <span class="string">-567</span>, 624, <span class="string">-566</span>, 625, <span class="string">-565</span>, 625, <span class="string">-565</span>, 626, <span class="string">-564</span>, 623, <span class="string">-567</span>, 623, <span class="string">-567</span>, 623, <span class="string">-569</span>, 622, <span class="string">-566</span>, 622, <span class="string">-568</span>, 622, <span class="string">-569</span>, 623, <span class="string">-566</span>, 623, <span class="string">-567</span>, 623, <span class="string">-566</span>, 624, <span class="string">-567</span>, 623, <span class="string">-566</span>, 624, <span class="string">-568</span>, 623, <span class="string">-566</span>, 622, <span class="string">-1667</span>, 625, <span class="string">-1665</span>, 623, <span class="string">-594</span>, 596]</span><br><span class="line">  - id: turn_ac_27c</span><br><span class="line">    then:</span><br><span class="line">      - remote_transmitter.transmit_raw:</span><br><span class="line">          carrier_frequency: 38kHz</span><br><span class="line">          code: [9048, <span class="string">-4448</span>, 653, <span class="string">-1665</span>, 623, <span class="string">-539</span>, 653, <span class="string">-537</span>, 650, <span class="string">-1668</span>, 625, <span class="string">-537</span>, 654, <span class="string">-537</span>, 650, <span class="string">-1640</span>, 650, <span class="string">-539</span>, 652, <span class="string">-1639</span>, 651, <span class="string">-1638</span>, 651, <span class="string">-539</span>, 652, <span class="string">-1638</span>, 653, <span class="string">-538</span>, 651, <span class="string">-539</span>, 650, <span class="string">-540</span>, 652, <span class="string">-538</span>, 650, <span class="string">-539</span>, 652, <span class="string">-539</span>, 651, <span class="string">-537</span>, 652, <span class="string">-538</span>, 652, <span class="string">-538</span>, 652, <span class="string">-1638</span>, 651, <span class="string">-540</span>, 652, <span class="string">-537</span>, 653, <span class="string">-538</span>, 650, <span class="string">-567</span>, 623, <span class="string">-539</span>, 651, <span class="string">-539</span>, 651, <span class="string">-1639</span>, 652, <span class="string">-566</span>, 623, <span class="string">-1639</span>, 652, <span class="string">-538</span>, 653, <span class="string">-537</span>, 652, <span class="string">-1638</span>, 652, <span class="string">-539</span>, 651, <span class="string">-19956</span>, 653, <span class="string">-1638</span>, 653, <span class="string">-539</span>, 652, <span class="string">-536</span>, 650, <span class="string">-541</span>, 650, <span class="string">-1666</span>, 627, <span class="string">-536</span>, 654, <span class="string">-536</span>, 650, <span class="string">-541</span>, 653, <span class="string">-537</span>, 650, <span class="string">-539</span>, 653, <span class="string">-565</span>, 625, <span class="string">-537</span>, 652, <span class="string">-538</span>, 652, <span class="string">-1638</span>, 652, <span class="string">-540</span>, 650, <span class="string">-541</span>, 649, <span class="string">-565</span>, 625, <span class="string">-566</span>, 624, <span class="string">-538</span>, 651, <span class="string">-539</span>, 651, <span class="string">-539</span>, 653, <span class="string">-537</span>, 652, <span class="string">-565</span>, 624, <span class="string">-539</span>, 652, <span class="string">-538</span>, 652, <span class="string">-539</span>, 649, <span class="string">-539</span>, 653, <span class="string">-564</span>, 625, <span class="string">-1639</span>, 652, <span class="string">-539</span>, 650, <span class="string">-539</span>, 652, <span class="string">-565</span>, 625, <span class="string">-7187</span>, 9047, <span class="string">-4453</span>, 653, <span class="string">-1640</span>, 649, <span class="string">-566</span>, 625, <span class="string">-540</span>, 651, <span class="string">-1637</span>, 652, <span class="string">-538</span>, 651, <span class="string">-539</span>, 651, <span class="string">-1638</span>, 653, <span class="string">-538</span>, 650, <span class="string">-1640</span>, 651, <span class="string">-1640</span>, 652, <span class="string">-537</span>, 652, <span class="string">-1637</span>, 653, <span class="string">-537</span>, 652, <span class="string">-541</span>, 649, <span class="string">-538</span>, 653, <span class="string">-538</span>, 652,  <span class="string">-540</span>, 649, <span class="string">-565</span>, 626, <span class="string">-539</span>, 651, <span class="string">-539</span>, 653, <span class="string">-537</span>, 652, <span class="string">-1637</span>, 652, <span class="string">-538</span>, 653, <span class="string">-537</span>, 652, <span class="string">-565</span>, 625, <span class="string">-564</span>, 627, <span class="string">-537</span>, 653, <span class="string">-537</span>, 652, <span class="string">-1664</span>, 627, <span class="string">-1636</span>, 653, <span class="string">-1637</span>, 654, <span class="string">-563</span>, 626, <span class="string">-538</span>, 653, <span class="string">-1637</span>, 653, <span class="string">-537</span>, 651, <span class="string">-19956</span>, 653, <span class="string">-539</span>, 654, <span class="string">-537</span>, 650,  <span class="string">-566</span>, 625, <span class="string">-538</span>, 652, <span class="string">-538</span>, 652, <span class="string">-538</span>, 654, <span class="string">-536</span>, 651, <span class="string">-539</span>, 652, <span class="string">-538</span>, 653, <span class="string">-564</span>, 624, <span class="string">-539</span>, 651, <span class="string">-539</span>, 651, <span class="string">-539</span>, 651, <span class="string">-538</span>, 651, <span class="string">-540</span>, 651, <span class="string">-538</span>, 653, <span class="string">-538</span>, 652, <span class="string">-537</span>, 652, <span class="string">-538</span>, 652, <span class="string">-565</span>, 624, <span class="string">-567</span>, 625, <span class="string">-538</span>, 653, <span class="string">-562</span>, 626, <span class="string">-538</span>, 652, <span class="string">-538</span>, 651,  <span class="string">-540</span>, 651, <span class="string">-538</span>, 654, <span class="string">-536</span>, 653, <span class="string">-537</span>, 651, <span class="string">-1665</span>, 627, <span class="string">-1637</span>, 652, <span class="string">-1638</span>, 652]</span><br><span class="line">  - id: turn_ac_28c</span><br><span class="line">    then:</span><br><span class="line">      - remote_transmitter.transmit_raw:</span><br><span class="line">          carrier_frequency: 38kHz</span><br><span class="line">          code: [9081, <span class="string">-4466</span>, 657, <span class="string">-1630</span>, 656, <span class="string">-553</span>, 629, <span class="string">-558</span>, 652, <span class="string">-1634</span>, 654, <span class="string">-1634</span>, 594, <span class="string">-588</span>, 597, <span class="string">-613</span>, 596, <span class="string">-588</span>, 595, <span class="string">-587</span>, 626, <span class="string">-589</span>, 590, <span class="string">-1695</span>, 595, <span class="string">-1696</span>, 591, <span class="string">-643</span>, 566, <span class="string">-617</span>, 566, <span class="string">-616</span>, 568, <span class="string">-642</span>, 568, <span class="string">-615</span>, 569, <span class="string">-615</span>, 568, <span class="string">-616</span>, 593, <span class="string">-591</span>, 593, <span class="string">-591</span>, 592, <span class="string">-617</span>, 594, <span class="string">-592</span>, 591, <span class="string">-591</span>, 591, <span class="string">-618</span>, 593, <span class="string">-614</span>, 568, <span class="string">-617</span>, 567, <span class="string">-615</span>, 596, <span class="string">-1693</span>, 594, <span class="string">-623</span>, 559, <span class="string">-1696</span>, 594, <span class="string">-645</span>, 564, <span class="string">-617</span>, 567, <span class="string">-1694</span>, 593, <span class="string">-646</span>, 561, <span class="string">-20029</span>, 613, <span class="string">-653</span>, 559, <span class="string">-1695</span>, 593, <span class="string">-625</span>, 558, <span class="string">-621</span>, 565, <span class="string">-641</span>, 567, <span class="string">-617</span>, 565, <span class="string">-618</span>, 568, <span class="string">-618</span>, 591, <span class="string">-615</span>, 569, <span class="string">-591</span>, 591, <span class="string">-617</span>, 594, <span class="string">-614</span>, 643, <span class="string">-544</span>, 565, <span class="string">-617</span>, 596, <span class="string">-1695</span>, 590, <span class="string">-620</span>, 563, <span class="string">-643</span>, 567, <span class="string">-616</span>, 566, <span class="string">-618</span>, 567, <span class="string">-618</span>, 593, <span class="string">-590</span>, 593, <span class="string">-614</span>, 567, <span class="string">-618</span>, 594, <span class="string">-592</span>, 591, <span class="string">-591</span>, 591, <span class="string">-620</span>, 659, <span class="string">-550</span>, 566, <span class="string">-590</span>, 594, <span class="string">-1720</span>, 595, <span class="string">-1692</span>, 594, <span class="string">-620</span>, 563, <span class="string">-618</span>, 591, <span class="string">-7252</span>, 9095, <span class="string">-4467</span>, 661, <span class="string">-1628</span>, 658, <span class="string">-527</span>, 654, <span class="string">-580</span>, 627, <span class="string">-1637</span>, 653, <span class="string">-1635</span>, 593, <span class="string">-616</span>, 568, <span class="string">-618</span>, 591, <span class="string">-591</span>, 592, <span class="string">-592</span>, 591, <span class="string">-617</span>, 595, <span class="string">-1694</span>, 593, <span class="string">-1695</span>, 592, <span class="string">-645</span>, 565, <span class="string">-617</span>, 566, <span class="string">-594</span>, 590, <span class="string">-617</span>, 592, <span class="string">-618</span>, 567, <span class="string">-615</span>, 569, <span class="string">-640</span>, 567, <span class="string">-594</span>, 591, <span class="string">-590</span>, 595, <span class="string">-614</span>, 596, <span class="string">-587</span>, 596, <span class="string">-614</span>, 568, <span class="string">-616</span>, 596, <span class="string">-614</span>, 566, <span class="string">-593</span>, 591, <span class="string">-617</span>, 594, <span class="string">-1694</span>, 593, <span class="string">-1696</span>, 594, <span class="string">-1693</span>, 592, <span class="string">-649</span>, 565, <span class="string">-618</span>, 565, <span class="string">-1713</span>, 572, <span class="string">-648</span>, 564, <span class="string">-20051</span>, 592, <span class="string">-555</span>, 630, <span class="string">-648</span>, 563, <span class="string">-619</span>, 562, <span class="string">-621</span>, 565, <span class="string">-642</span>, 568, <span class="string">-617</span>, 566, <span class="string">-617</span>, 564, <span class="string">-1724</span>, 592, <span class="string">-620</span>, 565, <span class="string">-616</span>, 565, <span class="string">-645</span>, 566, <span class="string">-618</span>, 566, <span class="string">-615</span>, 566, <span class="string">-618</span>, 594, <span class="string">-617</span>, 564, <span class="string">-593</span>, 594, <span class="string">-615</span>, 596, <span class="string">-613</span>, 567, <span class="string">-592</span>, 595, <span class="string">-614</span>, 593, <span class="string">-1694</span>, 595, <span class="string">-618</span>, 565, <span class="string">-641</span>, 569, <span class="string">-1694</span>, 592, <span class="string">-621</span>, 565, <span class="string">-616</span>, 564, <span class="string">-645</span>, 567, <span class="string">-617</span>, 567, <span class="string">-618</span>, 567, <span class="string">-616</span>, 594, <span class="string">-614</span>, 567, <span class="string">-591</span>, 593]</span><br></pre></td></tr></table></figure>
<p>户外温度是从Home Assistant的天气中读取的，其中<code>entity_id: weather.wo_de_jia</code>是HA中的实体，你可以在HA面板中的“开发者工具”中查看“现有实体”。</p>
]]></content>
      <tags>
        <tag>HomeAssistant</tag>
        <tag>ESP芯片</tag>
      </tags>
  </entry>
  <entry>
    <title>中兴B760HV2电视盒子完美刷机</title>
    <url>/2020/03/25/B760HV2/</url>
    <content><![CDATA[<p>丈母娘想看电视，我就寻思着现在有线电视不划来，网络都这么发达了，找点直播源也很简单。但是给长辈用最重要的还是简单易用最重要。<br>先说成果，通电后自动播放直播电视，整个过程大概25秒。<br><img src="B760HV2_show.webp" alt="B760HV2_show"><br>通过利用手头安徽移动送的这个中兴B760HV2智能机顶盒，安装AlexELEC系统来实现播放电视直播源，记录一下这个曲折的过程。<br><img src="B760HV2_1.jpg" alt="B760HV2_1"><br><img src="B760HV2_2.jpg" alt="B760HV2_2"></p>
<span id="more"></span>
<p>丈母娘家有一个移动办宽带送的电视盒子——中兴 ZXV10 B760HV2智能机顶盒（WiFi版），我想大多数电视盒子都是晶晨的主控，刷机应该不难。但是翻遍了全网，没找到这个机子的刷机教程，只找到了救砖线刷包，也算是给我吃了一颗定心丸，不怕死了，综合其他机子的刷机教程就是干。<br>首先要确定硬件配置，找到硬件相似的机型的刷机教程或者刷机包。拆开机子一看，Realtek RTL8818ETV + 1G RAM 的组合不出我意料，但4G NAND + Amlogic S805的Soc就让我有些傻眼了，这配置简直丐中丐。CoreELEC已经放弃了S80x系列的Soc了。本来CoreELEC刷机包都下载好了，现在要重新查资料了。最终找到了支持S805的Kodi系统<a target="_blank" rel="noopener" href="https://github.com/AlexELEC/AE-AML/releases">AlexELEC</a>，看样子应该是LibreELEC和CoreELEC的魔改版，但是支持S805，Kodi版本同步到目前最新的18.6，也找到了相似的机型<a target="_blank" rel="noopener" href="https://www.rigacci.org/wiki/doku.php/doc/appunti/hardware/mxq_s805">MXQ (FW V2.0)</a> (代号m201c)，NAND闪存差了4G，不过FLASH大小应该和内核没关系，启动后可以自己识别。</p>
<h1 id="进入Update模式（从TF卡启动）"><a href="#进入Update模式（从TF卡启动）" class="headerlink" title="进入Update模式（从TF卡启动）"></a>进入Update模式（从TF卡启动）</h1><p>按照帖子中的操作，将AlexELEC烧入TF卡（用<a target="_blank" rel="noopener" href="https://sourceforge.net/projects/win32diskimager/files/Archive/">Win32DiskImager</a>把img烧入TF卡），然后插入机器，上电。。。按照MXQ的刷机教程，此时已经可以从TF卡启动了，然而实际情况还是进入百视通自己的系统(从NAND启动的)。看来这个机子在软件上还是做了一些防刷机的屏蔽。仔细查看机子的裸板，没有复位键，没有短接点位，没有额外的SPI Flash做NAND里面系统的引导，网上说的那些捅菊花、短接进入升级模式方法都不好使了。不过发现了6根排针，不知道能不能找到TXD和RXD，通过串口控制台进入升级模式。<br>万用表测出GND，固定波特率115200,用USB TTL的RXD挨个碰其他针脚观察控制台的输出，注意只有启动前几秒才能观察到，启动完成之后串口不再向外输出。所以测试每根针脚时都要重新上电。最终测试出TXD和RXD，还好这个板子留出了TTL针脚，给我留了一条活路。<br><img src="B760HV2_TTL.jpg" alt="B760HV2_TTL"><br>登陆控制台之后发现这个机子的用户名也是m201,看来m201可能是Amlogic的公版代号。B760HV2的遥控器看起来跟MXQ的遥控器还是不一样，刷机之前首先保存遥控器的配置文件<code>remote.conf</code>（后面附具体内容），不然刷完机后，遥控器的按键编码我还要重新录制，重新设定按键响应。然后尝试重启进入刷机模式，在串口中输入</p>
<figure class="highlight ebnf"><table><tr><td class="code"><pre><span class="line"><span class="attribute">reboot update</span></span><br></pre></td></tr></table></figure>
<p>结果失败了，依然直接进入自带的系统，貌似在Uboot中禁用了update模式。我彻底怒了，串口定时每0.1秒发送enter，中断Uboot启动。修改Uboot的环境变量，将重启模式改为升级模式</p>
<figure class="highlight apache"><table><tr><td class="code"><pre><span class="line"><span class="attribute">setenv</span> reboot_mode update</span><br></pre></td></tr></table></figure>
<p>断电重启，这一次不用中断Uboot，等他自然进入系统，然后输入</p>
<figure class="highlight ebnf"><table><tr><td class="code"><pre><span class="line"><span class="attribute">reboot update</span></span><br></pre></td></tr></table></figure>
<p>串口输出变了，这一次终于可以从TF卡启动进入AlexELEC了，赶紧插上网线，然后尝试SSH登陆。。。哎呀，root密码不知道啊。接上键盘、显示器在AlexELEC设置中直接更改SSH的密码。（因为AlexELEC是毛子做的系统，默认语言是俄文，需要先改字体为Arial，再改语言为Chinese，别问我怎么看懂的，Kodi我玩的熟了，闭着眼都能改语言）</p>
<h1 id="安装AlexELEC系统到内置NAND"><a href="#安装AlexELEC系统到内置NAND" class="headerlink" title="安装AlexELEC系统到内置NAND"></a>安装AlexELEC系统到内置NAND</h1><p>简单测试一下，wifi正常，RAM、ROM容量识别正常，HDMI输出正常，声音正常，红外遥控器的大部分按键正常（数字键和方向键正常，但是也有些按键，比如确认键和音量键的映射不正常）。遥控器的问题不大，可以慢慢调整配置文件。总之，系统完全工作正常，把TF卡中的系统安装到NAND闪存中，SSH控制台中输入</p>
<figure class="highlight ebnf"><table><tr><td class="code"><pre><span class="line"><span class="attribute">installtointernal</span></span><br></pre></td></tr></table></figure>
<p>一路输入yes，完成安装。安装完成之后，关机</p>
<figure class="highlight ebnf"><table><tr><td class="code"><pre><span class="line"><span class="attribute">poweroff</span></span><br></pre></td></tr></table></figure>
<p>拔出TF卡，断电后再重新上电，成功进入AlexELEC，到此为止成功安装AlexELEC系统到内置NAND。</p>
<h1 id="Kodi中配置PVR直播电视"><a href="#Kodi中配置PVR直播电视" class="headerlink" title="Kodi中配置PVR直播电视"></a>Kodi中配置PVR直播电视</h1><p>启用IPTV Simple PVR Client插件（默认禁用）并配置IPTV Simple PVR Client。</p>
<ul>
<li>找到了一个<del>可靠的</del>有点慢的<a target="_blank" rel="noopener" href="https://github.com/BurningC4/Chinese-IPTV">直播源</a>(包含CCTV+地方卫视)，（更新：<a target="_blank" rel="noopener" href="https://raw.githubusercontent.com/wuxiaoxiong1990/IPTVsource/master/ipv4.m3u">可靠的直播源</a>），可以直接填入IPTV Simple PVR Client的设置。</li>
<li>更改IPTV Simple PVR Client的设置，每次切换频道无需按确认键，还原老式电视的操作方式</li>
<li>Kodi的用户设置中，启动时自动打开PVR，再也不要担心妈妈不会调</li>
</ul>
<h1 id="调教红外遥控器"><a href="#调教红外遥控器" class="headerlink" title="调教红外遥控器"></a>调教红外遥控器</h1><p>真的是走了很多弯路，之前用过树莓派的红外线，以为是差不多的，犯了思维定势的错误。新版的LibreELEC已经支持amremote从系统底层接管红外了，AlexELEC当然也跟上了。忘记lirc和meson-ir吧，记录红外按键也不是用ir-keytable了，因为根本没有/dev/lirc0这个设备了,取而代之的是<code>/dev/amremote</code>。<br>amremote一听名字就知道是Amlogic平台的遥控器驱动，它的作用是将红外编码直接映射为键盘上的按键，所以不需要在Kodi中额外配置红外遥控器，更不需要通过keymap editor来重新设置键盘映射！amremote的工作流程是将遥控器的的红外编码(ircode)对应成key code，再触发key code代表的键盘按键。ircode与key code的对应关系在配置文件<code>/storage/.config/amremote/remote.conf</code>中(也就是我们之前在原厂固件中保存的那个)，key code与键盘按键的对应关系在<code>/storage/.config/amremote/Config_key.sample</code>中(这个只是说明文件，不可更改，对应关系已经编译进驱动了)。下面记录一下如何完成一个遥控器的适配，或者说自定义。<br>首先停止kodi，不然kodi会产生许多我们不需要的内核调试信息，干扰我们调试</p>
<figure class="highlight arduino"><table><tr><td class="code"><pre><span class="line">systemctl stop kodi</span><br></pre></td></tr></table></figure>
<p>在测试遥控器按键前，丢弃我们不想要的之前的内核日志</p>
<figure class="highlight ebnf"><table><tr><td class="code"><pre><span class="line"><span class="attribute">dmesg -c</span></span><br></pre></td></tr></table></figure>
<p>下面可以冲着盒子按下你想要更改的遥控器的按键，按一个按键一次，尽量手速加快，按一下就松手(不然就和我下面的图里一样，接收到多个红外编码)，接着你就可以在内核日志中看到红外编码ircode</p>
<figure class="highlight ebnf"><table><tr><td class="code"><pre><span class="line"><span class="attribute">dmesg -c</span></span><br></pre></td></tr></table></figure>
<p>比如我按下遥控器上红色的按钮，输出了以下内核日志<br><img src="B760HV2_ircode.png" alt="B760HV2_ircode"><br>图中的0x0e就是ircode<br>下面就在<code>remote.conf</code>寻找ircode对应的key code，有两种情况，一种是配置文件里面已经有这个按键的ircode了，你需要更改后面的key code;另一种是没有对应的ircode，你需要自己添加。然后key code是你要去<code>Config_key.sample</code>查找你想要的按键。<br>以上面的例子ircode=0x0e为例，在<code>remote.conf</code>中寻找这个ircode<br><img src="B760HV2_keycode.png" alt="B760HV2_keycode"><br>可以看到在我这个配置文件中红外编码（ircode）0xe被映射成了key code为0x18e的按键，那么这个按键到底是什么呢？我们可以进<code>Config_key.sample</code>查找<br><img src="B760HV2_key.png" alt="B760HV2_key"><br>可以看到已经正确对应到红色按键了，所以这个按键不用修改。如果你想把这个红外按键对应到别的键盘按键，就需要在<code>Config_key.sample</code>查找对应的key code，替换掉<code>remote.conf</code>中的0x18e这个key code。<br>全部按键修改完成后用以下命令即时生效</p>
<figure class="highlight basic"><table><tr><td class="code"><pre><span class="line"><span class="comment">remotecfg /storage/.config/amremote/remote.conf</span></span><br></pre></td></tr></table></figure>
<p>然后可以在kodi里面测试</p>
<figure class="highlight crmsh"><table><tr><td class="code"><pre><span class="line">systemctl <span class="literal">start</span> kodi</span><br></pre></td></tr></table></figure>
<p>下面是我最终修改过的<code>remote.conf</code>，大部分按键我都按照按键上面的中文意思，对应了相近的实体按键。<br><a href="remote.conf">下载remote.conf</a></p>
<h1 id="曲线救国实现Autossh"><a href="#曲线救国实现Autossh" class="headerlink" title="曲线救国实现Autossh"></a>曲线救国实现Autossh</h1><p>万一哪天直播源失效了，丈母娘看不了电视，我的高大形象毁于一旦。所以给自己留个后门，便于远程维护。首先想到的就是AutoSSH维持远程反向连接通道，可惜AlexELEC没有AutoSSH，也没有软件包管理器，不能安装软件。但是可以用Systemd托管SSH呀。</p>
<ul>
<li>先配置公网远程服务器</li>
</ul>
<p>修改公网服务器的SSH配置文件<code>/etc/ssh/sshd_config</code>  </p>
<figure class="highlight nginx"><table><tr><td class="code"><pre><span class="line"><span class="attribute">GatewayPorts</span> <span class="literal">yes</span></span><br></pre></td></tr></table></figure>
<p>这样可以把监听的端口绑定到任意IP 0.0.0.0上，否则只有本机127.0.0.1可以访问。<br>记得重启SSH服务器</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="built_in">sudo</span> service restart sshd</span><br></pre></td></tr></table></figure>
<ul>
<li>电视盒子上生成密钥</li>
</ul>
<figure class="highlight awk"><table><tr><td class="code"><pre><span class="line">ssh-keygen -t rsa -f <span class="regexp">/storage/</span>.ssh/id_rsa</span><br></pre></td></tr></table></figure>
<ul>
<li>将电视盒子密钥添加到公网远程服务器</li>
</ul>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="built_in">cat</span> /storage/.ssh/id_rsa.pub | ssh 远程用户名@远程服务器地址 <span class="string">&#x27;cat &gt;&gt; .ssh/authorized_keys&#x27;</span></span><br></pre></td></tr></table></figure>
<ul>
<li>测试</li>
</ul>
<figure class="highlight nginx"><table><tr><td class="code"><pre><span class="line"><span class="attribute">ssh</span> -NTR [远程映射端口]:localhost:<span class="number">22</span> 远程用户名@远程服务器地址 -o ExitOnForwardFailure=<span class="literal">yes</span></span><br></pre></td></tr></table></figure>
<p>然后直接ssh连接远程服务器的远程映射端口就可以连上电视盒子了。</p>
<ul>
<li>编写serivce文件</li>
</ul>
<p>用你喜欢的文本编辑器，编辑<code>/storage/.config/system.d/autossh.service</code></p>
<figure class="highlight ini"><table><tr><td class="code"><pre><span class="line"><span class="section">[Unit]</span></span><br><span class="line"><span class="attr">Description</span>=SSH Tunnel</span><br><span class="line"><span class="attr">After</span>=network.target</span><br><span class="line"></span><br><span class="line"><span class="section">[Service]</span></span><br><span class="line"><span class="attr">Restart</span>=always</span><br><span class="line"><span class="attr">RestartSec</span>=<span class="number">5</span></span><br><span class="line"><span class="attr">User</span>=root</span><br><span class="line"><span class="attr">ExecStart</span>=/bin/ssh -NTR [远程映射端口]:localhost:<span class="number">22</span> 远程用户名@远程服务器地址 -o ExitOnForwardFailure=<span class="literal">yes</span></span><br><span class="line"></span><br><span class="line"><span class="section">[Install]</span></span><br><span class="line"><span class="attr">WantedBy</span>=multi-user.target</span><br></pre></td></tr></table></figure>
<p>启用这个服务，下次开机自动启动</p>
<figure class="highlight routeros"><table><tr><td class="code"><pre><span class="line">systemctl <span class="built_in">enable</span> autossh.service</span><br></pre></td></tr></table></figure>

<h1 id="加散热片和改内置WiFi天线"><a href="#加散热片和改内置WiFi天线" class="headerlink" title="加散热片和改内置WiFi天线"></a>加散热片和改内置WiFi天线</h1><p>图片丢了，就不贴了。焊了一个号称5DB的内置PCB天线效果，效果非常不好，后来还是改用了USB无线网卡。<br>到此功能全部实现，折腾结束</p>
]]></content>
  </entry>
  <entry>
    <title>利用ESPHome进行蓝牙设备定位</title>
    <url>/2022/03/06/ESPHome-ble-tracker/</url>
    <content><![CDATA[<p>最近捣鼓智能家居，用ESP32进行蓝牙设备定位，追踪小米手环手环，根据信号强度判断人是否在房间或者家里。</p>
<h1 id="硬件与软件准备工作"><a href="#硬件与软件准备工作" class="headerlink" title="硬件与软件准备工作"></a>硬件与软件准备工作</h1><table>
<thead>
<tr>
<th align="left">硬件</th>
<th align="right">软件</th>
</tr>
</thead>
<tbody><tr>
<td align="left">ESP32</td>
<td align="right">ESPHome v2022.2.1</td>
</tr>
<tr>
<td align="left">NAS/软路由</td>
<td align="right">Homeassistant 2021.11.4</td>
</tr>
<tr>
<td align="left">小米手环</td>
<td align="right"></td>
</tr>
</tbody></table>
<p>首先要在“小米穿戴”APP中打开小米手环的“蓝牙广播”功能，重启小米手环并确定“蓝牙广播”处于开启状态。进入小米手环的设置，记录下小米手环的蓝牙地址，例如我的小米手环蓝牙地址<code>FA:4C:19:74:CF:20</code></p>
<h1 id="编译并上传固件"><a href="#编译并上传固件" class="headerlink" title="编译并上传固件"></a>编译并上传固件</h1><p>详细参见<a target="_blank" rel="noopener" href="https://esphome.io/components/esp32_ble_tracker.html">ESPHome的ESP32 Bluetooth Low Energy Tracker Hub章节</a>，下面粘贴我的ESPHome的编译配置yaml。</p>
<figure class="highlight nix"><table><tr><td class="code"><pre><span class="line"><span class="params">esphome:</span></span><br><span class="line">  <span class="params">name:</span> esp32</span><br><span class="line"></span><br><span class="line"><span class="params">esp32:</span></span><br><span class="line">  <span class="params">board:</span> esp32dev</span><br><span class="line">  <span class="params">framework:</span></span><br><span class="line">    <span class="params">type:</span> esp-idf</span><br><span class="line">    <span class="params">version:</span> latest</span><br><span class="line">    <span class="comment"># Custom sdkconfig options</span></span><br><span class="line">    <span class="params">sdkconfig_options:</span></span><br><span class="line">      <span class="params">CONFIG_COMPILER_OPTIMIZATION_SIZE:</span> y</span><br><span class="line">    <span class="comment"># Advanced tweaking options</span></span><br><span class="line">    <span class="params">advanced:</span></span><br><span class="line">      <span class="params">ignore_efuse_mac_crc:</span> <span class="literal">false</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Enable logging</span></span><br><span class="line"><span class="params">logger:</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Enable Home Assistant API</span></span><br><span class="line"><span class="params">api:</span></span><br><span class="line"></span><br><span class="line"><span class="params">ota:</span></span><br><span class="line">  <span class="params">password:</span> <span class="string">&quot;&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="params">wifi:</span></span><br><span class="line">  <span class="params">ssid:</span> <span class="operator">!</span>secret wifi_ssid</span><br><span class="line">  <span class="params">password:</span> <span class="operator">!</span>secret wifi_password</span><br><span class="line"></span><br><span class="line"><span class="params">esp32_ble_tracker:</span></span><br><span class="line">  <span class="params">scan_parameters:</span></span><br><span class="line">    <span class="params">interval:</span> <span class="number">1</span>s</span><br><span class="line">    <span class="params">window:</span> <span class="number">500</span>ms</span><br><span class="line">    <span class="params">active:</span> <span class="literal">false</span></span><br><span class="line"><span class="params">sensor:</span></span><br><span class="line">  <span class="operator">-</span> <span class="params">platform:</span> ble_rssi</span><br><span class="line">    <span class="params">mac_address:</span> FA:<span class="number">4</span>C:<span class="number">19</span>:<span class="number">74</span>:CF:<span class="number">20</span></span><br><span class="line">    <span class="params">name:</span> <span class="string">&quot;MI Band RSSI value&quot;</span></span><br></pre></td></tr></table></figure>
<p>其中<code>scan_parameters:</code>字键中的参数是重点，默认参数不能保证每次扫描都获得信号强度。</p>
]]></content>
      <tags>
        <tag>HomeAssistant</tag>
        <tag>ESP芯片</tag>
      </tags>
  </entry>
  <entry>
    <title>部署Hexo笔记</title>
    <url>/2019/10/05/Hexo-install/</url>
    <content><![CDATA[<p>个人Hexo博客搭建的记录，我不想让别人看到推送记录，所以都是强制推送。</p>
<span id="more"></span>
<ul>
<li>先克隆已经配置好的源码  <figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">git <span class="built_in">clone</span> https://gitlab.com/weiyangbo/weiyangbo.gitlab.io.git &amp;&amp; <span class="built_in">cd</span> weiyangbo.gitlab.io</span><br></pre></td></tr></table></figure></li>
<li>安装hexo  <figure class="highlight armasm"><table><tr><td class="code"><pre><span class="line"><span class="symbol">curl</span> -<span class="built_in">sL</span> https:<span class="comment">//deb.nodesource.com/setup_22.x | sudo -E bash - &amp;&amp; sudo apt install -y nodejs &amp;&amp; sudo npm install hexo-cli gulp -g &amp;&amp; npm install</span></span><br></pre></td></tr></table></figure></li>
<li>推送到Gitlab并自动构建网页  <figure class="highlight sas"><table><tr><td class="code"><pre><span class="line">rm -rf .git <span class="variable">&amp;&amp;</span> git init <span class="variable">&amp;&amp;</span> git <span class="keyword">add</span> . <span class="variable">&amp;&amp;</span> git remote <span class="keyword">add</span> origin git@gitlab.com:weiyangbo/weiyangbo.gitlab.io.git <span class="variable">&amp;&amp;</span> git commit -a -m <span class="string">&quot;Init Blog&quot;</span> <span class="variable">&amp;&amp;</span>  git push -f --<span class="keyword">set</span>-upstream origin master</span><br></pre></td></tr></table></figure></li>
<li>推送静态网页到GitHub &amp;&amp; Gitee (Github推送后自动部署，Gitee推送后需手动更新)  <figure class="highlight sas"><table><tr><td class="code"><pre><span class="line">rm -rf .deploy_git/ <span class="variable">&amp;&amp;</span> hexo clean <span class="variable">&amp;&amp;</span> hexo g <span class="variable">&amp;&amp;</span> gulp <span class="variable">&amp;&amp;</span> hexo d</span><br></pre></td></tr></table></figure></li>
<li>不到万不得已，不使用cnpm  <figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="built_in">echo</span> <span class="string">&#x27;alias cnpm=&quot;npm --registry=https://registry.npm.taobao.org --cache=$HOME/.npm/.cache/cnpm --disturl=https://npm.taobao.org/dist --userconfig=$HOME/.cnpmrc&quot;&#x27;</span> &gt;&gt; ~/.bashrc &amp;&amp; <span class="built_in">source</span> ~/.bashrc</span><br></pre></td></tr></table></figure>
</li>
</ul>
]]></content>
  </entry>
  <entry>
    <title>Homeassistant远程开关NAS</title>
    <url>/2021/11/28/Homeassistant-wol/</url>
    <content><![CDATA[<h1 id="安装环境"><a href="#安装环境" class="headerlink" title="安装环境"></a>安装环境</h1><p>首先按照官方指南<a target="_blank" rel="noopener" href="https://www.home-assistant.io/installation/linux#install-home-assistant-supervised">Install Home Assistant Supervised</a></p>
<h1 id="HA控制Linux开机与关机"><a href="#HA控制Linux开机与关机" class="headerlink" title="HA控制Linux开机与关机"></a>HA控制Linux开机与关机</h1><h2 id="将HA的ssh-key添加到nas"><a href="#将HA的ssh-key添加到nas" class="headerlink" title="将HA的ssh key添加到nas"></a>将HA的ssh key添加到nas</h2><p>众所周知ssh登录是要输入密码的，为了能让关机的ssh可以在没有交互的情况下完成，我们要将HA的ssh key添加到nas。注意不是将HA的宿主机的SSH key添加到nas。</p>
<figure class="highlight powershell"><table><tr><td class="code"><pre><span class="line">docker exec <span class="literal">-it</span>  <span class="variable">$</span>(docker <span class="built_in">ps</span> <span class="operator">-f</span> name=homeassistant <span class="literal">-q</span>)  bash</span><br></pre></td></tr></table></figure>
<p>这样进入docker容器的shell，如果是第一次，下面开始生成ssh key</p>
<figure class="highlight awk"><table><tr><td class="code"><pre><span class="line">ssh-keygen -t rsa -f <span class="regexp">/root/</span>.ssh/id_rsa</span><br></pre></td></tr></table></figure>
<p>然后一路回车，直到生成密钥，然后执行<code>ssh-id-copy</code>将密钥复制到nas</p>
<figure class="highlight applescript"><table><tr><td class="code"><pre><span class="line">ssh-<span class="keyword">copy</span>-<span class="built_in">id</span> root@nas的ip地址</span><br></pre></td></tr></table></figure>
<p>接着按照提示输入nas的root密码，复制密钥完成，以后就可以免密登录nas了。<br>可以在docker容器的shell中直接测试<code>ssh root@nas的ip地址</code></p>
<h2 id="在HA中添加一个名为nas的switch实体"><a href="#在HA中添加一个名为nas的switch实体" class="headerlink" title="在HA中添加一个名为nas的switch实体"></a>在HA中添加一个名为nas的switch实体</h2><p>然后编辑HA的配置文件<code>/usr/share/hassio/homeassistant/configuration.yaml</code>，添加如下字段</p>
<figure class="highlight nix"><table><tr><td class="code"><pre><span class="line"><span class="params">switch:</span></span><br><span class="line">    <span class="operator">-</span> <span class="params">platform:</span> wake_on_lan</span><br><span class="line">      <span class="params">mac:</span> <span class="string">&quot;nas的mac地址&quot;</span></span><br><span class="line">      <span class="params">name:</span> <span class="string">&quot;nas&quot;</span></span><br><span class="line">      <span class="params">host:</span> <span class="string">&quot;nas的ip地址&quot;</span></span><br><span class="line">      <span class="params">turn_off:</span></span><br><span class="line">        <span class="params">service:</span> shell_command.turn_off_nas</span><br><span class="line"></span><br><span class="line"><span class="params">shell_command:</span></span><br><span class="line">  <span class="params">turn_off_nas:</span> <span class="string">&quot;ssh -i /root/.ssh/id_rsa -o &#x27;StrictHostKeyChecking=no&#x27; root@nas的ip地址 poweroff&quot;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="在HA面板中添加nas"><a href="#在HA面板中添加nas" class="headerlink" title="在HA面板中添加nas"></a>在HA面板中添加nas</h2><p>在HA的概览中编辑仪表盘，添加nas开关。然后看看能不能控制nas的开机和关机啦！</p>
<h1 id="HA控制Windows开机与关机"><a href="#HA控制Windows开机与关机" class="headerlink" title="HA控制Windows开机与关机"></a>HA控制Windows开机与关机</h1><h2 id="让Windows支持远程关机"><a href="#让Windows支持远程关机" class="headerlink" title="让Windows支持远程关机"></a>让Windows支持远程关机</h2><ul>
<li>关闭防火墙，禁用杀毒软件，排除相关干扰</li>
<li>必须要设置账户密码，因为要远程开机，所以最好还要设置自动登录（下面会说到）</li>
<li>开启RPC相关服务（下面会说到）</li>
</ul>
<p>首先管理员身份运行CMD，运行如下命令</p>
<figure class="highlight powershell"><table><tr><td class="code"><pre><span class="line"><span class="built_in">sc</span> config RemoteRegistry <span class="built_in">start</span>= auto</span><br><span class="line"><span class="built_in">sc</span> <span class="built_in">start</span> RemoteRegistry</span><br><span class="line"><span class="built_in">sc</span> config RpcSs <span class="built_in">start</span>= auto</span><br><span class="line"><span class="built_in">sc</span> <span class="built_in">start</span> RpcSs</span><br></pre></td></tr></table></figure>
<p>将下面的文字复制到文本文档，更改<code>DefaultUserName</code>和<code>DefaultPassword</code>更改为你的用户名和密码</p>
<figure class="highlight moonscript"><table><tr><td class="code"><pre><span class="line">Windows Registry Editor Version <span class="number">5.00</span></span><br><span class="line"></span><br><span class="line">[HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Windows\CurrentVersion\Policies\System]</span><br><span class="line"><span class="string">&quot;LocalAccountTokenFilterPolicy&quot;</span>=<span class="name">dword</span>:<span class="number">00000001</span></span><br><span class="line"></span><br><span class="line">[HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Windows NT\CurrentVersion\Winlogon]</span><br><span class="line"><span class="string">&quot;AutoAdminLogon&quot;</span>=<span class="string">&quot;1&quot;</span></span><br><span class="line"><span class="string">&quot;DefaultUserName&quot;</span>=<span class="string">&quot;My&quot;</span></span><br><span class="line"><span class="string">&quot;DefaultPassword&quot;</span>=<span class="string">&quot;weiyangbo&quot;</span></span><br></pre></td></tr></table></figure>
<p>最后将文本文档的后缀改为reg，合并入注册表</p>
<h2 id="简单的RPC-Shutdown大法（HA支持Adds-on的情况）"><a href="#简单的RPC-Shutdown大法（HA支持Adds-on的情况）" class="headerlink" title="简单的RPC Shutdown大法（HA支持Adds-on的情况）"></a>简单的RPC Shutdown大法（HA支持Adds-on的情况）</h2><h3 id="安装RPC-Shutdown并配置"><a href="#安装RPC-Shutdown并配置" class="headerlink" title="安装RPC Shutdown并配置"></a>安装RPC Shutdown并配置</h3><p>这步很简单，直接在Add-ons商店里面搜索<code>RPC Shutdown</code>并安装就可以了。不过前提是你的HA要支持Add-ons，至少要Supervisor方式安装才有可能支持安装Add-ons。<br>进入RPC Shutdown的“配置”选项卡，更改<code>address</code>为你的Windows电脑的IP地址（肯定要是固定的），更改<code>credentials</code>为<code>Windows用户名%Windows密码</code>（其中%是不可省略的分隔符），更改<code>alias</code>为自己好记的名字。</p>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">computers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">address:</span> <span class="number">192.168</span><span class="number">.0</span><span class="number">.12</span></span><br><span class="line">    <span class="attr">alias:</span> <span class="string">my-pc</span></span><br><span class="line">    <span class="attr">credentials:</span> <span class="string">My%weiyangbo</span></span><br><span class="line">    <span class="attr">delay:</span> <span class="number">0</span></span><br><span class="line">    <span class="attr">message:</span> <span class="string">&gt;-</span></span><br><span class="line"><span class="string">      Home Assistant is shutting down this PC. This cannot be canceled. Please</span></span><br><span class="line"><span class="string">      save your work!</span></span><br><span class="line"><span class="string"></span></span><br></pre></td></tr></table></figure>
<p>保存并重启RPC Shutdown</p>
<h3 id="在HA中添加一个名为PC的switch实体"><a href="#在HA中添加一个名为PC的switch实体" class="headerlink" title="在HA中添加一个名为PC的switch实体"></a>在HA中添加一个名为PC的switch实体</h3><p>然后编辑HA的配置文件<code>/usr/share/hassio/homeassistant/configuration.yaml</code>，在<code>switch</code>字段下添加如下字段</p>
<figure class="highlight nix"><table><tr><td class="code"><pre><span class="line"><span class="params">switch:</span></span><br><span class="line">    <span class="operator">-</span> <span class="params">platform:</span> wake_on_lan</span><br><span class="line">      <span class="params">mac:</span> <span class="string">&quot;1c-1b-0d-18-63-0c&quot;</span></span><br><span class="line">      <span class="params">name:</span> <span class="string">&quot;PC&quot;</span></span><br><span class="line">      <span class="params">host:</span> <span class="string">&quot;192.168.0.12&quot;</span></span><br><span class="line">      <span class="params">turn_off:</span></span><br><span class="line">        <span class="params">service:</span> hassio.addon_stdin</span><br><span class="line">        <span class="params">data:</span></span><br><span class="line">            <span class="params">addon:</span> core_rpc_shutdown</span><br><span class="line">            <span class="params">input:</span> my-pc</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="复杂的曲线救国（HA不支持Adds-on的情况）"><a href="#复杂的曲线救国（HA不支持Adds-on的情况）" class="headerlink" title="复杂的曲线救国（HA不支持Adds-on的情况）"></a>复杂的曲线救国（HA不支持Adds-on的情况）</h2><h3 id="安装php和samba-common-bin"><a href="#安装php和samba-common-bin" class="headerlink" title="安装php和samba-common-bin"></a>安装php和samba-common-bin</h3><figure class="highlight armasm"><table><tr><td class="code"><pre><span class="line"><span class="symbol">sudo</span> apt install php samba-<span class="meta">common</span>-bin</span><br></pre></td></tr></table></figure>
<p>新建php文件接受GET请求来执行对应的指令</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line">cat &gt; remote_excute.php &lt;&lt; <span class="string">&#x27;EOF&#x27;</span></span><br><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">isset</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;shutdown_pc&#x27;</span>])) &#123;</span><br><span class="line">  <span class="variable">$output</span> = <span class="title function_ invoke__">shell_exec</span>(<span class="string">&#x27;net rpc -S 192.168.0.12 -U My%weiyangbo shutdown -t 1 -f&#x27;</span>);</span><br><span class="line">  <span class="keyword">echo</span> <span class="string">&quot;&lt;pre&gt;<span class="subst">$output</span>&lt;/pre&gt;&quot;</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>
<p>php开机自启动，添加以下内容到<code>/etc/rc.local</code></p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="built_in">nohup</span> php -S 0.0.0.0:80 /root/remote_excute.php &amp;</span><br></pre></td></tr></table></figure>

<h3 id="在HA中添加一个名为PC的switch实体-1"><a href="#在HA中添加一个名为PC的switch实体-1" class="headerlink" title="在HA中添加一个名为PC的switch实体"></a>在HA中添加一个名为PC的switch实体</h3><p>然后编辑HA的配置文件<code>/usr/share/hassio/homeassistant/configuration.yaml</code>，在<code>switch</code>字段下添加如下字段</p>
<figure class="highlight nix"><table><tr><td class="code"><pre><span class="line"><span class="params">switch:</span></span><br><span class="line">    <span class="operator">-</span> <span class="params">platform:</span> wake_on_lan</span><br><span class="line">      <span class="params">mac:</span> <span class="string">&quot;4c-cc-6a-6b-0a-15&quot;</span></span><br><span class="line">      <span class="params">name:</span> <span class="string">&quot;PC&quot;</span></span><br><span class="line">      <span class="params">host:</span> <span class="string">&quot;192.168.0.12&quot;</span></span><br><span class="line">      <span class="params">turn_off:</span></span><br><span class="line">        <span class="params">service:</span> shell_command.turn_off_pc</span><br><span class="line"></span><br><span class="line"><span class="params">shell_command:</span></span><br><span class="line">  <span class="params">turn_off_pc:</span> <span class="string">&quot;curl http://127.0.0.1:80/?shutdown_pc&quot;</span></span><br></pre></td></tr></table></figure>

<h2 id="在HA面板中添加nas-1"><a href="#在HA面板中添加nas-1" class="headerlink" title="在HA面板中添加nas"></a>在HA面板中添加nas</h2><p>在HA的概览中编辑仪表盘，添加PC开关。然后看看能不能控制Windows PC的开机和关机啦！</p>
]]></content>
      <tags>
        <tag>HomeAssistant</tag>
      </tags>
  </entry>
  <entry>
    <title>Jellyfin-HWAcceleration</title>
    <url>/2022/03/10/Jellyfin-HWAcceleration/</url>
    <content><![CDATA[<p>Debian上直接<a target="_blank" rel="noopener" href="https://jellyfin.org/docs/general/administration/installing.html#debian">安装Jellyfin</a>，成功<a target="_blank" rel="noopener" href="https://jellyfin.org/docs/general/administration/hardware-acceleration.html#intel-quicksync">开启QSV硬解</a><br>某次<code>apt upgrade</code> 后，Jellyfin在网页播放视频时报错，提示“视频与客户端不兼容”之类的字样。关闭硬件解码就可以播放，但是不论打开QSV硬解还是VAAPI硬解都报错。</p>
<h1 id="问题描述"><a href="#问题描述" class="headerlink" title="问题描述"></a>问题描述</h1><p>jellyfin.log（片段）</p>
<figure class="highlight subunit"><table><tr><td class="code"><pre><span class="line">[2022<span class="string">-03</span><span class="string">-10</span> 06:54:50.378 <span class="string">-05</span>:00] [INF] Current HLS implementation doesn&#x27;t support non-keyframe breaks but one is requested, ignoring that request</span><br><span class="line">[2022<span class="string">-03</span><span class="string">-10</span> 06:54:50.379 <span class="string">-05</span>:00] [INF] /usr/lib/jellyfin-ffmpeg/ffmpeg -c:v h264_qsv -hwaccel qsv -i file:&quot;/home/wei/downloads/porn/VID_20220128_081427_101.mp4&quot; -map_metadata <span class="string">-1</span> -map_chapters <span class="string">-1</span> -threads 0 -map 0:0 -map 0:1 -map <span class="string">-0</span>:s -codec:v:0 h264_qsv -preset 7 -look_ahead 0 -b:v 4497036 -maxrate 4497036 -bufsize 8994072 -profile:v:0 high -level 41 -g:v:0 45 -keyint_min:v:0 45 -sc_threshold:v:0 0 -vf &quot;vpp_qsv=format=nv12&quot; -start_at_zero -vsync <span class="string">-1</span> -codec:a:0 aac -ac 2 -ab 128000 -copyts -avoid_negative_ts disabled -max_muxing_queue_size 2048 -f hls -max_delay 5000000 -hls_time 3 -hls_segment_type mpegts -start_number 0 -hls_segment_filename &quot;/var/lib/jellyfin/transcodes/904f296c004933ba148e126a69df77e7%d.ts&quot; -hls_playlist_type vod -hls_list_size 0 -y &quot;/var/lib/jellyfin/transcodes/904f296c004933ba148e126a69df77e7.m3u8&quot;</span><br><span class="line">[2022<span class="string">-03</span><span class="string">-10</span> 06:54:50.401 <span class="string">-05</span>:00] [ERR] FFmpeg exited with code 1</span><br><span class="line">[2022<span class="string">-03</span><span class="string">-10</span> 06:54:50.486 <span class="string">-05</span>:00] [WRN] cannot serve &quot;/var/lib/jellyfin/transcodes/904f296c004933ba148e126a69df77e70.ts&quot; as transcoding quit before we got there</span><br><span class="line">[2022<span class="string">-03</span><span class="string">-10</span> 06:54:50.489 <span class="string">-05</span>:00] [ERR] Error processing request: &quot;Could not find file &#x27;/var/lib/jellyfin/transcodes/904f296c004933ba148e126a69df77e70.ts&#x27;&quot;. URL &quot;GET&quot; &quot;/videos/7a24af2c<span class="string">-9</span>df3<span class="string">-66</span>d4-aac8<span class="string">-9</span>d671e3a6507/hls1/main/0.ts&quot;.</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>FFMPEG.Transcode.log（片段）</p>
<figure class="highlight stylus"><table><tr><td class="code"><pre><span class="line">/usr/lib/jellyfin-ffmpeg/ffmpeg -c:v h264_qsv -hwaccel qsv -<span class="selector-tag">i</span> file:<span class="string">&quot;/home/wei/downloads/porn/VID_20220128_081427_101.mp4&quot;</span> -map_metadata -<span class="number">1</span> -map_chapters -<span class="number">1</span> -threads <span class="number">0</span> -map <span class="number">0</span>:<span class="number">0</span> -map <span class="number">0</span>:<span class="number">1</span> -map -<span class="number">0</span>:s -codec:v:<span class="number">0</span> h264_qsv -preset <span class="number">7</span> -look_ahead <span class="number">0</span> -<span class="selector-tag">b</span>:v <span class="number">4497036</span> -maxrate <span class="number">4497036</span> -bufsize <span class="number">8994072</span> -profile:v:<span class="number">0</span> high -level <span class="number">41</span> -<span class="selector-tag">g</span>:v:<span class="number">0</span> <span class="number">45</span> -keyint_min:v:<span class="number">0</span> <span class="number">45</span> -sc_threshold:v:<span class="number">0</span> <span class="number">0</span> -vf <span class="string">&quot;vpp_qsv=format=nv12&quot;</span> -start_at_zero -vsync -<span class="number">1</span> -codec:<span class="selector-tag">a</span>:<span class="number">0</span> aac -ac <span class="number">2</span> -ab <span class="number">128000</span> -copyts -avoid_negative_ts disabled -max_muxing_queue_size <span class="number">2048</span> -f hls -max_delay <span class="number">5000000</span> -hls_time <span class="number">3</span> -hls_segment_type mpegts -start_number <span class="number">0</span> -hls_segment_filename <span class="string">&quot;/var/lib/jellyfin/transcodes/904f296c004933ba148e126a69df77e7%d.ts&quot;</span> -hls_playlist_type vod -hls_list_size <span class="number">0</span> -<span class="attribute">y</span> <span class="string">&quot;/var/lib/jellyfin/transcodes/904f296c004933ba148e126a69df77e7.m3u8&quot;</span></span><br><span class="line"></span><br><span class="line">ffmpeg version <span class="number">4.4</span>.<span class="number">1</span>-Jellyfin Copyright (c) <span class="number">2000</span>-<span class="number">2021</span> the FFmpeg developers</span><br><span class="line">  built with gcc <span class="number">10</span> (Debian <span class="number">10.2</span>.<span class="number">1</span>-<span class="number">6</span>)</span><br><span class="line">  configuration: <span class="attr">--prefix</span>=/usr/lib/jellyfin-ffmpeg <span class="attr">--target-os</span>=linux <span class="attr">--extra-version</span>=Jellyfin <span class="attr">--disable-doc</span> <span class="attr">--disable-ffplay</span> <span class="attr">--disable-shared</span> <span class="attr">--disable-libxcb</span> <span class="attr">--disable-sdl2</span> <span class="attr">--disable-xlib</span> <span class="attr">--enable-lto</span> <span class="attr">--enable-gpl</span> <span class="attr">--enable-version3</span> <span class="attr">--enable-static</span> <span class="attr">--enable-gmp</span> <span class="attr">--enable-gnutls</span> <span class="attr">--enable-libdrm</span> <span class="attr">--enable-libass</span> <span class="attr">--enable-libfreetype</span> <span class="attr">--enable-libfribidi</span> <span class="attr">--enable-libfontconfig</span> <span class="attr">--enable-libbluray</span> <span class="attr">--enable-libmp3lame</span> <span class="attr">--enable-libopus</span> <span class="attr">--enable-libtheora</span> <span class="attr">--enable-libvorbis</span> <span class="attr">--enable-libdav1d</span> <span class="attr">--enable-libwebp</span> <span class="attr">--enable-libvpx</span> <span class="attr">--enable-libx264</span> <span class="attr">--enable-libx265</span> <span class="attr">--enable-libzvbi</span> <span class="attr">--enable-libzimg</span> <span class="attr">--arch</span>=amd64 <span class="attr">--enable-opencl</span> <span class="attr">--enable-vaapi</span> <span class="attr">--enable-amf</span> <span class="attr">--enable-libmfx</span> <span class="attr">--enable-vdpau</span> <span class="attr">--enable-ffnvcodec</span> <span class="attr">--enable-cuda</span> <span class="attr">--enable-cuda-llvm</span> <span class="attr">--enable-cuvid</span> <span class="attr">--enable-nvdec</span> <span class="attr">--enable-nvenc</span></span><br><span class="line">  libavutil      <span class="number">56</span>. <span class="number">70.100</span> / <span class="number">56</span>. <span class="number">70.100</span></span><br><span class="line">  libavcodec     <span class="number">58.134</span>.<span class="number">100</span> / <span class="number">58.134</span>.<span class="number">100</span></span><br><span class="line">  libavformat    <span class="number">58</span>. <span class="number">76.100</span> / <span class="number">58</span>. <span class="number">76.100</span></span><br><span class="line">  libavdevice    <span class="number">58</span>. <span class="number">13.100</span> / <span class="number">58</span>. <span class="number">13.100</span></span><br><span class="line">  libavfilter     <span class="number">7.110</span>.<span class="number">100</span> /  <span class="number">7.110</span>.<span class="number">100</span></span><br><span class="line">  libswscale      <span class="number">5</span>.  <span class="number">9.100</span> /  <span class="number">5</span>.  <span class="number">9.100</span></span><br><span class="line">  libswresample   <span class="number">3</span>.  <span class="number">9.100</span> /  <span class="number">3</span>.  <span class="number">9.100</span></span><br><span class="line">  libpostproc    <span class="number">55</span>.  <span class="number">9.100</span> / <span class="number">55</span>.  <span class="number">9.100</span></span><br><span class="line">WARNING: defaulting hwaccel_output_format to qsv <span class="keyword">for</span> compatibility with old commandlines. This behaviour is DEPRECATED and will be removed <span class="keyword">in</span> the future. Please explicitly set <span class="string">&quot;-hwaccel_output_format qsv&quot;</span>.</span><br><span class="line">Input #<span class="number">0</span>, mov,mp4,m4a,<span class="number">3</span>gp,<span class="number">3</span>g2,mj2, from <span class="string">&#x27;file:/home/wei/downloads/porn/VID_20220128_081427_101.mp4&#x27;</span>:</span><br><span class="line">  Metadata:</span><br><span class="line">    major_brand     : isom</span><br><span class="line">    minor_version   : <span class="number">512</span></span><br><span class="line">    compatible_brands: isomiso2avc1mp41</span><br><span class="line">    encoder         : Lavf58.<span class="number">20.100</span></span><br><span class="line">  Duration: <span class="number">01</span>:<span class="number">23</span>:<span class="number">00.66</span>, start: <span class="number">0.000000</span>, bitrate: <span class="number">1031</span> kb/s</span><br><span class="line">  Stream #<span class="number">0</span>:<span class="number">0</span>(und): Video: h264 (Constrained Baseline) (avc1 / <span class="number">0</span>x31637661), yuv420p, <span class="number">960</span>x540, <span class="number">899</span> kb/s, SAR <span class="number">1</span>:<span class="number">1</span> DAR <span class="number">16</span>:<span class="number">9</span>, <span class="number">14.99</span> fps, <span class="number">15</span> tbr, <span class="number">15360</span> tbn, <span class="number">30720</span> tbc (default)</span><br><span class="line">    Metadata:</span><br><span class="line">      handler_name    : VideoHandler</span><br><span class="line">      vendor_id       : <span class="selector-attr">[0]</span><span class="selector-attr">[0]</span><span class="selector-attr">[0]</span><span class="selector-attr">[0]</span></span><br><span class="line">  Stream #<span class="number">0</span>:<span class="number">1</span>(und): Audio: mp3 (mp4a / <span class="number">0</span>x6134706D), <span class="number">44100</span> Hz, stereo, fltp, <span class="number">128</span> kb/s (default)</span><br><span class="line">    Metadata:</span><br><span class="line">      handler_name    : SoundHandler</span><br><span class="line">      vendor_id       : <span class="selector-attr">[0]</span><span class="selector-attr">[0]</span><span class="selector-attr">[0]</span><span class="selector-attr">[0]</span></span><br><span class="line">Device creation failed: -<span class="number">542398533</span>.</span><br><span class="line"><span class="selector-attr">[h264_qsv @ 0x5608e2e5de40]</span> No device available <span class="keyword">for</span> decoder: device type qsv needed <span class="keyword">for</span> codec h264_qsv.</span><br><span class="line">Stream mapping:</span><br><span class="line">  Stream #<span class="number">0</span>:<span class="number">0</span> -&gt; #<span class="number">0</span>:<span class="number">0</span> (h264 (h264_qsv) -&gt; h264 (h264_qsv))</span><br><span class="line">  Stream #<span class="number">0</span>:<span class="number">1</span> -&gt; #<span class="number">0</span>:<span class="number">1</span> (mp3 (mp3float) -&gt; aac (native))</span><br><span class="line">Device setup failed <span class="keyword">for</span> decoder on <span class="selector-tag">input</span> stream #<span class="number">0</span>:<span class="number">0</span> : Generic error <span class="keyword">in</span> an external library</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h1 id="解决方案"><a href="#解决方案" class="headerlink" title="解决方案"></a>解决方案</h1><p>原因是Jellyfin没有使用<code>/dev/dri/renderD128</code>的权限，不信的话可以用root用户执行FFMPEG的命令试试，如果没有报错的话，那肯定是权限问题。<br>首先确定Jellyfin的所属用户</p>
<figure class="highlight vim"><table><tr><td class="code"><pre><span class="line"><span class="keyword">ps</span> auxw | <span class="keyword">grep</span> jellyfin</span><br></pre></td></tr></table></figure>
<p>查看渲染设备所处的用户组</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="built_in">stat</span> -c <span class="string">&quot;%G&quot;</span> /dev/dri/render*</span><br></pre></td></tr></table></figure>
<p>查看Jellyfin用户所属的用户组</p>
<figure class="highlight coq"><table><tr><td class="code"><pre><span class="line">groups `ps auxw | <span class="type">grep</span> jelly | <span class="type">sed</span> -n <span class="string">&quot;1, 1p&quot;</span> | <span class="type">awk</span> &#x27;&#123;print $<span class="number">1</span>&#125;&#x27;`</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>可以看到两个不在一个组中，接下来把Jellyfin用户添加到<code>/dev/dri/render*</code>所属的组中 </p>
<figure class="highlight autohotkey"><table><tr><td class="code"><pre><span class="line">sudo gpasswd -a `ps auxw | grep jelly | sed -n <span class="string">&quot;1, 1p&quot;</span> | awk &#x27;&#123;print $<span class="number">1</span>&#125;&#x27;` `stat -c <span class="string">&quot;%G&quot;</span> /dev/dri/render*`</span><br><span class="line">newgrp render</span><br></pre></td></tr></table></figure>
<p>不用重启，马上点开视频看看是不是正常了。</p>
]]></content>
  </entry>
  <entry>
    <title>Jellyfin解决ass中文汉字变方块</title>
    <url>/2021/11/25/Jellyfin-support-Chineese/</url>
    <content><![CDATA[<p>有两种情形：Jellyfin直接在软件源中安装，或者docker安装的</p>
<span id="more"></span>
<p>Jellyfin在字幕设置中可以选择烧录字幕，开启之后一旦发现字幕会强制转码视频并烧录字幕，实测在我的rk3399开发板上是软件编码，消耗太大。不到万不得已不要开启，但是万一真的碰到烧录的中文汉字变成方块的情况，清继续往下看。</p>
<h1 id="情形一：软件源安装Jellyfin"><a href="#情形一：软件源安装Jellyfin" class="headerlink" title="情形一：软件源安装Jellyfin"></a>情形一：软件源安装Jellyfin</h1><p>详见<a target="_blank" rel="noopener" href="https://jellyfin.org/docs/general/installation/linux#debuntu-debian-ubuntu-and-derivatives-using-apt">Jellyfin官方安装指导</a></p>
<h2 id="下载字体文件"><a href="#下载字体文件" class="headerlink" title="下载字体文件"></a>下载字体文件</h2><p>首先下载<a href="FZZY_GBK.woff2.zip">方正准圆的 woff2 版本</a></p>
<figure class="highlight awk"><table><tr><td class="code"><pre><span class="line">mkdir <span class="regexp">/var/</span>lib<span class="regexp">/jellyfin/</span>data/fonts</span><br></pre></td></tr></table></figure>
<p>然后将字体文件解压并复制进上面的文件夹</p>
<h2 id="Jellyfin设置备用字体"><a href="#Jellyfin设置备用字体" class="headerlink" title="Jellyfin设置备用字体"></a>Jellyfin设置备用字体</h2><p>进入Jellyfin的控制台-&gt;备用字体文件路径，填写<code>/var/lib/jellyfin/data/fonts</code>。<br>然后勾选“启用备用字体”</p>
<h1 id="情形二：Docker安装Jellyfin（安装前）"><a href="#情形二：Docker安装Jellyfin（安装前）" class="headerlink" title="情形二：Docker安装Jellyfin（安装前）"></a>情形二：Docker安装Jellyfin（安装前）</h1><p>参考<a target="_blank" rel="noopener" href="https://jellyfin.org/docs/general/installation/container">Jellyfin官方安装指导</a><br>提供我的docker-compose.yaml</p>
<figure class="highlight nestedtext"><table><tr><td class="code"><pre><span class="line"><span class="attribute">version</span><span class="punctuation">:</span> <span class="string">&#x27;3.5&#x27;</span></span><br><span class="line"><span class="attribute">services</span><span class="punctuation">:</span></span><br><span class="line">  <span class="attribute">jellyfin</span><span class="punctuation">:</span></span><br><span class="line">    <span class="attribute">image</span><span class="punctuation">:</span> <span class="string">jellyfin/jellyfin</span></span><br><span class="line">    <span class="attribute">container_name</span><span class="punctuation">:</span> <span class="string">jellyfin</span></span><br><span class="line">    <span class="attribute">network_mode</span><span class="punctuation">:</span> <span class="string">&#x27;host&#x27;</span></span><br><span class="line">    <span class="attribute">volumes</span><span class="punctuation">:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">/path/to/media:/media</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">$&#123;PWD&#125;/jellyfin-config:/config</span></span><br><span class="line">    <span class="attribute">restart</span><span class="punctuation">:</span> <span class="string">&#x27;unless-stopped&#x27;</span></span><br><span class="line">    <span class="attribute">environment</span><span class="punctuation">:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">DOCKER_MODS=linuxserver/mods:universal-package-install</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">INSTALL_PACKAGES=fonts-noto-cjk-extra</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">TZ=Asia/Shanghai</span></span><br><span class="line">    <span class="attribute">devices</span><span class="punctuation">:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">/dev/dri:/dev/dri</span></span><br></pre></td></tr></table></figure>
<p><code>docker-compose up -d</code></p>
<h1 id="情形三：Docker安装Jellyfin（安装后补救）"><a href="#情形三：Docker安装Jellyfin（安装后补救）" class="headerlink" title="情形三：Docker安装Jellyfin（安装后补救）"></a>情形三：Docker安装Jellyfin（安装后补救）</h1><figure class="highlight mipsasm"><table><tr><td class="code"><pre><span class="line">docker exec -it  $(docker ps -f name=<span class="keyword">jellyfin </span>-q)  <span class="keyword">bash</span></span><br><span class="line"><span class="keyword"></span>apt update</span><br><span class="line">apt <span class="keyword">install </span>fonts-noto-cjk</span><br></pre></td></tr></table></figure>
]]></content>
  </entry>
  <entry>
    <title>在Ubuntu 18.04上设置MTU</title>
    <url>/2019/11/14/MTU-reset/</url>
    <content><![CDATA[<p>用SSH连接服务器经常无缘无故断掉，SSH/SS连接表现出非常不稳定。但是用别的方法测试（ping或者访问服务器网页）速度都非常快，也没有丢包。<br>一番搜索，发现是MTU值为1500设置太高了，表现为SSH客户端在认证时会卡在<code>debug1: SSH2_MSG_KEXINIT sent</code><br>下面分别给出在Ubuntu 18.04和Android下设置MTU的方法。</p>
<span id="more"></span>
<h1 id="Ubuntu下的设置方式"><a href="#Ubuntu下的设置方式" class="headerlink" title="Ubuntu下的设置方式"></a>Ubuntu下的设置方式</h1><p>这是没有桌面环境的Ubuntu的设置方法，如果有桌面环境，那么直接进入<code>network-manager</code>中修改就完事了。</p>
<figure class="highlight apache"><table><tr><td class="code"><pre><span class="line"><span class="attribute">vi</span> /etc/netplan/<span class="number">99</span>-netcfg.yaml</span><br></pre></td></tr></table></figure>
<p>以我的文件为例</p>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">network:</span></span><br><span class="line">  <span class="attr">version:</span> <span class="number">2</span></span><br><span class="line">  <span class="attr">renderer:</span> <span class="string">networkd</span></span><br><span class="line">  <span class="attr">ethernets:</span></span><br><span class="line">    <span class="attr">eth0:</span></span><br><span class="line">      <span class="attr">dhcp4:</span> <span class="literal">yes</span></span><br><span class="line">      <span class="attr">mtu:</span> <span class="number">1400</span></span><br><span class="line">      <span class="attr">dhcp6:</span> <span class="literal">no</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>重启后永久生效</p>
<h1 id="Android下的设置方式"><a href="#Android下的设置方式" class="headerlink" title="Android下的设置方式"></a>Android下的设置方式</h1><p>首先需要知道移动数据走的是哪一个网卡</p>
<figure class="highlight ebnf"><table><tr><td class="code"><pre><span class="line"><span class="attribute">ifconfig</span></span><br></pre></td></tr></table></figure>
<p>以我的手机为例</p>
<figure class="highlight apache"><table><tr><td class="code"><pre><span class="line"><span class="attribute">lo</span>        Link encap:Local Loopback  </span><br><span class="line">          <span class="attribute">inet</span> addr:<span class="number">127.0.0.1</span>  Mask:<span class="number">255.0.0.0</span> </span><br><span class="line">          <span class="attribute">inet6</span> addr: ::<span class="number">1</span>/<span class="number">128</span> Scope: Host</span><br><span class="line">          <span class="attribute">UP</span> LOOPBACK RUNNING  MTU:<span class="number">65536</span>  Metric:<span class="number">1</span></span><br><span class="line">          <span class="attribute">RX</span> packets:<span class="number">20080</span> errors:<span class="number">0</span> dropped:<span class="number">0</span> overruns:<span class="number">0</span> frame:<span class="number">0</span> </span><br><span class="line">          <span class="attribute">TX</span> packets:<span class="number">20080</span> errors:<span class="number">0</span> dropped:<span class="number">0</span> overruns:<span class="number">0</span> carrier:<span class="number">0</span> </span><br><span class="line">          <span class="attribute">collisions</span>:<span class="number">0</span> txqueuelen:<span class="number">1</span> </span><br><span class="line">          <span class="attribute">RX</span> bytes:<span class="number">45435532</span> TX bytes:<span class="number">45435532</span> </span><br><span class="line"></span><br><span class="line"><span class="attribute">dummy0</span>    Link encap:Ethernet  HWaddr <span class="number">66</span>:e6:<span class="number">63</span>:<span class="number">4</span>b:<span class="number">93</span>:c8</span><br><span class="line">          <span class="attribute">inet6</span> addr: fe80::<span class="number">64</span>e6:<span class="number">63</span>ff:fe4b:<span class="number">93</span>c8/<span class="number">64</span> Scope: Link</span><br><span class="line">          <span class="attribute">UP</span> BROADCAST RUNNING NOARP  MTU:<span class="number">1500</span>  Metric:<span class="number">1</span></span><br><span class="line">          <span class="attribute">RX</span> packets:<span class="number">0</span> errors:<span class="number">0</span> dropped:<span class="number">0</span> overruns:<span class="number">0</span> frame:<span class="number">0</span> </span><br><span class="line">          <span class="attribute">TX</span> packets:<span class="number">18</span> errors:<span class="number">0</span> dropped:<span class="number">0</span> overruns:<span class="number">0</span> carrier:<span class="number">0</span> </span><br><span class="line">          <span class="attribute">collisions</span>:<span class="number">0</span> txqueuelen:<span class="number">1000</span> </span><br><span class="line">          <span class="attribute">RX</span> bytes:<span class="number">0</span> TX bytes:<span class="number">1260</span> </span><br><span class="line"></span><br><span class="line"><span class="attribute">wlan0</span>     Link encap:Ethernet  HWaddr <span class="number">26</span>:<span class="number">1</span>e:<span class="number">1</span>b:ed:<span class="number">72</span>:f0  Driver icnss</span><br><span class="line">          <span class="attribute">inet</span> addr:<span class="number">192.168.2.146</span>  Bcast:<span class="number">192.168.2.255</span>  Mask:<span class="number">255.255.255.0</span> </span><br><span class="line">          <span class="attribute">inet6</span> addr: fe80::<span class="number">241</span>e:<span class="number">1</span>bff:feed:<span class="number">72</span>f0/<span class="number">64</span> Scope: Link</span><br><span class="line">          <span class="attribute">UP</span> BROADCAST RUNNING MULTICAST  MTU:<span class="number">1500</span>  Metric:<span class="number">1</span></span><br><span class="line">          <span class="attribute">RX</span> packets:<span class="number">513977</span> errors:<span class="number">0</span> dropped:<span class="number">0</span> overruns:<span class="number">0</span> frame:<span class="number">0</span> </span><br><span class="line">          <span class="attribute">TX</span> packets:<span class="number">479613</span> errors:<span class="number">0</span> dropped:<span class="number">0</span> overruns:<span class="number">0</span> carrier:<span class="number">0</span> </span><br><span class="line">          <span class="attribute">collisions</span>:<span class="number">0</span> txqueuelen:<span class="number">3000</span> </span><br><span class="line">          <span class="attribute">RX</span> bytes:<span class="number">367769689</span> TX bytes:<span class="number">87048137</span> </span><br><span class="line"></span><br><span class="line"><span class="attribute">rmnet_data0</span> Link encap:UNSPEC  </span><br><span class="line">          <span class="attribute">inet6</span> addr: fe80::fa03:<span class="number">7</span>b88:<span class="number">43</span>a:a1e/<span class="number">64</span> Scope: Link</span><br><span class="line">          <span class="attribute">UP</span> RUNNING  MTU:<span class="number">2000</span>  Metric:<span class="number">1</span></span><br><span class="line">          <span class="attribute">RX</span> packets:<span class="number">34</span> errors:<span class="number">0</span> dropped:<span class="number">0</span> overruns:<span class="number">0</span> frame:<span class="number">0</span> </span><br><span class="line">          <span class="attribute">TX</span> packets:<span class="number">17</span> errors:<span class="number">0</span> dropped:<span class="number">0</span> overruns:<span class="number">0</span> carrier:<span class="number">0</span> </span><br><span class="line">          <span class="attribute">collisions</span>:<span class="number">0</span> txqueuelen:<span class="number">1000</span> </span><br><span class="line">          <span class="attribute">RX</span> bytes:<span class="number">17154</span> TX bytes:<span class="number">1200</span> </span><br><span class="line"></span><br><span class="line"><span class="attribute">rmnet_ipa0</span> Link encap:UNSPEC  </span><br><span class="line">          <span class="attribute">UP</span> RUNNING  MTU:<span class="number">2000</span>  Metric:<span class="number">1</span></span><br><span class="line">          <span class="attribute">RX</span> packets:<span class="number">116428</span> errors:<span class="number">0</span> dropped:<span class="number">0</span> overruns:<span class="number">0</span> frame:<span class="number">0</span> </span><br><span class="line">          <span class="attribute">TX</span> packets:<span class="number">110877</span> errors:<span class="number">0</span> dropped:<span class="number">0</span> overruns:<span class="number">0</span> carrier:<span class="number">0</span> </span><br><span class="line">          <span class="attribute">collisions</span>:<span class="number">0</span> txqueuelen:<span class="number">1000</span> </span><br><span class="line">          <span class="attribute">RX</span> bytes:<span class="number">178292211</span> TX bytes:<span class="number">15220756</span> </span><br><span class="line"></span><br><span class="line"><span class="attribute">rmnet_data1</span> Link encap:UNSPEC  </span><br><span class="line">          <span class="attribute">inet</span> addr:<span class="number">172.24.3.137</span>  Mask:<span class="number">255.255.255.252</span> </span><br><span class="line">          <span class="attribute">UP</span> RUNNING  MTU:<span class="number">1500</span>  Metric:<span class="number">1</span></span><br><span class="line">          <span class="attribute">RX</span> packets:<span class="number">175319</span> errors:<span class="number">0</span> dropped:<span class="number">0</span> overruns:<span class="number">0</span> frame:<span class="number">0</span> </span><br><span class="line">          <span class="attribute">TX</span> packets:<span class="number">110860</span> errors:<span class="number">0</span> dropped:<span class="number">0</span> overruns:<span class="number">0</span> carrier:<span class="number">0</span> </span><br><span class="line">          <span class="attribute">collisions</span>:<span class="number">0</span> txqueuelen:<span class="number">1000</span> </span><br><span class="line">          <span class="attribute">RX</span> bytes:<span class="number">176170341</span> TX bytes:<span class="number">15219556</span> </span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>可以看到rmnet_data0是没有连接网络的，移动数据在rmnet_data1上，下面修改MTU</p>
<figure class="highlight routeros"><table><tr><td class="code"><pre><span class="line">su<span class="built_in"></span></span><br><span class="line"><span class="built_in">ip </span>link <span class="built_in">set</span> dev rmnet_data1 mtu 1400</span><br></pre></td></tr></table></figure>
<p>或者</p>
<figure class="highlight angelscript"><table><tr><td class="code"><pre><span class="line">su</span><br><span class="line">echo <span class="number">1400</span> &gt; /sys/<span class="keyword">class</span>/<span class="symbol">net</span>/<span class="symbol">rmnet_data1</span>/<span class="symbol">mtu</span></span><br></pre></td></tr></table></figure>
<p>立马生效，不过重启后恢复默认值。<br>嫌麻烦可以修改init.rc,添加一行，永久生效</p>
<figure class="highlight angelscript"><table><tr><td class="code"><pre><span class="line">write /sys/<span class="keyword">class</span>/<span class="symbol">net</span>/<span class="symbol">rmnet_data1</span>/<span class="symbol">mtu</span> <span class="symbol">1400</span></span><br></pre></td></tr></table></figure>

<h1 id="后记"><a href="#后记" class="headerlink" title="后记"></a>后记</h1><p>后来发现服务端上也有报错<code>error: Could not load host key: /etc/ssh/ssh_host_ed25519_key</code></p>
<figure class="highlight awk"><table><tr><td class="code"><pre><span class="line">ssh-keygen -t ed25519 -f <span class="regexp">/etc/</span>ssh/ssh_host_ed25519_key</span><br></pre></td></tr></table></figure>
<p>重新生成密钥之后，多用一段时间再看疗效。</p>
]]></content>
  </entry>
  <entry>
    <title>编译安装Nginx+FancyIndex</title>
    <url>/2019/10/26/Nginx-FancyIndex/</url>
    <content><![CDATA[<p>如果光是满足文件目录的需求有许多方案，如小程序webd，Python的SimpleHTTPServer，NPM的http-server，开源的的FileBrowser，闭源的FileRun…<br>而我选择了一个不上不下的方案，也就是Nginx+FancyIndex模块。优点是可以轻松地实现防盗链和Https的支持。</p>
<span id="more"></span>
<h1 id="编译安装Nginx"><a href="#编译安装Nginx" class="headerlink" title="编译安装Nginx"></a>编译安装Nginx</h1><p>必须要编译时添加FancyIndex模块才可以使用，所以先编译Nginx<br>克隆FancyIndex模块的源码</p>
<figure class="highlight q"><table><tr><td class="code"><pre><span class="line">apt <span class="keyword">update</span> &amp;&amp; sudo apt-<span class="built_in">get</span> install build-essential libtool gcc automake autoconf make libpcre3 libpcre3-<span class="built_in">dev</span> zlib1g-<span class="built_in">dev</span> openssl git libssl-<span class="built_in">dev</span> -y</span><br></pre></td></tr></table></figure>
<figure class="highlight crmsh"><table><tr><td class="code"><pre><span class="line">git <span class="keyword">clone</span> <span class="title">https</span>://github.com/aperezdc/ngx-fancyindex.git ngx-fancyindex</span><br></pre></td></tr></table></figure>
<p>去 <a target="_blank" rel="noopener" href="http://nginx.org/download/">http://nginx.org/download/</a> 下载最新的Nginx源码，后缀为*.tar.gz的才是Linux版本</p>
<figure class="highlight stylus"><table><tr><td class="code"><pre><span class="line">wget http:<span class="comment">//nginx.org/download/nginx-1.29.0.tar.gz</span></span><br><span class="line">tar xvzf nginx-*<span class="selector-class">.tar</span><span class="selector-class">.gz</span> &amp;&amp; rm nginx-*<span class="selector-class">.tar</span><span class="selector-class">.gz</span></span><br><span class="line">cd nginx-*</span><br></pre></td></tr></table></figure>
<p>编译时记得连带将FancyIndex模块添加进去</p>
<figure class="highlight stylus"><table><tr><td class="code"><pre><span class="line">./configure <span class="attr">--prefix</span>=/usr <span class="attr">--sbin-path</span>=/usr/sbin/nginx <span class="attr">--conf-path</span>=/etc/nginx/nginx<span class="selector-class">.conf</span> <span class="attr">--error-log-path</span>=/var/log/nginx_error<span class="selector-class">.log</span> <span class="attr">--http-log-path</span>=/var/log/nginx_access<span class="selector-class">.log</span> <span class="attr">--pid-path</span>=/var/run/nginx<span class="selector-class">.pid</span> <span class="attr">--lock-path</span>=/var/lock/nginx<span class="selector-class">.lock</span> <span class="attr">--user</span>=root <span class="attr">--group</span>=root <span class="attr">--with-http_ssl_module</span> <span class="attr">--without-http_ssi_module</span> <span class="attr">--without-http_memcached_module</span> <span class="attr">--without-http_browser_module</span> <span class="attr">--without-http_geo_module</span>  <span class="attr">--without-http_scgi_module</span>  <span class="attr">--without-http_uwsgi_module</span> <span class="attr">--without-select_module</span> <span class="attr">--with-http_v2_module</span> <span class="attr">--with-http_realip_module</span> <span class="attr">--add-module</span>=../ngx-fancyindex</span><br><span class="line">make</span><br><span class="line">sudo make install</span><br></pre></td></tr></table></figure>
<h1 id="将Nginx添加开机启动"><a href="#将Nginx添加开机启动" class="headerlink" title="将Nginx添加开机启动"></a>将Nginx添加开机启动</h1><figure class="highlight routeros"><table><tr><td class="code"><pre><span class="line">sudo tee /etc/systemd/system/nginx.service &gt;/dev/<span class="literal">null</span> &lt;&lt;<span class="string">&#x27;EOF&#x27;</span></span><br><span class="line">[Unit]</span><br><span class="line"><span class="attribute">Description</span>=nginx</span><br><span class="line"><span class="attribute">After</span>=network.target</span><br><span class="line"></span><br><span class="line">[Service]</span><br><span class="line"><span class="attribute">User</span>=root</span><br><span class="line"><span class="attribute">Type</span>=forking</span><br><span class="line"><span class="attribute">PIDFile</span>=/var/run/nginx.pid</span><br><span class="line"><span class="attribute">ExecStart</span>=/usr/sbin/nginx</span><br><span class="line"><span class="attribute">ExecReload</span>=/usr/sbin/nginx -s reload</span><br><span class="line"><span class="attribute">ExecStop</span>=/usr/sbin/nginx -s stop</span><br><span class="line"><span class="attribute">PrivateTmp</span>=<span class="literal">true</span></span><br><span class="line"></span><br><span class="line">[Install]</span><br><span class="line"><span class="attribute">WantedBy</span>=multi-user.target</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>
<p>将Nginx交给Systemd托管，设置Nginx下次开机启动</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="built_in">sudo</span> systemctl daemon-reload &amp;&amp; <span class="built_in">sudo</span> systemctl <span class="built_in">enable</span> nginx.service</span><br></pre></td></tr></table></figure>
<h1 id="为FancyIndex更换默认主题"><a href="#为FancyIndex更换默认主题" class="headerlink" title="为FancyIndex更换默认主题"></a>为FancyIndex更换默认主题</h1><p>默认的橙色主题是在太丑了，换成一个并没有名字的FancyIndex Theme<br><code>cd</code>到你的站点根目录，如<code>/www/wwwroot</code>，然后克隆这个主题</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">git <span class="built_in">clone</span> https://github.com/467815891a/nginx-fancyindex-theme.git fancyindex</span><br></pre></td></tr></table></figure>
<p>在Nginx站点配置文件的<code>location</code>域中配置FancyIndex，这里直接贴上我Nginx的整个配置文件，以此为例</p>
<figure class="highlight pgsql"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">user</span>  root;</span><br><span class="line">worker_processes  <span class="number">2</span>;</span><br><span class="line"></span><br><span class="line">pid        /var/run/nginx.pid;</span><br><span class="line">error_log /var/<span class="keyword">log</span>/nginx_error.<span class="keyword">log</span>;</span><br><span class="line"></span><br><span class="line">events &#123;</span><br><span class="line">	use epoll;</span><br><span class="line">	worker_connections  <span class="number">1024</span>;</span><br><span class="line">	multi_accept <span class="keyword">on</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">http &#123;</span><br><span class="line">	<span class="keyword">include</span>       mime.<span class="keyword">types</span>;</span><br><span class="line">	default_type  application/octet-stream;</span><br><span class="line">	charset utf<span class="number">-8</span>;</span><br><span class="line">	sendfile <span class="keyword">on</span>;</span><br><span class="line">	tcp_nopush     <span class="keyword">on</span>;</span><br><span class="line">	tcp_nodelay <span class="keyword">on</span>;</span><br><span class="line">	keepalive_timeout  <span class="number">60</span>;</span><br><span class="line">	client_header_buffer_size <span class="number">4</span>k;</span><br><span class="line">	open_file_cache max=<span class="number">102400</span> inactive=<span class="number">20</span>s;</span><br><span class="line">	open_file_cache_valid <span class="number">30</span>s;</span><br><span class="line">	open_file_cache_min_uses <span class="number">1</span>;</span><br><span class="line">	client_header_timeout <span class="number">15</span>;</span><br><span class="line">	client_body_timeout <span class="number">15</span>;</span><br><span class="line">	reset_timedout_connection <span class="keyword">on</span>;</span><br><span class="line">	send_timeout <span class="number">15</span>;</span><br><span class="line">	gzip <span class="keyword">on</span>;</span><br><span class="line">	gzip_disable &quot;msie6&quot;;</span><br><span class="line">	gzip_vary <span class="keyword">on</span>;</span><br><span class="line">	gzip_proxied <span class="keyword">any</span>;</span><br><span class="line">	gzip_comp_level <span class="number">3</span>;</span><br><span class="line">	gzip_buffers <span class="number">16</span> <span class="number">8</span>k;</span><br><span class="line">	gzip_http_version <span class="number">1.1</span>;</span><br><span class="line">	gzip_types <span class="type">text</span>/plain <span class="type">text</span>/css application/<span class="type">json</span> application/javascript <span class="type">text</span>/<span class="type">xml</span> application/<span class="type">xml</span> application/<span class="type">xml</span>+rss <span class="type">text</span>/javascript;</span><br><span class="line">	server_tokens <span class="keyword">off</span>;</span><br><span class="line">	access_log  /var/<span class="keyword">log</span>/nginx_access.<span class="keyword">log</span>;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">server</span> &#123;</span><br><span class="line">		<span class="keyword">listen</span>      <span class="number">443</span> ssl;</span><br><span class="line">		server_name  weiyangbo.com www.weiyangbo.com; #此处填你网站的域名</span><br><span class="line">		#下面两行是你的ssl证书的路径</span><br><span class="line">		ssl_certificate /etc/nginx/cert/xxxxxxx.pem;</span><br><span class="line">		ssl_certificate_key /etc/nginx/cert/xxxxxxx.key;</span><br><span class="line">		ssl_protocols TLSv1 TLSv1<span class="number">.1</span> TLSv1<span class="number">.2</span>;</span><br><span class="line">		ssl_prefer_server_ciphers <span class="keyword">on</span>;</span><br><span class="line">		ssl_session_timeout <span class="number">5</span>m;</span><br><span class="line">		ssl_ciphers  ECDHE-RSA-AES128-GCM-SHA256:ECDHE:ECDH:AES:HIGH:!<span class="keyword">NULL</span>:!aNULL:!MD5:!ADH:!RC4;</span><br><span class="line">		root /www; #此处填你的网站目录</span><br><span class="line">		<span class="keyword">location</span> / &#123;</span><br><span class="line">			expires <span class="number">10</span>h;</span><br><span class="line">			fancyindex <span class="keyword">on</span>;</span><br><span class="line">			fancyindex_exact_size <span class="keyword">off</span>;</span><br><span class="line">			fancyindex_localtime <span class="keyword">on</span>;</span><br><span class="line">			fancyindex_header &quot;/fancyindex/header.html&quot;;</span><br><span class="line">			fancyindex_footer &quot;/fancyindex/footer.html&quot;;</span><br><span class="line">			fancyindex_ignore &quot;fancyindex&quot; &quot;Download&quot;;  #可以自定义文件服务器中不显示的文件或文件夹</span><br><span class="line">			fancyindex_name_length <span class="number">500</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		#这是防盗链设置</span><br><span class="line">		<span class="keyword">location</span> ~*  ^.+\.(jpg|gif|png|img|apk|tar.gz|wmv|jpeg|mp3|mp4|zip|rar)$ &#123;</span><br><span class="line">			valid_referers <span class="keyword">none</span> blocked weiyangbo.com www.weiyangbo.com;</span><br><span class="line">			<span class="keyword">if</span> ($invalid_referer)&#123;</span><br><span class="line">				<span class="keyword">return</span> <span class="number">403</span>;</span><br><span class="line">				break;</span><br><span class="line">			&#125;</span><br><span class="line">			access_log <span class="keyword">off</span>;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	#重定向<span class="number">80</span>端口的全部http请求去https</span><br><span class="line">	<span class="keyword">server</span> &#123;</span><br><span class="line">		<span class="keyword">listen</span> <span class="number">80</span>;</span><br><span class="line">		server_name weiyangbo.com www.weiyangbo.com; #网站域名，跟上面保持一致</span><br><span class="line">		<span class="keyword">return</span> <span class="number">301</span> https://$server_name$request_uri;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h1 id="测试网站"><a href="#测试网站" class="headerlink" title="测试网站"></a>测试网站</h1><p>检测配置文件有无语法错误</p>
<figure class="highlight ebnf"><table><tr><td class="code"><pre><span class="line"><span class="attribute">nginx -t</span></span><br></pre></td></tr></table></figure>
<p>尝试启动Nginx，看看实际效果。</p>
<figure class="highlight ebnf"><table><tr><td class="code"><pre><span class="line"><span class="attribute">nginx</span></span><br></pre></td></tr></table></figure>
<h1 id="定时清理Nginx日志"><a href="#定时清理Nginx日志" class="headerlink" title="定时清理Nginx日志"></a>定时清理Nginx日志</h1><p>Nginx没有日志自动归档或者清除的功能，我们要借助logrotate来定时清理日志，不然如果网页访问量大，没几天日志大小就上GB了，磁盘都不知道怎么爆的</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="built_in">sudo</span> <span class="built_in">tee</span> /etc/logrotate.d/nginx &gt;/dev/null &lt;&lt;<span class="string">&#x27;EOF&#x27;</span></span><br><span class="line">/var/log/nginx_*.<span class="built_in">log</span>  &#123;</span><br><span class="line">su root root</span><br><span class="line">size 10000</span><br><span class="line">daily</span><br><span class="line">rotate 3</span><br><span class="line">missingok</span><br><span class="line">dateext</span><br><span class="line">compress</span><br><span class="line">delaycompress</span><br><span class="line">notifempty</span><br><span class="line">create 640 root root</span><br><span class="line">sharedscripts</span><br><span class="line">postrotate</span><br><span class="line">    <span class="keyword">if</span> [ -f /var/run/nginx.pid ]; <span class="keyword">then</span></span><br><span class="line">       l -USR1 `<span class="built_in">cat</span> /var/run/nginx.pid`</span><br><span class="line">    <span class="keyword">fi</span></span><br><span class="line">endscript</span><br><span class="line">&#125;</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>
<p><code>sudo logrotate /etc/logrotate.d/nginx</code></p>
]]></content>
      <tags>
        <tag>Nginx</tag>
      </tags>
  </entry>
  <entry>
    <title>OrangePi第一次配置</title>
    <url>/2020/03/12/OrangePi-Setup/</url>
    <content><![CDATA[<p>入手了OrangePi Zero玩玩，已经把他做成了智能音箱了，结果不知道怎么回事就突然出问题了。之前一直都是通过WiFi连接SSH服务器来控制OrangePi Zero，现在的情况是WiFi刚连上就死机了。<br>OrangePi Zero已经用胶粘在音箱里了，TF卡可以取出来，但是网口没有空间插网线了。突然想起来手上还有一个CH340（USB转TTL）可以用来连接OrangePi Zero，记录一下不用网线配置OrangePi。<br> <span id="more"></span></p>
<h1 id="烧入Armbian"><a href="#烧入Armbian" class="headerlink" title="烧入Armbian"></a>烧入Armbian</h1><p>官方的Linux镜像已经完全不更新了。还是Armbian好，一直在不断更新，内核也到了5.4<br>下载<a target="_blank" rel="noopener" href="https://www.armbian.com/orange-pi-zero/">OrangePi Zero的镜像</a>，需要注意的是，我强烈推荐Ubuntu版的Armbian，Debian版反应迟缓、经常死机，具体原因不清楚。<br>然后解压，校验镜像<br><code>7z e Armbian_*.7z &amp;&amp; sha256sum --check Armbian_*.img.sha</code><br>接着将SD卡插入电脑，查看SD的分区，如sdX<br><code>lsblk -p</code><br>依次卸载SD卡的所有分区<br><code>sudo umount /dev/sdX*</code><br>等等<br>烧录镜像<br><code>sudo dd bs=4M if=[你解压出来的img文件] of=/dev/sdX conv=fsync</code></p>
<h1 id="TTL连接"><a href="#TTL连接" class="headerlink" title="TTL连接"></a>TTL连接</h1><p>将USB TTL的Tx和Rx分别与OrangePi Zero的Rx和Tx连接起来，插入电脑的USB口。<br>安装并以root身份开启putty<br><code>sudo apt-get install putty</code><br><code>sudo putty</code><br>串口设备选择ttyUSB0，波特率115200,打开串口，然后接通OrangPi Zero的电源，不出意外可以看到串口打印出内核启动的信息了。</p>
<h1 id="连接WiFi"><a href="#连接WiFi" class="headerlink" title="连接WiFi"></a>连接WiFi</h1><p>Armbian默认的root密码是1234,设置好新密码后我们就可以连接wifi了<br><code>nmcli radio wifi on</code><br><code>nmcli d wifi connect YOUR_SSID password YOUR_PASSWROD</code><br>然后我们就可以查看IP地址了<br><code>ifconfig</code><br>尝试SSH连接吧，记得运行<code>armbian-config</code>更换国内软件源</p>
<h1 id="断线重连"><a href="#断线重连" class="headerlink" title="断线重连"></a>断线重连</h1><p>为了防止由于WiFi不稳定造成的断线问题，我们可以利用Crontab每分钟检测WiFi连接情况，判断是否要重新连接。<br><code>sudo crontab -e</code><br>追加一行<br><code>* * * * * ping $(ip route show default | awk &#39;/default/ &#123;print $3&#125;&#39;) -c3 || reboot</code></p>
<h1 id="设置音频输出"><a href="#设置音频输出" class="headerlink" title="设置音频输出"></a>设置音频输出</h1><p>不管是树莓派还是其他Pi，ALSA管理的音频输出一直是我头疼的问题。一方面ALSA的配置极其复杂，各种card，device，asound.conf，.asoundrc让人眼花缭乱；另一方面这些开发板音频口底噪都比较大，如果能在软件方面提高音量，那跟从功放端提高音量相比可以减少噪声输出。<br>对于OrangePi Zero,我赶紧把调好步骤记录下来</p>
<figure class="highlight routeros"><table><tr><td class="code"><pre><span class="line">/usr/bin/amixer -c 0 cset <span class="attribute">numid</span>=3 31</span><br><span class="line">/usr/bin/amixer -c 0 cset <span class="attribute">numid</span>=4 on</span><br><span class="line">/usr/bin/amixer -c 0 cset <span class="attribute">numid</span>=1 63</span><br><span class="line">/usr/bin/amixer -c 0 cset <span class="attribute">numid</span>=10 on</span><br><span class="line">/usr/bin/amixer -c 0 cset <span class="attribute">numid</span>=7 7</span><br><span class="line">/usr/bin/amixer -c 0 cset <span class="attribute">numid</span>=18 on</span><br><span class="line">/usr/bin/amixer -c 0 cset <span class="attribute">numid</span>=8 1</span><br><span class="line">/usr/bin/amixer -c 0 cset <span class="attribute">numid</span>=13 off</span><br><span class="line">/usr/bin/amixer -c 0 cset <span class="attribute">numid</span>=5 7</span><br><span class="line">/usr/bin/amixer -c 0 cset <span class="attribute">numid</span>=19 on</span><br><span class="line">/usr/bin/amixer -c 0 cset <span class="attribute">numid</span>=6 1</span><br><span class="line">/usr/bin/amixer -c 0 cset <span class="attribute">numid</span>=14 off</span><br></pre></td></tr></table></figure>
<p>编辑/etc/asound.conf</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="built_in">sudo</span> <span class="built_in">tee</span> /etc/asound.conf &gt;/dev/null &lt;&lt;<span class="string">&#x27;EOF&#x27;</span></span><br><span class="line"><span class="comment"># the sound card</span></span><br><span class="line">pcm.real &#123;</span><br><span class="line">    <span class="built_in">type</span> hw</span><br><span class="line">    card 0</span><br><span class="line">    device 0</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># software volume</span></span><br><span class="line">pcm.softvol &#123;</span><br><span class="line">    <span class="built_in">type</span> softvol</span><br><span class="line">    slave.pcm <span class="string">&quot;real&quot;</span></span><br><span class="line">    control &#123;</span><br><span class="line">        name <span class="string">&quot;Software&quot;</span></span><br><span class="line">        card 0</span><br><span class="line">    &#125;</span><br><span class="line">    max_dB 40.0</span><br><span class="line">    min_dB -10.0</span><br><span class="line">    resolution 10</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">pcm.mic &#123;</span><br><span class="line">    <span class="built_in">type</span> plug</span><br><span class="line">    slave.pcm <span class="string">&quot;hw:0,0&quot;</span></span><br><span class="line">    slave.format S16_LE</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># default device</span></span><br><span class="line">pcm.!default &#123;</span><br><span class="line">    <span class="built_in">type</span> asym</span><br><span class="line">    playback.pcm <span class="string">&quot;softvol&quot;</span></span><br><span class="line">    capture.pcm <span class="string">&quot;mic&quot;</span></span><br><span class="line">&#125;</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>
<p>接着重启即可，然后测试默认音频输出</p>
<figure class="highlight armasm"><table><tr><td class="code"><pre><span class="line"><span class="symbol">speaker</span>-test  -<span class="built_in">c2</span> -twav</span><br></pre></td></tr></table></figure>
<p>此时应该可以听到轻柔的女声，如果不行就放大招————重装alsa</p>
<figure class="highlight applescript"><table><tr><td class="code"><pre><span class="line">sudo apt-<span class="keyword">get</span> <span class="comment">--purge --reinstall install alsa-base alsa-utils</span></span><br></pre></td></tr></table></figure>
<h1 id="配置硬件看门狗"><a href="#配置硬件看门狗" class="headerlink" title="配置硬件看门狗"></a>配置硬件看门狗</h1><figure class="highlight cmake"><table><tr><td class="code"><pre><span class="line">apt <span class="keyword">install</span> watchdog</span><br></pre></td></tr></table></figure>
<p><code>/etc/watchdog.conf</code>参考如下</p>
<figure class="highlight ini"><table><tr><td class="code"><pre><span class="line"><span class="comment"># Defaults compiled into the binary</span></span><br><span class="line"><span class="attr">temperature-sensor</span> = /sys/class/thermal/thermal_zone0/temp</span><br><span class="line"><span class="attr">max-temperature</span>	= <span class="number">85</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Defaults compiled into the binary</span></span><br><span class="line"><span class="attr">admin</span>			= root</span><br><span class="line"><span class="comment">#Allwinner H2+默认的看门狗timeout是16秒，所以每隔15秒喂一次就可以了</span></span><br><span class="line"><span class="attr">interval</span>		= <span class="number">15</span></span><br><span class="line"><span class="attr">logtick</span>                = <span class="number">1</span></span><br><span class="line"><span class="attr">log-dir</span>		= /var/log/watchdog</span><br><span class="line"></span><br><span class="line"><span class="comment"># This greatly decreases the chance that watchdog won&#x27;t be scheduled before</span></span><br><span class="line"><span class="comment"># your machine is really loaded</span></span><br><span class="line"><span class="attr">realtime</span>		= <span class="literal">yes</span></span><br><span class="line"><span class="attr">priority</span>		= <span class="number">1</span></span><br></pre></td></tr></table></figure>
<p>接着启用watchdog</p>
<figure class="highlight routeros"><table><tr><td class="code"><pre><span class="line">service<span class="built_in"> watchdog </span>start &amp;&amp; systemctl <span class="built_in">enable</span> watchdog</span><br></pre></td></tr></table></figure>

]]></content>
  </entry>
  <entry>
    <title>OpenWrt上使用AutoSSH建立反向代理</title>
    <url>/2020/03/21/SSH-reverse-tunnel-Openwrt/</url>
    <content><![CDATA[<p>丈母娘想让我解决她们家Wifi信号弱的问题，我决定把家里原来唯一的无线路由器变成纯AP，弱电箱里放一个星际宝盒，另外在客厅放一台K2保证全家的Wifi覆盖。<br>本来路由器这种东西设置好了就不会再动了，可是我还需要解决他们家网络电视的问题，网络电视这种东西，直播源很容易失效，感觉以后会涉及到远程维护了。<br>我之前写过<a href="/2019/10/10/SSH-reverse-tunnel/" title="用AutoSSH建立SSH反向隧道">Ubuntu下用Autossh建立反向连接</a>的博文，现在想照搬到OpenWrt上。但是OpenWrt上是用Dropbear作为SSH工具，与OpenSSH有些许不同，记录一下过程。</p>
<span id="more"></span>
<h1 id="前期准备"><a href="#前期准备" class="headerlink" title="前期准备"></a>前期准备</h1><ul>
<li>公网服务器A 开放端口5680(转发ssh连接)，开放端口5681(监听连接状态)，开放端口22，用OpenSSH做SSH服务器</li>
<li>内网机器B OpenWrt with Dropbear</li>
</ul>
<h1 id="修改公网服务器A的SSH配置文件-etc-ssh-sshd-config"><a href="#修改公网服务器A的SSH配置文件-etc-ssh-sshd-config" class="headerlink" title="修改公网服务器A的SSH配置文件/etc/ssh/sshd_config"></a>修改公网服务器A的SSH配置文件<code>/etc/ssh/sshd_config</code></h1><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">GatewayPorts <span class="built_in">yes</span></span><br><span class="line">HostKeyAlgorithms +ssh-rsa</span><br><span class="line">PubkeyAcceptedAlgorithms +ssh-rsa</span><br><span class="line">PubkeyAuthentication <span class="built_in">yes</span></span><br><span class="line">AuthorizedKeysFile .ssh/authorized_keys</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>这样可以把监听的端口绑定到任意IP 0.0.0.0上，否则只有本机127.0.0.1可以访问。<br>添加ssh-rsa算法兼容老板版本dropbear<br>记得重启SSH服务器</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="built_in">sudo</span> service restart sshd</span><br></pre></td></tr></table></figure>
<h1 id="用内网B机器保存公网服务器A的密钥，以便免密连接"><a href="#用内网B机器保存公网服务器A的密钥，以便免密连接" class="headerlink" title="用内网B机器保存公网服务器A的密钥，以便免密连接"></a>用内网B机器保存公网服务器A的密钥，以便免密连接</h1><p>这里就跟OpenSSH不一样了，因为Dropbear没有ssh-id-copy这个命令，而Dropbear的private key又不是以明文方式存储的。</p>
<figure class="highlight awk"><table><tr><td class="code"><pre><span class="line"><span class="comment">#You can get the key using</span></span><br><span class="line">dropbearkey -y -f <span class="regexp">/etc/</span>dropbear<span class="regexp">/dropbear_rsa_host_key | grep &quot;^ssh-rsa &quot; &gt; /</span>etc<span class="regexp">/dropbear/</span>authorized_keys</span><br></pre></td></tr></table></figure>
<p>然后将key从authorized_keys复制添加到到公网服务器的~/.ssh/authorized_keys中</p>
<h1 id="在内网B机器上尝试建立反向代理"><a href="#在内网B机器上尝试建立反向代理" class="headerlink" title="在内网B机器上尝试建立反向代理"></a>在内网B机器上尝试建立反向代理</h1><figure class="highlight apache"><table><tr><td class="code"><pre><span class="line"><span class="comment">#注意Dropbear在建立SSH连接时不会自己带着私钥，需要指定</span></span><br><span class="line"><span class="attribute">ssh</span> -NR <span class="number">5678</span>:<span class="number">127.0.0.1:22</span> 公网服务器A的用户名@公网服务器A的IP -i /etc/dropbear/dropbear_rsa_host_key</span><br></pre></td></tr></table></figure>
<p>正常情况下，不用输入密码，通道即建立成功。 </p>
<ul>
<li>-N：只建立连接，不打开shell  </li>
<li>-R：指定端口映射  </li>
</ul>
<h1 id="AutoSSH-自动重连"><a href="#AutoSSH-自动重连" class="headerlink" title="AutoSSH 自动重连"></a>AutoSSH 自动重连</h1><p>使用SSH的方式不够稳定，使用AutoSSH可以自动在连接断开时自动重连，再把AutoSSH加入系统服务自动启动，则可以做到稳定的连接。</p>
<h2 id="安装AutoSSH"><a href="#安装AutoSSH" class="headerlink" title="安装AutoSSH"></a>安装AutoSSH</h2><figure class="highlight angelscript"><table><tr><td class="code"><pre><span class="line">opkg install <span class="built_in">auto</span>ssh</span><br></pre></td></tr></table></figure>
<h2 id="将AutoSSH添加到开机自启"><a href="#将AutoSSH添加到开机自启" class="headerlink" title="将AutoSSH添加到开机自启"></a>将AutoSSH添加到开机自启</h2><p>注意在OpenWrt里，官方的autossh早就给你准备好了 <code>/etc/init.d/autossh</code> 文件，你只需要在<code>/etc/config/autossh</code>中修改参数即可，下面贴出我的配置</p>
<figure class="highlight gams"><table><tr><td class="code"><pre><span class="line">config autossh</span><br><span class="line">        <span class="keyword">option</span> ssh <span class="string">&#x27;-i /etc/dropbear/dropbear_rsa_host_key -N -T -R 5678:localhost:22 公网服务器A的用户名@公网服务器A的IP&#x27;</span></span><br><span class="line">        <span class="keyword">option</span> gatetime <span class="string">&#x27;0&#x27;</span></span><br><span class="line">        <span class="keyword">option</span> monitorport <span class="string">&#x27;5679&#x27;</span></span><br><span class="line">        <span class="keyword">option</span> poll <span class="string">&#x27;180&#x27;</span></span><br><span class="line">        <span class="keyword">option</span> enabled <span class="string">&#x27;1&#x27;</span></span><br></pre></td></tr></table></figure>

<h2 id="修复Dropbear的一个小bug"><a href="#修复Dropbear的一个小bug" class="headerlink" title="修复Dropbear的一个小bug"></a>修复Dropbear的一个小bug</h2><p>必须要指定HOME目录，详见<a target="_blank" rel="noopener" href="https://github.com/openwrt/packages/issues/5559">Github</a><br>修改<code>/etc/init.d/autossh</code>，添加<code>HOME=/root</code>，全文见下</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="meta">#!/bin/sh /etc/rc.common</span></span><br><span class="line"><span class="comment"># Copyright (C) 2007-2011 OpenWrt.org</span></span><br><span class="line"></span><br><span class="line">START=80</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="title">start_instance</span></span>() &#123;</span><br><span class="line">        <span class="built_in">local</span> section=<span class="string">&quot;<span class="variable">$1</span>&quot;</span></span><br><span class="line"></span><br><span class="line">        config_get ssh <span class="string">&quot;<span class="variable">$section</span>&quot;</span> <span class="string">&#x27;ssh&#x27;</span></span><br><span class="line">        config_get gatetime <span class="string">&quot;<span class="variable">$section</span>&quot;</span> <span class="string">&#x27;gatetime&#x27;</span></span><br><span class="line">        config_get monitorport <span class="string">&quot;<span class="variable">$section</span>&quot;</span> <span class="string">&#x27;monitorport&#x27;</span></span><br><span class="line">        config_get poll <span class="string">&quot;<span class="variable">$section</span>&quot;</span> <span class="string">&#x27;poll&#x27;</span></span><br><span class="line">        config_get_bool enabled <span class="string">&quot;<span class="variable">$section</span>&quot;</span> <span class="string">&#x27;enabled&#x27;</span> <span class="string">&#x27;1&#x27;</span></span><br><span class="line"></span><br><span class="line">        [ <span class="string">&quot;<span class="variable">$enabled</span>&quot;</span> = 1 ] || <span class="built_in">exit</span> 0</span><br><span class="line"></span><br><span class="line">        <span class="built_in">export</span> AUTOSSH_GATETIME=<span class="string">&quot;<span class="variable">$&#123;gatetime:-30&#125;</span>&quot;</span></span><br><span class="line">        <span class="built_in">export</span> AUTOSSH_POLL=<span class="string">&quot;<span class="variable">$&#123;poll:-600&#125;</span>&quot;</span></span><br><span class="line">        <span class="built_in">export</span> HOME=/root</span><br><span class="line">        service_start /usr/sbin/autossh -M <span class="variable">$&#123;monitorport:-20000&#125;</span> -f <span class="variable">$&#123;ssh&#125;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="title">boot</span></span>() &#123;</span><br><span class="line">        <span class="built_in">return</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="title">start</span></span>() &#123;</span><br><span class="line">        config_load <span class="string">&#x27;autossh&#x27;</span></span><br><span class="line">        config_foreach start_instance <span class="string">&#x27;autossh&#x27;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="title">stop</span></span>() &#123;</span><br><span class="line">        service_stop /usr/sbin/autossh</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>然后开机启动Autossh<br><code>/etc/init.d/autossh enable</code></p>
]]></content>
      <tags>
        <tag>openwrt</tag>
      </tags>
  </entry>
  <entry>
    <title>用AutoSSH建立SSH反向隧道</title>
    <url>/2019/10/10/SSH-reverse-tunnel/</url>
    <content><![CDATA[<ul>
<li>公网服务器A 开放端口5678(转发ssh连接)，开放端口5679(监听连接状态)，开放端口22</li>
<li>内网机器B Ubuntu18.04  </li>
</ul>
<p>建立公网服务器A到内网机器B的SSH反向代理，将连接到公网服务器A 5678端口的SSH请求转发给内网机器B的22端口</p>
<span id="more"></span>

<h2 id="修改公网服务器A的SSH配置文件-etc-ssh-sshd-config"><a href="#修改公网服务器A的SSH配置文件-etc-ssh-sshd-config" class="headerlink" title="修改公网服务器A的SSH配置文件/etc/ssh/sshd_config"></a>修改公网服务器A的SSH配置文件<code>/etc/ssh/sshd_config</code></h2><figure class="highlight nginx"><table><tr><td class="code"><pre><span class="line"><span class="attribute">GatewayPorts</span> <span class="literal">yes</span></span><br></pre></td></tr></table></figure>
<p>这样可以把监听的端口绑定到任意IP 0.0.0.0上，否则只有本机127.0.0.1可以访问。<br>记得重启SSH服务器</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="built_in">sudo</span> service restart sshd</span><br></pre></td></tr></table></figure>
<h2 id="用内网B机器保存公网服务器A的密钥，以便免密连接"><a href="#用内网B机器保存公网服务器A的密钥，以便免密连接" class="headerlink" title="用内网B机器保存公网服务器A的密钥，以便免密连接"></a>用内网B机器保存公网服务器A的密钥，以便免密连接</h2><figure class="highlight applescript"><table><tr><td class="code"><pre><span class="line">ssh-<span class="keyword">copy</span>-<span class="built_in">id</span> [公网服务器A的用户名]@[公网服务器A的IP]</span><br></pre></td></tr></table></figure>
<h2 id="在内网B机器上尝试建立反向代理"><a href="#在内网B机器上尝试建立反向代理" class="headerlink" title="在内网B机器上尝试建立反向代理"></a>在内网B机器上尝试建立反向代理</h2><figure class="highlight dns"><table><tr><td class="code"><pre><span class="line">ssh -NR <span class="number">5678:127.0</span>.<span class="number">0</span>.<span class="number">1</span>:<span class="number">22</span> 公网服务器<span class="keyword">A</span>的用户名@公网服务器<span class="keyword">A</span>的IP</span><br></pre></td></tr></table></figure>
<p>正常情况下，不用输入密码，通道即建立成功。 </p>
<ul>
<li>-N：只建立连接，不打开shell  </li>
<li>-R：指定端口映射  </li>
</ul>
<h1 id="AutoSSH-自动重连"><a href="#AutoSSH-自动重连" class="headerlink" title="AutoSSH 自动重连"></a>AutoSSH 自动重连</h1><p>使用SSH的方式不够稳定，使用AutoSSH可以自动在连接断开时自动重连，再把AutoSSH加入系统服务自动启动，则可以做到稳定的连接。</p>
<h2 id="安装AutoSSH"><a href="#安装AutoSSH" class="headerlink" title="安装AutoSSH"></a>安装AutoSSH</h2><figure class="highlight routeros"><table><tr><td class="code"><pre><span class="line">sudo apt-<span class="built_in">get</span> install -y autossh</span><br></pre></td></tr></table></figure>
<h2 id="将AutoSSH添加到开机自启"><a href="#将AutoSSH添加到开机自启" class="headerlink" title="将AutoSSH添加到开机自启"></a>将AutoSSH添加到开机自启</h2><p>需要创建一个 <code>/etc/systemd/system/autossh.service</code> 文件</p>
<figure class="highlight routeros"><table><tr><td class="code"><pre><span class="line">sudo tee /etc/systemd/system/autossh.service &gt;/dev/<span class="literal">null</span> &lt;&lt;<span class="string">&#x27;EOF&#x27;</span></span><br><span class="line">[Unit]</span><br><span class="line"><span class="attribute">Description</span>=AutoSSH<span class="built_in"> service </span><span class="keyword">for</span> remote tunnel</span><br><span class="line"><span class="attribute">After</span>=network-online.target</span><br><span class="line"></span><br><span class="line">[Service]</span><br><span class="line"><span class="attribute">User</span>=内网机器B的用户名</span><br><span class="line"><span class="attribute">ExecStart</span>=/usr/bin/autossh -M 5679 -N -o <span class="string">&quot;StrictHostKeyChecking=false&quot;</span> -o <span class="string">&quot;ServerAliveInterval 60&quot;</span> -o <span class="string">&quot;ServerAliveCountMax 3&quot;</span> -R 5678:localhost:22 公网服务器A的用户名@公网服务A的IP</span><br><span class="line"><span class="attribute">Restart</span>=always</span><br><span class="line"><span class="attribute">RestartSec</span>=3</span><br><span class="line"></span><br><span class="line">[Install]</span><br><span class="line"><span class="attribute">WantedBy</span>=multi-user.target</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>
<p>将AutoSSH交给Systemd托管，设置立即启动并下次开机自启</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="built_in">sudo</span> systemctl daemon-reload &amp;&amp; <span class="built_in">sudo</span> systemctl start autossh &amp;&amp; <span class="built_in">sudo</span> systemctl <span class="built_in">enable</span> autossh.service</span><br></pre></td></tr></table></figure>
<p>autossh相关参数说明</p>
<ul>
<li>-M: 5679 选项指定中继服务器上的监视端口，用于交换监视 SSH 会话的测试数据，需要保证该端口在服务器上未被占用。 </li>
<li>-o: 用于设置 autossh 参数。 </li>
<li>-f:指定 autossh 在后台运行，并不会传给 ssh。和 ssh 的 -f 不一样，autossh 指定 -f 时将无法寻求密码。指定 -f 时，会将环境变量 AUTOSSH_GATETIME 覆盖为 0！ </li>
<li>-N：只建立连接，不打开shell   </li>
<li>-R：指定端口映射  </li>
</ul>
]]></content>
  </entry>
  <entry>
    <title>Trojan+Nginx实现HTTP+TLS伪装代理</title>
    <url>/2020/02/28/Trojan/</url>
    <content><![CDATA[<p>我之前写过<a href="/2019/12/08/V2ray/" title="V2ray+Nginx实现WebSocket+TLS伪装代理">V2ray+Nginx实现WebSocket+TLS伪装代理</a>的博文，用了几个月，效果不错的。本来不准备更换方案，但是我发现MT7621主控的路由器跑V2ray最高就8Mbps左右的速度，电脑上可以跑到30Mbps。很明显路由器成为了瓶颈。相对于Golang写的V2ray，用C写的Trojan明显应该可以消耗更少的资源，于是有了更换Trojan的想法。</p>
<span id="more"></span>
<h1 id="安装Trojan和Nginx"><a href="#安装Trojan和Nginx" class="headerlink" title="安装Trojan和Nginx"></a>安装Trojan和Nginx</h1><p>参考以下两个链接分别安装Nginx和Trojan，其中Trojan是在客户端和在服务器上都要安装的，跟SS不同，Trojan服务端和客户端是一体的。Nginx只需服务器安装就可以了。<br> <a target="_blank" rel="noopener" href="https://github.com/trojan-gfw/trojan-quickstart">Trojan官方Linux下安装指南</a><br>我之前写过<a href="/2019/10/26/Nginx-FancyIndex/" title="编译安装Nginx+FancyIndex">编译安装和配置Nginx</a>的博文</p>
<h1 id="服务端设置"><a href="#服务端设置" class="headerlink" title="服务端设置"></a>服务端设置</h1><p>网上所有的方案就是让Trojan监听443端口，然后将识别出的正常网页流量转发到Nginx，这样无疑会降低访问正常网页的速度。但是想想我的网站也没多少访问量，而且这样应该会提升科学上网的速度，符合我的初衷，于是就开干了。<br>Nginx配置</p>
<figure class="highlight applescript"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line">user  root;</span><br><span class="line">worker_processes  <span class="number">2</span>;</span><br><span class="line"></span><br><span class="line">pid        /var/<span class="built_in">run</span>/nginx.pid;</span><br><span class="line">error_log /var/<span class="built_in">log</span>/nginx_error.<span class="built_in">log</span>;</span><br><span class="line"></span><br><span class="line">events &#123;</span><br><span class="line">	use epoll;</span><br><span class="line">	worker_connections  <span class="number">1024</span>;</span><br><span class="line">	multi_accept <span class="keyword">on</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">http &#123;</span><br><span class="line">	include       mime.types;</span><br><span class="line">	default_type  <span class="built_in">application</span>/octet-stream;</span><br><span class="line">	charset utf<span class="number">-8</span>;</span><br><span class="line">	sendfile <span class="keyword">on</span>;</span><br><span class="line">	tcp_nopush     <span class="keyword">on</span>;</span><br><span class="line">	tcp_nodelay <span class="keyword">on</span>;</span><br><span class="line">	keepalive_timeout  <span class="number">60</span>;</span><br><span class="line">	client_header_buffer_size <span class="number">4</span>k;</span><br><span class="line">	open_file_cache max=<span class="number">102400</span> inactive=<span class="number">20</span>s;</span><br><span class="line">	open_file_cache_valid <span class="number">30</span>s;</span><br><span class="line">	open_file_cache_min_uses <span class="number">1</span>;</span><br><span class="line">	client_header_timeout <span class="number">15</span>;</span><br><span class="line">	client_body_timeout <span class="number">15</span>;</span><br><span class="line">	reset_timedout_connection <span class="keyword">on</span>;</span><br><span class="line">	send_timeout <span class="number">15</span>;</span><br><span class="line">	gzip <span class="keyword">on</span>;</span><br><span class="line">	gzip_disable <span class="string">&quot;msie6&quot;</span>;</span><br><span class="line">	gzip_vary <span class="keyword">on</span>;</span><br><span class="line">	gzip_proxied any;</span><br><span class="line">	gzip_comp_level <span class="number">3</span>;</span><br><span class="line">	gzip_buffers <span class="number">16</span> <span class="number">8</span>k;</span><br><span class="line">	gzip_http_version <span class="number">1.1</span>;</span><br><span class="line">	gzip_types <span class="built_in">text</span>/plain <span class="built_in">text</span>/css <span class="built_in">application</span>/json <span class="built_in">application</span>/javascript <span class="built_in">text</span>/xml <span class="built_in">application</span>/xml <span class="built_in">application</span>/xml+rss <span class="built_in">text</span>/javascript;</span><br><span class="line">	server_tokens off;</span><br><span class="line">	access_log  /var/<span class="built_in">log</span>/nginx_access.<span class="built_in">log</span>;</span><br><span class="line"></span><br><span class="line">	server &#123;</span><br><span class="line"><span class="comment">#		listen      443 ssl;</span></span><br><span class="line">		listen      <span class="number">0.0</span><span class="number">.0</span><span class="number">.0</span>:<span class="number">80</span>;</span><br><span class="line">		server_name  weiyangbo.com www.weiyangbo.com; <span class="comment">#此处填你网站的域名</span></span><br><span class="line">		<span class="comment">#让Nginx让出443端口，只监听80,ssl设置也不需要了，一切交给Trojan</span></span><br><span class="line"><span class="comment">#		ssl_certificate /etc/nginx/cert/xxxxxxx.pem;</span></span><br><span class="line"><span class="comment">#		ssl_certificate_key /etc/nginx/cert/xxxxxxx.key;</span></span><br><span class="line"><span class="comment">#		ssl_protocols TLSv1 TLSv1.1 TLSv1.2;</span></span><br><span class="line"><span class="comment">#		ssl_prefer_server_ciphers on;</span></span><br><span class="line"><span class="comment">#		ssl_session_timeout 5m;</span></span><br><span class="line"><span class="comment">#		ssl_ciphers  ECDHE-RSA-AES128-GCM-SHA256:ECDHE:ECDH:AES:HIGH:!NULL:!aNULL:!MD5:!ADH:!RC4;</span></span><br><span class="line">		root /www; <span class="comment">#此处填你的网站目录</span></span><br><span class="line">		location / &#123;</span><br><span class="line">			expires <span class="number">10</span>h;</span><br><span class="line">			fancyindex <span class="keyword">on</span>;</span><br><span class="line">			fancyindex_exact_size off;</span><br><span class="line">			fancyindex_localtime <span class="keyword">on</span>;</span><br><span class="line">			fancyindex_header <span class="string">&quot;/fancyindex/header.html&quot;</span>;</span><br><span class="line">			fancyindex_footer <span class="string">&quot;/fancyindex/footer.html&quot;</span>;</span><br><span class="line">			fancyindex_ignore <span class="string">&quot;fancyindex&quot;</span> <span class="string">&quot;Download&quot;</span>;  <span class="comment">#可以自定义文件服务器中不显示的文件或文件夹</span></span><br><span class="line">			fancyindex_name_length <span class="number">500</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="comment">#这是防盗链设置</span></span><br><span class="line">		location ~*  ^.+\.(jpg|gif|png|img|apk|tar.gz|wmv|jpeg|mp3|mp4|zip|rar)$ &#123;</span><br><span class="line">			valid_referers none blocked www.weiyangbo.com weiyangbo.com;</span><br><span class="line">			<span class="keyword">if</span> ($invalid_referer)&#123;</span><br><span class="line"><span class="built_in">				return</span> <span class="number">403</span>;</span><br><span class="line">				break;</span><br><span class="line">			&#125;</span><br><span class="line">			access_log off;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Nginx配置写完之后可以用<code>nginx -t</code>命令检查一下Nginx的配置文件有没有语法错误。然后<code>nginx -s reload</code>重启Nginx。</p>
<p>还有Trojan的服务端配置，默认在<code>/usr/local/etc/trojan/config.json</code></p>
<figure class="highlight json"><table><tr><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;run_type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;server&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;local_addr&quot;</span><span class="punctuation">:</span> <span class="string">&quot;0.0.0.0&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;local_port&quot;</span><span class="punctuation">:</span> <span class="number">443</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;remote_addr&quot;</span><span class="punctuation">:</span> <span class="string">&quot;127.0.0.1&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;remote_port&quot;</span><span class="punctuation">:</span> <span class="number">80</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;password&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">        <span class="string">&quot;填你的密码&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="string">&quot;可以填多个&quot;</span></span><br><span class="line">    <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;log_level&quot;</span><span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;ssl&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;cert&quot;</span><span class="punctuation">:</span> <span class="string">&quot;/etc/nginx/cert/xxxxxxx.pem&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;key&quot;</span><span class="punctuation">:</span> <span class="string">&quot;/etc/nginx/cert/xxxxxxx.key&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;key_password&quot;</span><span class="punctuation">:</span> <span class="string">&quot;&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;cipher&quot;</span><span class="punctuation">:</span> <span class="string">&quot;ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-CHACHA20-POLY1305:ECDHE-RSA-CHACHA20-POLY1305&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;cipher_tls13&quot;</span><span class="punctuation">:</span> <span class="string">&quot;TLS_AES_128_GCM_SHA256:TLS_CHACHA20_POLY1305_SHA256:TLS_AES_256_GCM_SHA384&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;prefer_server_cipher&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;alpn&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">            <span class="string">&quot;http/1.1&quot;</span></span><br><span class="line">        <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;reuse_session&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;session_ticket&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;session_timeout&quot;</span><span class="punctuation">:</span> <span class="number">600</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;plain_http_response&quot;</span><span class="punctuation">:</span> <span class="string">&quot;&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;curves&quot;</span><span class="punctuation">:</span> <span class="string">&quot;&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;dhparam&quot;</span><span class="punctuation">:</span> <span class="string">&quot;&quot;</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;tcp&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;prefer_ipv4&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;no_delay&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;keep_alive&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;reuse_port&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;fast_open&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;fast_open_qlen&quot;</span><span class="punctuation">:</span> <span class="number">20</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;mysql&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;enabled&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;server_addr&quot;</span><span class="punctuation">:</span> <span class="string">&quot;127.0.0.1&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;server_port&quot;</span><span class="punctuation">:</span> <span class="number">3306</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;database&quot;</span><span class="punctuation">:</span> <span class="string">&quot;trojan&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;username&quot;</span><span class="punctuation">:</span> <span class="string">&quot;trojan&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;password&quot;</span><span class="punctuation">:</span> <span class="string">&quot;&quot;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>
<p>确认配置文件填好之后，可以尝试启动Trojan<br><code>sudo systemctl start trojan</code><br>如果没有报错应该是启动成功了，也可以<code>sudo systemctl status trojan</code>检查一下。<br>测试没有问题就可以加入开机自启了<br><code>sudo systemctl enable trojan</code></p>
<h1 id="客户端配置"><a href="#客户端配置" class="headerlink" title="客户端配置"></a>客户端配置</h1><p>略</p>
<h1 id="总结与后记"><a href="#总结与后记" class="headerlink" title="总结与后记"></a>总结与后记</h1><p>测试下来非常失望，在路由器上科学上网的的速度仅仅比V2ray好上一点点，原来正常网页的访问速度却是明显降低了。<del>可能是我路由器真的该淘汰了。</del>后来进一步测试发现是由于路由器上开起了BBR拥塞算法导致的，取消之后立马可以跑到30Mbps（服务器上限）。</p>
]]></content>
      <tags>
        <tag>Nginx</tag>
        <tag>梯子</tag>
      </tags>
  </entry>
  <entry>
    <title>Ubuntu优化指南</title>
    <url>/2019/10/10/Ubuntu_optimization/</url>
    <content><![CDATA[<p>记录一下Ubuntu系统安装完成后的一些自定义设置</p>
<span id="more"></span>
<h1 id="解决与Windows双系统时时区问题"><a href="#解决与Windows双系统时时区问题" class="headerlink" title="解决与Windows双系统时时区问题"></a>解决与Windows双系统时时区问题</h1><p>先保证Ubuntu下的时间是北京时间</p>
<figure class="highlight brainfuck"><table><tr><td class="code"><pre><span class="line"><span class="comment">sudo hwclock</span> <span class="literal">--</span><span class="comment">localtime</span> <span class="literal">--</span><span class="comment">systohc</span></span><br></pre></td></tr></table></figure>
<p>问题解决</p>
<h1 id="自定义Vi编辑器"><a href="#自定义Vi编辑器" class="headerlink" title="自定义Vi编辑器"></a>自定义Vi编辑器</h1><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="built_in">sudo</span> nano /etc/vim/vimrc</span><br></pre></td></tr></table></figure>
<p>添加如下</p>
<figure class="highlight vim"><table><tr><td class="code"><pre><span class="line"><span class="comment">&quot;语法高亮</span></span><br><span class="line"><span class="comment">&quot;syntax on</span></span><br><span class="line"><span class="comment">&quot;显示行号</span></span><br><span class="line"><span class="keyword">set</span> <span class="keyword">nu</span></span><br><span class="line"><span class="comment">&quot;修改默认注释颜色</span></span><br><span class="line"><span class="keyword">hi</span> Comment ctermfg=DarkCyan</span><br><span class="line"></span><br><span class="line"><span class="keyword">set</span> nocompatible</span><br><span class="line"><span class="comment">&quot;允许退格键删除</span></span><br><span class="line"><span class="keyword">set</span> backspace=<span class="number">2</span></span><br><span class="line"><span class="comment">&quot;启用鼠标</span></span><br><span class="line"><span class="comment">&quot;set mouse=a</span></span><br><span class="line"><span class="comment">&quot;set selection=exclusive</span></span><br><span class="line"><span class="comment">&quot;set selectmode=mouse,key</span></span><br><span class="line"><span class="comment">&quot;侦测文件类型</span></span><br><span class="line"><span class="keyword">filetype</span> <span class="keyword">on</span></span><br><span class="line"><span class="comment">&quot;载入文件类型插件</span></span><br><span class="line"><span class="keyword">filetype</span> plugin <span class="keyword">on</span></span><br><span class="line"><span class="comment">&quot;为特定文件类型载入相关缩进文件</span></span><br><span class="line"><span class="keyword">filetype</span> <span class="built_in">indent</span> <span class="keyword">on</span></span><br><span class="line"><span class="comment">&quot;设置编码自动识别, 中文引号显示</span></span><br><span class="line"><span class="keyword">set</span> fileencodings=utf-<span class="number">8</span>,gbk</span><br><span class="line"><span class="comment">&quot;set encoding=euc-cn</span></span><br><span class="line"><span class="keyword">set</span> ambiwidth=double</span><br><span class="line"><span class="comment">&quot;设置高亮搜索</span></span><br><span class="line"><span class="keyword">set</span> hlsearch</span><br><span class="line"><span class="comment">&quot;在搜索时，输入的词句的逐字符高亮</span></span><br><span class="line"><span class="keyword">set</span> incsearch</span><br><span class="line"><span class="comment">&quot;按C语言格式缩进</span></span><br><span class="line"><span class="keyword">set</span> <span class="built_in">cindent</span></span><br><span class="line"><span class="comment">&quot;设置Tab长度为4格</span></span><br><span class="line"><span class="keyword">set</span> tabstop=<span class="number">4</span></span><br><span class="line"><span class="comment">&quot;设置自动缩进长度为4格</span></span><br><span class="line"><span class="keyword">set</span> <span class="built_in">shiftwidth</span>=<span class="number">4</span></span><br><span class="line"><span class="comment">&quot;继承前一行的缩进方式，特别适用于多行注释</span></span><br><span class="line"><span class="comment">&quot;set autoindent</span></span><br><span class="line"><span class="comment">&quot;显示括号匹配</span></span><br><span class="line"><span class="keyword">set</span> showmatch</span><br><span class="line"><span class="comment">&quot;括号匹配显示时间为1(单位是十分之一秒)</span></span><br><span class="line"><span class="keyword">set</span> matchtime=<span class="number">1</span></span><br><span class="line"><span class="comment">&quot;增强模式中的命令行自动完成操作</span></span><br><span class="line"><span class="keyword">set</span> wildmenu</span><br><span class="line"><span class="comment">&quot;不要生成swap文件，当buffer被丢弃的时候隐藏它</span></span><br><span class="line"><span class="keyword">setlocal</span> noswapfile</span><br><span class="line"><span class="keyword">set</span> bufhidden=<span class="keyword">hide</span></span><br></pre></td></tr></table></figure>

<h1 id="etc-sysctl-conf"><a href="#etc-sysctl-conf" class="headerlink" title="/etc/sysctl.conf"></a>/etc/sysctl.conf</h1><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="built_in">sudo</span> vi /etc/sysctl.conf</span><br></pre></td></tr></table></figure>
<p>按照如下方式修改</p>
<figure class="highlight ini"><table><tr><td class="code"><pre><span class="line"><span class="comment">#swappiness</span></span><br><span class="line"><span class="attr">vm.swappiness</span>=<span class="number">0</span></span><br><span class="line"><span class="comment"># max open files</span></span><br><span class="line"><span class="attr">fs.file-max</span> = <span class="number">51200</span></span><br><span class="line"><span class="comment"># max read buffer</span></span><br><span class="line"><span class="attr">net.core.rmem_max</span> = <span class="number">67108864</span></span><br><span class="line"><span class="comment"># max write buffer</span></span><br><span class="line"><span class="attr">net.core.wmem_max</span> = <span class="number">67108864</span></span><br><span class="line"><span class="comment"># default read buffer</span></span><br><span class="line"><span class="attr">net.core.rmem_default</span> = <span class="number">65536</span></span><br><span class="line"><span class="comment"># default write buffer</span></span><br><span class="line"><span class="attr">net.core.wmem_default</span> = <span class="number">65536</span></span><br><span class="line"><span class="comment"># max processor input queue</span></span><br><span class="line"><span class="attr">net.core.netdev_max_backlog</span> = <span class="number">4096</span></span><br><span class="line"><span class="comment"># max backlog</span></span><br><span class="line"><span class="attr">net.core.somaxconn</span> = <span class="number">4096</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># resist SYN flood attacks</span></span><br><span class="line"><span class="attr">net.ipv4.tcp_syncookies</span> = <span class="number">1</span></span><br><span class="line"><span class="comment"># reuse timewait sockets when safe</span></span><br><span class="line"><span class="attr">net.ipv4.tcp_tw_reuse</span> = <span class="number">1</span></span><br><span class="line"><span class="comment"># turn off fast timewait sockets recycling</span></span><br><span class="line"><span class="comment">#net.ipv4.tcp_tw_recycle = 0</span></span><br><span class="line"><span class="comment"># short FIN timeout</span></span><br><span class="line"><span class="attr">net.ipv4.tcp_fin_timeout</span> = <span class="number">30</span></span><br><span class="line"><span class="comment"># short keepalive time</span></span><br><span class="line"><span class="attr">net.ipv4.tcp_keepalive_time</span> = <span class="number">1200</span></span><br><span class="line"><span class="comment"># outbound port range</span></span><br><span class="line"><span class="attr">net.ipv4.ip_local_port_range</span> = <span class="number">10000</span> <span class="number">65000</span></span><br><span class="line"><span class="comment"># max SYN backlog</span></span><br><span class="line"><span class="attr">net.ipv4.tcp_max_syn_backlog</span> = <span class="number">4096</span></span><br><span class="line"><span class="comment"># max timewait sockets held by system simultaneously</span></span><br><span class="line"><span class="attr">net.ipv4.tcp_max_tw_buckets</span> = <span class="number">5000</span></span><br><span class="line"><span class="comment"># turn on TCP Fast Open on both client and server side</span></span><br><span class="line"><span class="attr">net.ipv4.tcp_fastopen</span> = <span class="number">3</span></span><br><span class="line"><span class="comment"># TCP receive buffer</span></span><br><span class="line"><span class="attr">net.ipv4.tcp_rmem</span> = <span class="number">4096</span> <span class="number">87380</span> <span class="number">67108864</span></span><br><span class="line"><span class="comment"># TCP write buffer</span></span><br><span class="line"><span class="attr">net.ipv4.tcp_wmem</span> = <span class="number">4096</span> <span class="number">65536</span> <span class="number">67108864</span></span><br><span class="line"><span class="comment"># turn on path MTU discovery</span></span><br><span class="line"><span class="attr">net.ipv4.tcp_mtu_probing</span> = <span class="number">1</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># for high-latency network</span></span><br><span class="line"><span class="comment">#net.ipv4.tcp_congestion_control = hybla</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># for low-latency network, use cubic instead</span></span><br><span class="line"><span class="comment"># net.ipv4.tcp_congestion_control = cubic</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#for kernel version &gt;= 4.9</span></span><br><span class="line"><span class="attr">net.core.default_qdisc</span>=fq</span><br><span class="line"><span class="attr">net.ipv4.tcp_congestion_control</span>=bbr</span><br></pre></td></tr></table></figure>

<h1 id="开启rc-local支持"><a href="#开启rc-local支持" class="headerlink" title="开启rc.local支持"></a>开启rc.local支持</h1><h2 id="1-开启服务之前，要首先添加-Install-域"><a href="#1-开启服务之前，要首先添加-Install-域" class="headerlink" title="1.开启服务之前，要首先添加[Install]域"></a>1.开启服务之前，要首先添加[Install]域</h2><p>方法一(懒人法)：</p>
<figure class="highlight swift"><table><tr><td class="code"><pre><span class="line">echo <span class="operator">-</span>e <span class="string">&quot;<span class="subst">\n</span><span class="subst">\n</span>[Install]<span class="subst">\n</span>WantedBy=multi-user.target<span class="subst">\n</span>Alias=rc-local.service&quot;</span> <span class="operator">|</span> sudo tee <span class="operator">-</span>a <span class="regexp">/etc/</span>systemd<span class="regexp">/system/</span>rc<span class="operator">-</span>local.service</span><br></pre></td></tr></table></figure>
<p>方法二(手动添加)：</p>
<figure class="highlight awk"><table><tr><td class="code"><pre><span class="line">sudo vi <span class="regexp">/etc/</span>systemd<span class="regexp">/system/</span>rc-local.service</span><br></pre></td></tr></table></figure>
<p>在末尾添加如下内容  </p>
<figure class="highlight ini"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line"><span class="section">[Install]</span></span><br><span class="line"><span class="attr">WantedBy</span>=multi-user.target</span><br><span class="line"><span class="attr">Alias</span>=rc-local.service</span><br></pre></td></tr></table></figure>

<h2 id="2-设置rc-local服务开启"><a href="#2-设置rc-local服务开启" class="headerlink" title="2.设置rc.local服务开启"></a>2.设置rc.local服务开启</h2><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="built_in">sudo</span> systemctl <span class="built_in">enable</span> rc-local</span><br></pre></td></tr></table></figure>

<h2 id="3-接下来就创建属于我们的-etc-rc-local脚本吧"><a href="#3-接下来就创建属于我们的-etc-rc-local脚本吧" class="headerlink" title="3.接下来就创建属于我们的/etc/rc.local脚本吧"></a>3.接下来就创建属于我们的/etc/rc.local脚本吧</h2><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="built_in">sudo</span> <span class="built_in">touch</span> /etc/rc.local</span><br><span class="line"><span class="built_in">chmod</span> 755 /etc/rc.local</span><br><span class="line"><span class="built_in">sudo</span> <span class="built_in">echo</span> <span class="string">&quot;#!/bin/bash&quot;</span> &gt; /etc/rc.local</span><br><span class="line"><span class="built_in">sudo</span> vi /etc/rc.local</span><br></pre></td></tr></table></figure>

<h1 id="设置SWAP"><a href="#设置SWAP" class="headerlink" title="设置SWAP"></a>设置SWAP</h1><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="built_in">sudo</span> fallocate -l 8G /swapfile</span><br><span class="line"><span class="built_in">sudo</span> mkswap  /swapfile</span><br><span class="line"><span class="built_in">sudo</span> <span class="built_in">chmod</span> 600  /swapfile</span><br><span class="line"><span class="built_in">sudo</span> swapon /swapfile</span><br><span class="line">swapon  -s</span><br></pre></td></tr></table></figure>
<p>加入fstab以便永久生效</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="built_in">echo</span> -e <span class="string">&quot;\n/swapfile swap swap defaults 0 0&quot;</span> | <span class="built_in">sudo</span> <span class="built_in">tee</span> -a /etc/fstab</span><br></pre></td></tr></table></figure>

]]></content>
  </entry>
  <entry>
    <title>V2ray+Nginx实现WebSocket+TLS伪装代理</title>
    <url>/2019/12/08/V2ray/</url>
    <content><![CDATA[<p>相比于SS，V2ray设置太麻烦了，对于移动端来说太耗电，对于硬路由来说性能开销太大。但是现在要干扰SS实在太简单，所以不得不未雨绸缪了。花了很大的功夫才利用V2ray+Nginx配置好WebSocket+TLS，同时不影响原来的网站。将V2ray藏在Nginx后面，使用 TLS 加密流量，看起来更像HTTPS。<br> <span id="more"></span></p>
<h1 id="安装V2ray和Nginx"><a href="#安装V2ray和Nginx" class="headerlink" title="安装V2ray和Nginx"></a>安装V2ray和Nginx</h1><p>参考以下两个链接分别安装Nginx和V2ray，其中V2ray是在客户端和服务器上都要安装的，跟SS不同，V2ray不分服务端和客户端。Nginx只需服务器安装就可以了。<br> <a target="_blank" rel="noopener" href="https://toutyrater.github.io/prep/install.html">V2ray官方Linux下安装指南</a><br>我之前写过<a href="/2019/10/26/Nginx-FancyIndex/" title="编译安装Nginx+FancyIndex">编译安装和配置Nginx</a>的博文</p>
<h1 id="服务端设置"><a href="#服务端设置" class="headerlink" title="服务端设置"></a>服务端设置</h1><p>官方的教程说得已经很清楚了，Nginx的配置和V2ray的配置都提到了，可以先做个参考 <a target="_blank" rel="noopener" href="https://toutyrater.github.io/advanced/wss_and_web.html#websockettlsweb">V2ray官方白话文配置教程</a><br>服务器上的配置我跟官方差不多，直接贴出配置。<br>Nginx配置</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line">user  root;</span><br><span class="line">worker_processes  2;</span><br><span class="line"></span><br><span class="line">pid        /var/run/nginx.pid;</span><br><span class="line">error_log /var/log/nginx_error.log;</span><br><span class="line"></span><br><span class="line">events &#123;</span><br><span class="line">	use epoll;</span><br><span class="line">	worker_connections  1024;</span><br><span class="line">	multi_accept on;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">http &#123;</span><br><span class="line">	include       mime.types;</span><br><span class="line">	default_type  application/octet-stream;</span><br><span class="line">	charset utf-8;</span><br><span class="line">	sendfile on;</span><br><span class="line">	tcp_nopush     on;</span><br><span class="line">	tcp_nodelay on;</span><br><span class="line">	keepalive_timeout  60;</span><br><span class="line">	client_header_buffer_size 4k;</span><br><span class="line">	open_file_cache max=102400 inactive=20s;</span><br><span class="line">	open_file_cache_valid 30s;</span><br><span class="line">	open_file_cache_min_uses 1;</span><br><span class="line">	client_header_timeout 15;</span><br><span class="line">	client_body_timeout 15;</span><br><span class="line">	reset_timedout_connection on;</span><br><span class="line">	send_timeout 15;</span><br><span class="line">	gzip on;</span><br><span class="line">	gzip_disable <span class="string">&quot;msie6&quot;</span>;</span><br><span class="line">	gzip_vary on;</span><br><span class="line">	gzip_proxied any;</span><br><span class="line">	gzip_comp_level 3;</span><br><span class="line">	gzip_buffers 16 8k;</span><br><span class="line">	gzip_http_version 1.1;</span><br><span class="line">	gzip_types text/plain text/css application/json application/javascript text/xml application/xml application/xml+rss text/javascript;</span><br><span class="line">	server_tokens off;</span><br><span class="line">	access_log  /var/log/nginx_access.log;</span><br><span class="line"></span><br><span class="line">	server &#123;</span><br><span class="line">		listen      443 ssl;</span><br><span class="line">		server_name  weiyangbo.com www.weiyangbo.com; <span class="comment">#此处填你网站的域名</span></span><br><span class="line">		<span class="comment">#下面两行是你的ssl证书的路径</span></span><br><span class="line">		ssl_certificate /etc/nginx/cert/xxxxxxx.pem;</span><br><span class="line">		ssl_certificate_key /etc/nginx/cert/xxxxxxx.key;</span><br><span class="line">		ssl_protocols TLSv1 TLSv1.1 TLSv1.2;</span><br><span class="line">		ssl_prefer_server_ciphers on;</span><br><span class="line">		ssl_session_timeout 5m;</span><br><span class="line">		ssl_ciphers  ECDHE-RSA-AES128-GCM-SHA256:ECDHE:ECDH:AES:HIGH:!NULL:!aNULL:!MD5:!ADH:!RC4;</span><br><span class="line">		root /www; <span class="comment">#此处填你的网站目录</span></span><br><span class="line">		location / &#123;</span><br><span class="line">			expires 10h;</span><br><span class="line">			fancyindex on;</span><br><span class="line">			fancyindex_exact_size off;</span><br><span class="line">			fancyindex_localtime on;</span><br><span class="line">			fancyindex_header <span class="string">&quot;/fancyindex/header.html&quot;</span>;</span><br><span class="line">			fancyindex_footer <span class="string">&quot;/fancyindex/footer.html&quot;</span>;</span><br><span class="line">			fancyindex_ignore <span class="string">&quot;fancyindex&quot;</span> <span class="string">&quot;Download&quot;</span>;  <span class="comment">#可以自定义文件服务器中不显示的文件或文件夹</span></span><br><span class="line">			fancyindex_name_length 500;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="comment">#这是防盗链设置</span></span><br><span class="line">		location ~*  ^.+\.(jpg|gif|png|img|apk|tar.gz|wmv|jpeg|mp3|mp4|zip|rar)$ &#123;</span><br><span class="line">			valid_referers none blocked www.weiyangbo.com weiyangbo.com;</span><br><span class="line">			<span class="keyword">if</span> (<span class="variable">$invalid_referer</span>)&#123;</span><br><span class="line">				<span class="built_in">return</span> 403;</span><br><span class="line">				<span class="built_in">break</span>;</span><br><span class="line">			&#125;</span><br><span class="line">			access_log off;</span><br><span class="line">		&#125;</span><br><span class="line">		location /v2ray/ &#123; <span class="comment">#这一段就是用于V2ray的反向代理</span></span><br><span class="line">			proxy_redirect off;</span><br><span class="line">			proxy_pass http://127.0.0.1:10000;</span><br><span class="line">			proxy_http_version 1.1;</span><br><span class="line">			proxy_set_header Upgrade <span class="variable">$http_upgrade</span>;</span><br><span class="line">			proxy_set_header Connection <span class="string">&quot;upgrade&quot;</span>;</span><br><span class="line">			proxy_set_header Host <span class="variable">$http_host</span>;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">#重定向80端口的全部http请求去https</span></span><br><span class="line">	server &#123;</span><br><span class="line">		listen 80;</span><br><span class="line">		server_name weiyangbo.com www.weiyangbo.com; <span class="comment">#网站域名，跟上面保持一致</span></span><br><span class="line">		<span class="built_in">return</span> 301 https://$server_name<span class="variable">$request_uri</span>;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Nginx配置写完之后可以用<code>nginx -t</code>命令检查一下Nginx的配置文件有没有语法错误。然后<code>nginx -s reload</code>重启Nginx。<br>还有V2ray的服务端配置，默认在<code>/etc/v2ray/config.json</code></p>
<figure class="highlight prolog"><table><tr><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;log&quot;</span> : &#123;</span><br><span class="line">   <span class="string">&quot;access&quot;</span>: <span class="string">&quot;/var/log/v2ray/access.log&quot;</span>,</span><br><span class="line">   <span class="string">&quot;error&quot;</span>: <span class="string">&quot;/var/log/v2ray/error.log&quot;</span>,</span><br><span class="line">   <span class="string">&quot;loglevel&quot;</span>: <span class="string">&quot;warning&quot;</span></span><br><span class="line"> &#125;,</span><br><span class="line">  <span class="string">&quot;inbound&quot;</span>: &#123;</span><br><span class="line">   <span class="string">&quot;port&quot;</span>: <span class="number">10000</span>,</span><br><span class="line">   <span class="string">&quot;listen&quot;</span>: <span class="string">&quot;127.0.0.1&quot;</span>,</span><br><span class="line">   <span class="string">&quot;protocol&quot;</span>: <span class="string">&quot;vmess&quot;</span>,</span><br><span class="line">   <span class="string">&quot;settings&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;clients&quot;</span>: [</span><br><span class="line">     &#123;</span><br><span class="line">      <span class="string">&quot;id&quot;</span>: <span class="string">&quot;8335737e-124e-4935-818a-31501e43c819&quot;</span>,</span><br><span class="line">	  <span class="string">&quot;alterId&quot;</span>: <span class="number">64</span></span><br><span class="line">	 &#125;</span><br><span class="line">   ]</span><br><span class="line">  &#125;,</span><br><span class="line">   <span class="string">&quot;streamSettings&quot;</span>:</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="string">&quot;network&quot;</span>: <span class="string">&quot;ws&quot;</span>,</span><br><span class="line">    <span class="string">&quot;wsSettings&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;path&quot;</span>: <span class="string">&quot;/v2ray/&quot;</span></span><br><span class="line">   &#125;</span><br><span class="line">  &#125;</span><br><span class="line"> &#125;,</span><br><span class="line">  <span class="string">&quot;outbound&quot;</span>: &#123;</span><br><span class="line">   <span class="string">&quot;protocol&quot;</span>: <span class="string">&quot;freedom&quot;</span>,</span><br><span class="line">   <span class="string">&quot;settings&quot;</span>: &#123;&#125;</span><br><span class="line"> &#125;,</span><br><span class="line">  <span class="string">&quot;outboundDetour&quot;</span>: [</span><br><span class="line">   &#123;</span><br><span class="line">    <span class="string">&quot;protocol&quot;</span>: <span class="string">&quot;blackhole&quot;</span>,</span><br><span class="line">    <span class="string">&quot;settings&quot;</span>: &#123;</span><br><span class="line">   &#125;,</span><br><span class="line">    <span class="string">&quot;tag&quot;</span>: <span class="string">&quot;blocked&quot;</span></span><br><span class="line">  &#125;</span><br><span class="line"> ],</span><br><span class="line">  <span class="string">&quot;routing&quot;</span>: &#123;</span><br><span class="line">   <span class="string">&quot;strategy&quot;</span>: <span class="string">&quot;rules&quot;</span>,</span><br><span class="line">   <span class="string">&quot;settings&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;rules&quot;</span>: [</span><br><span class="line">     &#123;</span><br><span class="line">      <span class="string">&quot;type&quot;</span>: <span class="string">&quot;field&quot;</span>,</span><br><span class="line">      <span class="string">&quot;ip&quot;</span>: [</span><br><span class="line">       <span class="string">&quot;0.0.0.0/8&quot;</span>,</span><br><span class="line">       <span class="string">&quot;10.0.0.0/8&quot;</span>,</span><br><span class="line">       <span class="string">&quot;100.64.0.0/10&quot;</span>,</span><br><span class="line">       <span class="string">&quot;127.0.0.0/8&quot;</span>,</span><br><span class="line">       <span class="string">&quot;169.254.0.0/16&quot;</span>,</span><br><span class="line">       <span class="string">&quot;172.16.0.0/12&quot;</span>,</span><br><span class="line">       <span class="string">&quot;192.0.0.0/24&quot;</span>,</span><br><span class="line">       <span class="string">&quot;192.0.2.0/24&quot;</span>,</span><br><span class="line">       <span class="string">&quot;192.168.0.0/16&quot;</span>,</span><br><span class="line">       <span class="string">&quot;198.18.0.0/15&quot;</span>,</span><br><span class="line">       <span class="string">&quot;198.51.100.0/24&quot;</span>,</span><br><span class="line">       <span class="string">&quot;203.0.113.0/24&quot;</span>,</span><br><span class="line">       <span class="string">&quot;::1/128&quot;</span>,</span><br><span class="line">       <span class="string">&quot;fc00::/7&quot;</span>,</span><br><span class="line">       <span class="string">&quot;fe80::/10&quot;</span></span><br><span class="line">     ],</span><br><span class="line">      <span class="string">&quot;outboundTag&quot;</span>: <span class="string">&quot;blocked&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">   ]</span><br><span class="line">  &#125;</span><br><span class="line"> &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>V2ray配置完之后可以用命令<code>/usr/bin/v2ray/v2ray -test /etc/v2ray/config.json</code>命令检查V2ray的配置文件是否有语法错误。接着用<code>systemctl start v2ray</code>来启动。<br>需要注意的是：<br>1、Nginx配置里面的<code>location</code>字段必须和V2ray中的<code>path</code>一模一样，连“/”也不可以省略。<br>2、Nginx配置里面的<code>proxy_pass</code>后面的端口，必须保持和V2ray中的<code>port</code>一致，同时注意SElinux是否允许Nginx做转发。</p>
<h1 id="客户端配置"><a href="#客户端配置" class="headerlink" title="客户端配置"></a>客户端配置</h1><p>我在官方的基础上做了较大改动，参考了Kitsunebi大神的<a target="_blank" rel="noopener" href="https://medium.com/@TachyonDevel/%E6%BC%AB%E8%B0%88%E5%90%84%E7%A7%8D%E9%BB%91%E7%A7%91%E6%8A%80%E5%BC%8F-dns-%E6%8A%80%E6%9C%AF%E5%9C%A8%E4%BB%A3%E7%90%86%E7%8E%AF%E5%A2%83%E4%B8%AD%E7%9A%84%E5%BA%94%E7%94%A8-62c50e58cbd0">这篇帖子</a>，在客户端实现了自动分流（绕过国内IP）和DNS防投毒。下面直接贴出我的配置</p>
<figure class="highlight prolog"><table><tr><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;inbounds&quot;</span>: [</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="string">&quot;port&quot;</span>: <span class="number">1080</span>,</span><br><span class="line">      <span class="string">&quot;listen&quot;</span>: <span class="string">&quot;127.0.0.1&quot;</span>,</span><br><span class="line">      <span class="string">&quot;protocol&quot;</span>: <span class="string">&quot;socks&quot;</span>,</span><br><span class="line">      <span class="string">&quot;sniffing&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;enabled&quot;</span>: true,</span><br><span class="line">        <span class="string">&quot;destOverride&quot;</span>: [</span><br><span class="line">          <span class="string">&quot;http&quot;</span>,</span><br><span class="line">          <span class="string">&quot;tls&quot;</span></span><br><span class="line">        ]</span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="string">&quot;settings&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;auth&quot;</span>: <span class="string">&quot;noauth&quot;</span>,</span><br><span class="line">        <span class="string">&quot;udp&quot;</span>: false</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  ],</span><br><span class="line">  <span class="string">&quot;outbounds&quot;</span>: [</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="string">&quot;protocol&quot;</span>: <span class="string">&quot;vmess&quot;</span>,</span><br><span class="line">      <span class="string">&quot;settings&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;vnext&quot;</span>: [</span><br><span class="line">          &#123;</span><br><span class="line">            <span class="string">&quot;address&quot;</span>: <span class="string">&quot;weiyangbo.com&quot;</span>,</span><br><span class="line">            <span class="string">&quot;port&quot;</span>: <span class="number">443</span>,</span><br><span class="line">            <span class="string">&quot;users&quot;</span>: [</span><br><span class="line">              &#123;</span><br><span class="line">                <span class="string">&quot;id&quot;</span>: <span class="string">&quot;8335737e-124e-4935-818a-31501e43c819&quot;</span>,</span><br><span class="line">                <span class="string">&quot;alterId&quot;</span>: <span class="number">64</span>,</span><br><span class="line">                <span class="string">&quot;security&quot;</span>: <span class="string">&quot;auto&quot;</span></span><br><span class="line">              &#125;</span><br><span class="line">            ]</span><br><span class="line">          &#125;</span><br><span class="line">        ]</span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="string">&quot;streamSettings&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;network&quot;</span>: <span class="string">&quot;ws&quot;</span>,</span><br><span class="line">        <span class="string">&quot;security&quot;</span>: <span class="string">&quot;tls&quot;</span>,</span><br><span class="line">        <span class="string">&quot;tlsSettings&quot;</span>: &#123;</span><br><span class="line">          <span class="string">&quot;serverName&quot;</span>: <span class="string">&quot;weiyangbo.com&quot;</span></span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="string">&quot;wsSettings&quot;</span>: &#123;</span><br><span class="line">          <span class="string">&quot;path&quot;</span>: <span class="string">&quot;/v2ray/&quot;</span></span><br><span class="line">        &#125;</span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="string">&quot;tag&quot;</span>: <span class="string">&quot;proxy&quot;</span></span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="string">&quot;protocol&quot;</span>: <span class="string">&quot;freedom&quot;</span>,</span><br><span class="line">      <span class="string">&quot;settings&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;domainStrategy&quot;</span>: <span class="string">&quot;UseIP&quot;</span></span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="string">&quot;streamSettings&quot;</span>: &#123;&#125;,</span><br><span class="line">      <span class="string">&quot;tag&quot;</span>: <span class="string">&quot;direct&quot;</span></span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="string">&quot;protocol&quot;</span>: <span class="string">&quot;blackhole&quot;</span>,</span><br><span class="line">      <span class="string">&quot;settings&quot;</span>: &#123;&#125;,</span><br><span class="line">      <span class="string">&quot;tag&quot;</span>: <span class="string">&quot;block&quot;</span></span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="string">&quot;protocol&quot;</span>: <span class="string">&quot;dns&quot;</span>,</span><br><span class="line">      <span class="string">&quot;tag&quot;</span>: <span class="string">&quot;dns-out&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">  ],</span><br><span class="line">  <span class="string">&quot;dns&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;clientIp&quot;</span>: <span class="string">&quot;115.239.211.92&quot;</span>,</span><br><span class="line">    <span class="string">&quot;hosts&quot;</span>: &#123;</span><br><span class="line">      <span class="string">&quot;localhost&quot;</span>: <span class="string">&quot;127.0.0.1&quot;</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="string">&quot;servers&quot;</span>: [</span><br><span class="line">      <span class="string">&quot;114.114.114.114&quot;</span>,</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="string">&quot;address&quot;</span>: <span class="string">&quot;8.8.8.8&quot;</span>,</span><br><span class="line">        <span class="string">&quot;domains&quot;</span>: [</span><br><span class="line">          <span class="string">&quot;google&quot;</span>,</span><br><span class="line">          <span class="string">&quot;android&quot;</span>,</span><br><span class="line">          <span class="string">&quot;fbcdn&quot;</span>,</span><br><span class="line">          <span class="string">&quot;facebook&quot;</span>,</span><br><span class="line">          <span class="string">&quot;domain:fb.com&quot;</span>,</span><br><span class="line">          <span class="string">&quot;instagram&quot;</span>,</span><br><span class="line">          <span class="string">&quot;whatsapp&quot;</span>,</span><br><span class="line">          <span class="string">&quot;akamai&quot;</span>,</span><br><span class="line">          <span class="string">&quot;domain:line-scdn.net&quot;</span>,</span><br><span class="line">          <span class="string">&quot;domain:line.me&quot;</span>,</span><br><span class="line">          <span class="string">&quot;domain:naver.jp&quot;</span></span><br><span class="line">        ],</span><br><span class="line">        <span class="string">&quot;port&quot;</span>: <span class="number">53</span></span><br><span class="line">      &#125;</span><br><span class="line">    ]</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="string">&quot;log&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;loglevel&quot;</span>: <span class="string">&quot;warning&quot;</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="string">&quot;policy&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;levels&quot;</span>: &#123;</span><br><span class="line">      <span class="string">&quot;0&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;bufferSize&quot;</span>: <span class="number">4096</span>,</span><br><span class="line">        <span class="string">&quot;connIdle&quot;</span>: <span class="number">30</span>,</span><br><span class="line">        <span class="string">&quot;downlinkOnly&quot;</span>: <span class="number">0</span>,</span><br><span class="line">        <span class="string">&quot;handshake&quot;</span>: <span class="number">4</span>,</span><br><span class="line">        <span class="string">&quot;uplinkOnly&quot;</span>: <span class="number">0</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="string">&quot;routing&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;domainStrategy&quot;</span>: <span class="string">&quot;IPIfNonMatch&quot;</span>,</span><br><span class="line">    <span class="string">&quot;rules&quot;</span>: [</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="string">&quot;inboundTag&quot;</span>: [</span><br><span class="line">          <span class="string">&quot;tun2socks&quot;</span></span><br><span class="line">        ],</span><br><span class="line">        <span class="string">&quot;network&quot;</span>: <span class="string">&quot;udp&quot;</span>,</span><br><span class="line">        <span class="string">&quot;port&quot;</span>: <span class="number">53</span>,</span><br><span class="line">        <span class="string">&quot;outboundTag&quot;</span>: <span class="string">&quot;dns-out&quot;</span>,</span><br><span class="line">        <span class="string">&quot;type&quot;</span>: <span class="string">&quot;field&quot;</span></span><br><span class="line">      &#125;,</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="string">&quot;domain&quot;</span>: [</span><br><span class="line">          <span class="string">&quot;domain:setup.icloud.com&quot;</span></span><br><span class="line">        ],</span><br><span class="line">        <span class="string">&quot;outboundTag&quot;</span>: <span class="string">&quot;proxy&quot;</span>,</span><br><span class="line">        <span class="string">&quot;type&quot;</span>: <span class="string">&quot;field&quot;</span></span><br><span class="line">      &#125;,</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="string">&quot;ip&quot;</span>: [</span><br><span class="line">          <span class="string">&quot;8.8.8.8/32&quot;</span>,</span><br><span class="line">          <span class="string">&quot;8.8.4.4/32&quot;</span>,</span><br><span class="line">          <span class="string">&quot;1.1.1.1/32&quot;</span>,</span><br><span class="line">          <span class="string">&quot;1.0.0.1/32&quot;</span>,</span><br><span class="line">          <span class="string">&quot;9.9.9.9/32&quot;</span>,</span><br><span class="line">          <span class="string">&quot;149.112.112.112/32&quot;</span>,</span><br><span class="line">          <span class="string">&quot;208.67.222.222/32&quot;</span>,</span><br><span class="line">          <span class="string">&quot;208.67.220.220/32&quot;</span></span><br><span class="line">        ],</span><br><span class="line">        <span class="string">&quot;outboundTag&quot;</span>: <span class="string">&quot;proxy&quot;</span>,</span><br><span class="line">        <span class="string">&quot;type&quot;</span>: <span class="string">&quot;field&quot;</span></span><br><span class="line">      &#125;,</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="string">&quot;ip&quot;</span>: [</span><br><span class="line">          <span class="string">&quot;geoip:cn&quot;</span>,</span><br><span class="line">          <span class="string">&quot;geoip:private&quot;</span></span><br><span class="line">        ],</span><br><span class="line">        <span class="string">&quot;outboundTag&quot;</span>: <span class="string">&quot;direct&quot;</span>,</span><br><span class="line">        <span class="string">&quot;type&quot;</span>: <span class="string">&quot;field&quot;</span></span><br><span class="line">      &#125;,</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="string">&quot;outboundTag&quot;</span>: <span class="string">&quot;direct&quot;</span>,</span><br><span class="line">        <span class="string">&quot;port&quot;</span>: <span class="string">&quot;123&quot;</span>,</span><br><span class="line">        <span class="string">&quot;type&quot;</span>: <span class="string">&quot;field&quot;</span></span><br><span class="line">      &#125;,</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="string">&quot;domain&quot;</span>: [</span><br><span class="line">          <span class="string">&quot;domain:pstatp.com&quot;</span>,</span><br><span class="line">          <span class="string">&quot;domain:snssdk.com&quot;</span>,</span><br><span class="line">          <span class="string">&quot;domain:toutiao.com&quot;</span>,</span><br><span class="line">          <span class="string">&quot;domain:ixigua.com&quot;</span>,</span><br><span class="line">          <span class="string">&quot;domain:apple.com&quot;</span>,</span><br><span class="line">          <span class="string">&quot;domain:crashlytics.com&quot;</span>,</span><br><span class="line">          <span class="string">&quot;domain:icloud.com&quot;</span>,</span><br><span class="line">          <span class="string">&quot;cctv&quot;</span>,</span><br><span class="line">          <span class="string">&quot;umeng&quot;</span>,</span><br><span class="line">          <span class="string">&quot;domain:weico.cc&quot;</span>,</span><br><span class="line">          <span class="string">&quot;domain:jd.com&quot;</span>,</span><br><span class="line">          <span class="string">&quot;domain:360buy.com&quot;</span>,</span><br><span class="line">          <span class="string">&quot;domain:360buyimg.com&quot;</span>,</span><br><span class="line">          <span class="string">&quot;domain:douyu.tv&quot;</span>,</span><br><span class="line">          <span class="string">&quot;domain:douyu.com&quot;</span>,</span><br><span class="line">          <span class="string">&quot;domain:douyucdn.cn&quot;</span>,</span><br><span class="line">          <span class="string">&quot;geosite:cn&quot;</span></span><br><span class="line">        ],</span><br><span class="line">        <span class="string">&quot;outboundTag&quot;</span>: <span class="string">&quot;direct&quot;</span>,</span><br><span class="line">        <span class="string">&quot;type&quot;</span>: <span class="string">&quot;field&quot;</span></span><br><span class="line">      &#125;,</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="string">&quot;ip&quot;</span>: [</span><br><span class="line">          <span class="string">&quot;149.154.167.0/24&quot;</span>,</span><br><span class="line">          <span class="string">&quot;149.154.175.0/24&quot;</span>,</span><br><span class="line">          <span class="string">&quot;91.108.56.0/24&quot;</span>,</span><br><span class="line">          <span class="string">&quot;125.209.222.0/24&quot;</span></span><br><span class="line">        ],</span><br><span class="line">        <span class="string">&quot;outboundTag&quot;</span>: <span class="string">&quot;proxy&quot;</span>,</span><br><span class="line">        <span class="string">&quot;type&quot;</span>: <span class="string">&quot;field&quot;</span></span><br><span class="line">      &#125;,</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="string">&quot;domain&quot;</span>: [</span><br><span class="line">          <span class="string">&quot;twitter&quot;</span>,</span><br><span class="line">          <span class="string">&quot;domain:twimg.com&quot;</span>,</span><br><span class="line">          <span class="string">&quot;domain:t.co&quot;</span>,</span><br><span class="line">          <span class="string">&quot;google&quot;</span>,</span><br><span class="line">          <span class="string">&quot;domain:ggpht.com&quot;</span>,</span><br><span class="line">          <span class="string">&quot;domain:gstatic.com&quot;</span>,</span><br><span class="line">          <span class="string">&quot;domain:youtube.com&quot;</span>,</span><br><span class="line">          <span class="string">&quot;domain:ytimg.com&quot;</span>,</span><br><span class="line">          <span class="string">&quot;pixiv&quot;</span>,</span><br><span class="line">          <span class="string">&quot;domain:pximg.net&quot;</span>,</span><br><span class="line">          <span class="string">&quot;tumblr&quot;</span>,</span><br><span class="line">          <span class="string">&quot;instagram&quot;</span>,</span><br><span class="line">          <span class="string">&quot;domain:line-scdn.net&quot;</span>,</span><br><span class="line">          <span class="string">&quot;domain:line.me&quot;</span>,</span><br><span class="line">          <span class="string">&quot;domain:naver.jp&quot;</span>,</span><br><span class="line">          <span class="string">&quot;domain:facebook.com&quot;</span>,</span><br><span class="line">          <span class="string">&quot;domain:fbcdn.net&quot;</span>,</span><br><span class="line">          <span class="string">&quot;pinterest&quot;</span>,</span><br><span class="line">          <span class="string">&quot;github&quot;</span>,</span><br><span class="line">          <span class="string">&quot;dropbox&quot;</span>,</span><br><span class="line">          <span class="string">&quot;netflix&quot;</span>,</span><br><span class="line">          <span class="string">&quot;domain:medium.com&quot;</span>,</span><br><span class="line">          <span class="string">&quot;domain:fivecdm.com&quot;</span></span><br><span class="line">        ],</span><br><span class="line">        <span class="string">&quot;outboundTag&quot;</span>: <span class="string">&quot;proxy&quot;</span>,</span><br><span class="line">        <span class="string">&quot;type&quot;</span>: <span class="string">&quot;field&quot;</span></span><br><span class="line">      &#125;</span><br><span class="line">    ],</span><br><span class="line">    <span class="string">&quot;strategy&quot;</span>: <span class="string">&quot;rules&quot;</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>需要注意的是：<br>客户端配置需要注意在<code>outbounds</code>里面的<code>protocol</code>、<code>settings</code>、 <code>streamSettings</code>三个字段下的所有值必须和服务器端一致，不然连不上。不过有一个例外，那就是<code>settings</code>下的<code>security</code>，因为v2ray的加密算法是客户端与服务器协商的，服务器没有强制，客户端可以随意，我这里填的是<code>auto</code>。<br>V2ray配置完之后可以用命令<code>/usr/bin/v2ray/v2ray -test /etc/v2ray/config.json</code>命令检查是否有语法错误。接着用<code>systemctl start v2ray</code>来启动。</p>
<h1 id="使用-amp-测试"><a href="#使用-amp-测试" class="headerlink" title="使用&amp;测试"></a>使用&amp;测试</h1><p>用<code>ps auxw | grep v2ray</code>分别检查服务器和客户端（本地）的v2ray是否正常运行。既可以在网络代理中设置系统代理，也可以在本地终端设置socksv5代理(仅在当前终端有效)：</p>
<figure class="highlight routeros"><table><tr><td class="code"><pre><span class="line"><span class="built_in">export</span> <span class="attribute">http_proxy</span>=<span class="string">&quot;socks5://127.0.0.1:1080&quot;</span></span><br><span class="line"><span class="built_in">export</span> <span class="attribute">https_proxy</span>=<span class="string">&quot;socks5://127.0.0.1:1080&quot;</span></span><br></pre></td></tr></table></figure>
<p>可以用curl检测你当前的访问外网IP</p>
<figure class="highlight armasm"><table><tr><td class="code"><pre><span class="line"><span class="symbol">curl</span> <span class="built_in">ip</span>.sb</span><br></pre></td></tr></table></figure>
<p>根据curl返回的结果，可以判断代理是否设置正确。<br>1、如果返回的是本地计算机的外网IP，说明你的本地socksv5代理设置没有生效。<br>2、如果返回HTTP错误代码（404或者400之类的），检查Nginx与V2ray服务端的设置，也可以找找Nginx的日志找找线索。<br>3、当然返回服务器的外网IP是最好的情况。</p>
<h1 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h1><p>V2ray配置虽然麻烦，但是相较于SS优势明显<br>1、隐蔽性好。虽然道高一尺，魔高一丈，但是目前来说V2ray这种方法还是不容易被干扰的。<br>2、由于V2ray内建了DNS服务器和路由功能，不需要像SS那样配置路由表和安装额外的DNS服务器，算是一个一揽子解决方案。而且V2ray的socksv5代理支持转发DNS查询到内建的DNS服务器（明显SS并不支持转发DNS结果），可以直接将V2ray的socksv5代理设置为系统代理，上游DNS服务器不需要改动，国内域名还是国内DNS解析并且直连，国外域名用国外DNS服务器的解析结果并且走代理。</p>
]]></content>
      <tags>
        <tag>Nginx</tag>
        <tag>梯子</tag>
      </tags>
  </entry>
  <entry>
    <title>Docker使用Aria2容器</title>
    <url>/2024/01/28/aria2-docker/</url>
    <content><![CDATA[<h1 id="参考链接"><a href="#参考链接" class="headerlink" title="参考链接"></a>参考链接</h1><p>Github<br><a target="_blank" rel="noopener" href="https://github.com/P3TERX/Aria2-Pro-Docker">https://github.com/P3TERX/Aria2-Pro-Docker</a><br>进阶说明<br><a target="_blank" rel="noopener" href="https://p3terx.com/archives/docker-aria2-pro.html">Aria2 Pro - 更好用的 Aria2 Docker 容器镜像</a></p>
<h1 id="我的配置文件"><a href="#我的配置文件" class="headerlink" title="我的配置文件"></a>我的配置文件</h1><p>我的<code>docker-compose</code></p>
<figure class="highlight nestedtext"><table><tr><td class="code"><pre><span class="line"><span class="attribute">version</span><span class="punctuation">:</span> <span class="string">&quot;3.8&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="attribute">services</span><span class="punctuation">:</span></span><br><span class="line"><span class="punctuation"></span></span><br><span class="line">  <span class="attribute">Aria2-Pro</span><span class="punctuation">:</span></span><br><span class="line">    <span class="attribute">container_name</span><span class="punctuation">:</span> <span class="string">aria2-pro</span></span><br><span class="line">    <span class="attribute">image</span><span class="punctuation">:</span> <span class="string">p3terx/aria2-pro</span></span><br><span class="line">    <span class="attribute">environment</span><span class="punctuation">:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">PUID=65534</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">PGID=65534</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">UMASK_SET=022</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">RPC_SECRET=yourpassword</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">RPC_PORT=6800</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">LISTEN_PORT=6888</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">DISK_CACHE=64M</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">IPV6_MODE=true</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">UPDATE_TRACKERS=true</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">CUSTOM_TRACKER_URL=</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">TZ=Asia/Shanghai</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">SPECIAL_MODE=move</span></span><br><span class="line">    <span class="attribute">volumes</span><span class="punctuation">:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">$&#123;PWD&#125;/aria2-config:/config</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">/mnt/sata/.tmp:/downloads</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">/mnt/sata:/completed</span></span><br><span class="line"></span><br><span class="line">    <span class="attribute">network_mode</span><span class="punctuation">:</span> <span class="string">host</span></span><br><span class="line">    <span class="attribute">restart</span><span class="punctuation">:</span> <span class="string">unless-stopped</span></span><br><span class="line">    <span class="attribute">logging</span><span class="punctuation">:</span></span><br><span class="line">      <span class="attribute">driver</span><span class="punctuation">:</span> <span class="string">json-file</span></span><br><span class="line">      <span class="attribute">options</span><span class="punctuation">:</span></span><br><span class="line">        <span class="attribute">max-size</span><span class="punctuation">:</span> <span class="string">1m</span></span><br></pre></td></tr></table></figure>
<h1 id="修正一个小bug"><a href="#修正一个小bug" class="headerlink" title="修正一个小bug"></a>修正一个小bug</h1><p>修改<code>aria2-config/script.conf</code>第23行为<code>dest-dir=/completed</code></p>
]]></content>
  </entry>
  <entry>
    <title>利用SU-03T和ESP32自制语音控制节点</title>
    <url>/2022/03/06/Voice-control-node/</url>
    <content><![CDATA[<p>传统智能音箱的缺点：</p>
<ul>
<li>成本高，严重依赖各家生态，各家生态互不兼容，用户一旦入坑就只能一条路走到黑。</li>
<li>执行一条语音命令需要先语音唤醒，效率低，影响使用心情。</li>
<li>智能音箱一直联网监听，隐私风险大。</li>
</ul>
<p>下面先来看看我制作的语音控制节点，不管是识别率，识别速度，识别距离都是令人满意的，而且不光可以控制接入Home Assistant的智能家电，还可以控制各种红外遥控的传统家电。</p>

<style type="text/css"> .aspect-ratio { position: relative; width: 100%; height: 0; padding-bottom: 75%; } .aspect-ratio iframe { position: absolute; width: 100%; height: 100%; left: 0; top: 0; } </style>
<div class="aspect-ratio" ><iframe src="//player.bilibili.com/player.html?aid=594535271&bvid=BV1rq4y147cQ&cid=543226313&page=1" scrolling="no" border="0" frameborder="no" framespacing="0" allowfullscreen="true"> </iframe></div>


<p>之所以叫做“语音控制节点”是因为目前这个手工焊接的版本实在是太过简陋，实在不像是一个“音箱”。另一方面这一个板子上不光有语音控制功能，还可以添加各种传感器，未来可以将自身数据与其他不同位置的设备共享，是我智能家居这个大工程当中的一个“节点”。</p>
<h1 id="硬件成本"><a href="#硬件成本" class="headerlink" title="硬件成本"></a>硬件成本</h1><table>
<thead>
<tr>
<th align="left">硬件</th>
<th align="right">成本</th>
</tr>
</thead>
<tbody><tr>
<td align="left">ESP32开发板</td>
<td align="right">16元</td>
</tr>
<tr>
<td align="left">SU-03T</td>
<td align="right">10.5元/片+6元运费</td>
</tr>
<tr>
<td align="left">喇叭 4欧3瓦</td>
<td align="right">2.8元</td>
</tr>
<tr>
<td align="left">咪头</td>
<td align="right">0.21元</td>
</tr>
<tr>
<td align="left">万用板5x7cm</td>
<td align="right">0.68元/片</td>
</tr>
<tr>
<td align="left">5mm红外发射头（940nm)</td>
<td align="right">1.9元/20只</td>
</tr>
<tr>
<td align="left">红外接收头(型号随意)</td>
<td align="right">0.23元/只</td>
</tr>
</tbody></table>
<p>另外还需要运行Debian系统的x86架构的设备（软路由、NAS等），用来安装Home Assistant平台。</p>
<h1 id="部署Home-Assistant并安装ESPHome"><a href="#部署Home-Assistant并安装ESPHome" class="headerlink" title="部署Home Assistant并安装ESPHome"></a>部署Home Assistant并安装ESPHome</h1><p>Home Assistant是是一个成熟完整的基于 Python 的开源智能家居系统，设备支持度高，支持自动化（Automation)、群组化（Group）、UI 客制化（Theme) 等等高度定制化设置。<br>ESPHome 是一个可以刷进ESP系列芯片的系统，可以通过简单但功能强大的配置文件来控制你的 ESP8266/ESP32，并通过Home Assistant对其进行远程控制。<br>Home Assistant就像是大脑，刷了ESPHome的ESP32就像是耳朵、眼睛、手。 Home Assistant根据ESPHome传感器传来的信息感知外界的环境变化，然后控制ESPHome或者其他设备执行设定好的指令。<br>大家可以看看目前我Home Assistant的界面<br><img src="HA.png" alt="HA主界面"></p>
<ul>
<li>开关控制NAS开关机，详见<a href="/2021/11/28/Homeassistant-wol/" title="Homeassistant远程开关NAS">Homeassistant远程开关NAS</a></li>
<li>WLED总开关，灯光效果切换，详见<a href="/2022/03/08/wled-HA/" title="用WLED控制流光灯带并接入Home Assistant">用WLED控制流光灯带并接入Home Assistant</a></li>
<li>控制空调的红外遥控开关，详见<a href="/2022/03/06/ESPHome-IRomte/" title="利用ESPHome自制万能遥控器">利用ESPHome自制万能遥控器</a></li>
<li>探测小米手环蓝牙信号强度的指示器，详见<a href="/2022/03/06/ESPHome-ble-tracker/" title="利用ESPHome进行蓝牙设备定位">利用ESPHome进行蓝牙设备定位</a></li>
<li>智能插座的控制开关（我买的BroadLink MP1-1K3S2U可以直接接入Home Assistant)</li>
<li>DLNA控制投影仪，天气……<br>安装<a target="_blank" rel="noopener" href="https://www.home-assistant.io/installation/">Home Assistant</a>需要有NAS、软路由或者树莓派之类的开发板。尽管Home Assistant支持Windows、macOS、Linux等平台安装，兼容x86、ARM、AArch64架构。但我强烈建议在x86架构并安装Debian的设备上部署Home Assistant，因为要在Home Assistant上安装ESPHome，而ESPHome的编译链对架构和平台有要求。要注意Home Assistant有多种安装方式，不同安装方式对设备的要求不同，提供的功能有差别，详情见下图：<br><img src="HA_Compare.png" alt="HA安装方式比较"><br>因为我们需要<code>Add-ons</code>功能来安装ESPHome，必须选Supervised或OS的安装方式。OS安装方式只适用于树莓派等开发板，大部分人只能Supervised方式安装。个人认为这一步需要一点Linux知识，篇幅有限大家自己按照<a target="_blank" rel="noopener" href="https://github.com/home-assistant/supervised-installer">官方教程安装Home Assistant</a>。<br>当然如果你有树莓派那当我前面都没说，直接选择32-bit版本的HA OS系统镜像刷进去就行。不选64位的原因是ESPHome的编译链不支持AArch64架构，ARM应该是可以的，但我没有测试过。<br>安装完Home Assistant，浏览器进入<code>http://你的服务器IP:8123</code>，进行一些初始化设置，就进入Home Assistant的主界面了。后面安装ESPHome就简单了，详见<a target="_blank" rel="noopener" href="https://esphome.io/guides/getting_started_hassio.html#installing-esphome-dashboard">ESPHome官方教程 Installing ESPHome Dashboard</a></li>
</ul>
<h1 id="焊接"><a href="#焊接" class="headerlink" title="焊接"></a>焊接</h1><p>SU-03T自带功放，所以喇叭和咪头都是直接接在SU-03T上，如下图所示。<br><img src="SU-03T.png" alt="SU-03T示意图"><br>红外发射头和红外接收头都接在ESP32上，焊接电路图见之前的帖子<a href="/2022/03/06/ESPHome-IRomte/" title="利用ESPHome自制万能遥控器">利用ESPHome自制万能遥控器</a>。<br>焊接其他部分其实很简单，主要是将SU-03T中可以输出脉冲的GPIO同ESP32中可以输入的GPIO连起来，VCC和GND都连起来。<br>我是按照下表连接的</p>
<table>
<thead>
<tr>
<th align="left">SU-03T的引脚</th>
<th align="right">ESP32的引脚</th>
</tr>
</thead>
<tbody><tr>
<td align="left">B2</td>
<td align="right">GPIO25</td>
</tr>
<tr>
<td align="left">B8</td>
<td align="right">GPIO26</td>
</tr>
<tr>
<td align="left">A27</td>
<td align="right">GPIO32</td>
</tr>
<tr>
<td align="left">B3</td>
<td align="right">GPIO33</td>
</tr>
<tr>
<td align="left">A25</td>
<td align="right">GPIO34</td>
</tr>
<tr>
<td align="left">A26</td>
<td align="right">GPIO35</td>
</tr>
<tr>
<td align="left">GND</td>
<td align="right">GND</td>
</tr>
<tr>
<td align="left">VCC</td>
<td align="right">VCC</td>
</tr>
</tbody></table>
<p>最后找ESP32的VCC时发现这个开发板没有引出来，无奈从PCB上找到了一个直接与VCC相连的芯片焊脚接了出来。<br>成品高清大图，这实在太丑，有空去打个板子：<br><img src="pcb1.jpg" alt="正面"><br><img src="pcb2.jpg" alt="反面"></p>
<h1 id="对SU-03T语音模块编程"><a href="#对SU-03T语音模块编程" class="headerlink" title="对SU-03T语音模块编程"></a>对SU-03T语音模块编程</h1><p>SU-03T有以下优点：</p>
<ul>
<li>价格便宜，识别率不错，可用GPIO口多</li>
<li>编程简单而且免费，而且普通USB-TTL就可以刷入</li>
<li>可以自定义唤醒词，而且支持免唤醒词就执行语音命令<br>SU-03T语音模块的固件完全在网页上编辑和生成，目前完全免费，访问<a target="_blank" rel="noopener" href="http://www.smartpi.cn/">智能公元</a>。<br>部分配置如图所示，B2、A25、A26、A27这四个GPIO依次对应开灯、关灯、开空调、关空调这四个指令，当其中一条语音命令被接受到，对应的GPIO就会发出一次周期为200ms的脉冲信号（引脚其余时间默认低电平）。<br><img src="smartpi.png" alt="智能公元"><br>编辑好了就在线生成SDK，等待10-30分钟就可以下载SDK了。烧录工具、固件、说明书等都在SDK压缩包中。<br>烧录固件很简单，先不要给模块上电，用USB-TTL的TX接连SU-03T的B6，用USB-TTL的RX接连SU-03T的B7，打开烧录软件并点击“烧录”，最后给模块上电并等待烧录结束。<br><img src="ttl.jpg" alt="烧录接线图"><br><img src="UniOne.png" alt="UniOne"></li>
</ul>
<h1 id="使用ESPHome编写和烧录ESP32的固件"><a href="#使用ESPHome编写和烧录ESP32的固件" class="headerlink" title="使用ESPHome编写和烧录ESP32的固件"></a>使用ESPHome编写和烧录ESP32的固件</h1><p>由于ESP32的Flash只有4MB，并不能将所有的功能都放下，所以ESPHome的思路是根据使用者需要的功能编译固件，需要什么功能就把什么功能编译进去。<br>在ESPHome界面，如图所示新建一个ESP32设备<br><img src="esphome1.png" alt="ESPHome新建设备"><br>按向导提示输入Wi-Fi的SSID和密码，向导的最后一步就是点击“install”，然后回弹出如下的提示框。<br><img src="esphome2.png" alt="ESPHome下载固件"><br>第一次往ESP32中烧录固件必须使用有线的方式。首先选择“Manual download”，等待固件编译完成后下载固件到本地电脑。然后返回，再刚刚新建的那个配置的右下角点击菜单，再次选择“install”,这次选择“Plug into this computer”，这个功能可以直接利用你的网页浏览器（仅限Chrome内核浏览器，如Edge）控制串口给ESP32刷机。刷机前先将ESP32的GPIO0和GND用一根杜邦线短接起来（开机前拉低GPIO0使ESP32进入下载模式），然后用一根USB数据线将ESP32连接电脑。网页端按照如图所示让浏览器连接USB-Serial（不同电脑上可以COM后的数字不一样，这是正常的）<br><img src="esphome3.png" alt="ESPHome连接串口"><br>然后上传固件，刷写固件，等待1-2分钟烧写完成，将ESP32的USB数据线拔掉，连接GPIO0的杜邦线拔掉，然后再插回USB数据线。<br>等待片刻，你的ESP32应该就自动连接上你家的Wi-Fi了，在ESPHome界面应该就能看到刚刚配置的ESP32配置文件右上角有个“ONLINE”<br><img src="esphome4.png" alt="ESPHome编辑配置"><br>下面我们就可以对ESP32的固件当中添加各种我们需要的功能了，点击“EDIT”，我就直接粘贴配置文件了</p>
<figure class="highlight subunit"><table><tr><td class="code"><pre><span class="line">esphome:</span><br><span class="line">  name: esp32</span><br><span class="line"></span><br><span class="line">esp32:</span><br><span class="line">  board: esp32dev</span><br><span class="line">  framework:</span><br><span class="line">    type: esp-idf</span><br><span class="line">    version: latest</span><br><span class="line">    # Custom sdkconfig options</span><br><span class="line">    sdkconfig_options:</span><br><span class="line">      CONFIG_COMPILER_OPTIMIZATION_SIZE: y</span><br><span class="line">    # Advanced tweaking options</span><br><span class="line">    advanced:</span><br><span class="line">      ignore_efuse_mac_crc: false</span><br><span class="line"></span><br><span class="line"># Enable logging</span><br><span class="line">logger:</span><br><span class="line"></span><br><span class="line"># Enable Home Assistant API</span><br><span class="line">api:</span><br><span class="line"></span><br><span class="line">ota:</span><br><span class="line">  password: &quot;&quot;</span><br><span class="line"></span><br><span class="line">wifi:</span><br><span class="line">  ssid: !secret wifi_ssid</span><br><span class="line">  password: !secret wifi_password</span><br><span class="line"></span><br><span class="line">  # Enable fallback hotspot (captive portal) in case wifi connection fails</span><br><span class="line">  ap:</span><br><span class="line">    ssid: &quot;Esp32 Fallback Hotspot&quot;</span><br><span class="line">    password: &quot;PMQ3aD1W8AVF&quot;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">binary_sensor:</span><br><span class="line">  - platform: gpio</span><br><span class="line">    id: wledon</span><br><span class="line">    pin: </span><br><span class="line">      number: GPIO25</span><br><span class="line">      mode: INPUT</span><br><span class="line">    on_click:</span><br><span class="line">      min_length: 50ms</span><br><span class="line">      max_length: 300ms</span><br><span class="line">      then:</span><br><span class="line">        - homeassistant.service:</span><br><span class="line">            service: light.turn_on</span><br><span class="line">            data:</span><br><span class="line">              entity_id: light.wled</span><br><span class="line">          </span><br><span class="line">  - platform: gpio</span><br><span class="line">    id: wledoff</span><br><span class="line">    pin: </span><br><span class="line">      number: GPIO34</span><br><span class="line">      mode: INPUT</span><br><span class="line">    on_click:</span><br><span class="line">      min_length: 50ms</span><br><span class="line">      max_length: 300ms</span><br><span class="line">      then:</span><br><span class="line">        - homeassistant.service:</span><br><span class="line">            service: light.turn_off</span><br><span class="line">            data:</span><br><span class="line">              entity_id: light.wled</span><br><span class="line">              </span><br><span class="line">  - platform: gpio</span><br><span class="line">    id: acoff</span><br><span class="line">    pin: </span><br><span class="line">      number: GPIO32</span><br><span class="line">      mode: INPUT</span><br><span class="line">    on_click:</span><br><span class="line">      min_length: 50ms</span><br><span class="line">      max_length: 300ms</span><br><span class="line">      then:</span><br><span class="line">        - homeassistant.service:</span><br><span class="line">            service: switch.turn_off</span><br><span class="line">            data:</span><br><span class="line">              entity_id: switch.bedroom_ac_switch</span><br><span class="line">              </span><br><span class="line">  - platform: gpio</span><br><span class="line">    id: acon</span><br><span class="line">    pin: </span><br><span class="line">      number: GPIO35</span><br><span class="line">      mode: INPUT</span><br><span class="line">    on_click:</span><br><span class="line">      min_length: 50ms</span><br><span class="line">      max_length: 300ms</span><br><span class="line">      then:</span><br><span class="line">        - homeassistant.service:</span><br><span class="line">            service: switch.turn_on</span><br><span class="line">            data:</span><br><span class="line">              entity_id: switch.bedroom_ac_switch</span><br><span class="line">              </span><br><span class="line">remote_receiver:</span><br><span class="line">  pin: </span><br><span class="line">    number: GPIO14</span><br><span class="line">    inverted: True</span><br><span class="line">    mode: INPUT_PULLUP</span><br><span class="line">  dump: raw</span><br><span class="line">  idle: 40ms</span><br><span class="line"></span><br><span class="line">remote_transmitter:</span><br><span class="line">  pin: </span><br><span class="line">    number: GPIO27</span><br><span class="line">  carrier_duty_percent: 50%</span><br><span class="line"></span><br><span class="line">switch:</span><br><span class="line">  - platform: template</span><br><span class="line">    name: &quot;BedRoom AC Switch&quot;</span><br><span class="line">    id: esp32_ac_swi</span><br><span class="line">    turn_on_action:</span><br><span class="line">      then:</span><br><span class="line">        - switch.template.publish:</span><br><span class="line">            id: esp32_ac_swi</span><br><span class="line">            state: ON</span><br><span class="line">        - if:</span><br><span class="line">            condition:</span><br><span class="line">              lambda: &#x27;return id(temperature).state &lt; 20;&#x27;</span><br><span class="line">            then:</span><br><span class="line">              - script.execute: turn_ac_20c</span><br><span class="line">            else:</span><br><span class="line">              - script.execute: turn_ac_27c</span><br><span class="line"></span><br><span class="line">    turn_off_action:</span><br><span class="line">      then:</span><br><span class="line">        - switch.template.publish:</span><br><span class="line">            id: esp32_ac_swi</span><br><span class="line">            state: OFF</span><br><span class="line">        - script.execute: turn_ac_off</span><br><span class="line"></span><br><span class="line">esp32_ble_tracker:</span><br><span class="line">  scan_parameters:</span><br><span class="line">    interval: 1s</span><br><span class="line">    window: 500ms</span><br><span class="line">    active: false</span><br><span class="line">sensor:</span><br><span class="line">  # RSSI based on MAC address</span><br><span class="line">  - platform: ble_rssi</span><br><span class="line">    mac_address: FA:4C:19:74:CF:31</span><br><span class="line">    name: &quot;MI Band RSSI value&quot;</span><br><span class="line">  - platform: homeassistant</span><br><span class="line">    entity_id: weather.wo_de_jia</span><br><span class="line">    id: temperature</span><br><span class="line">    attribute: temperature</span><br><span class="line">    </span><br><span class="line">script:</span><br><span class="line">  - id: turn_ac_20c</span><br><span class="line">    then:</span><br><span class="line">      - remote_transmitter.transmit_raw:</span><br><span class="line">          carrier_frequency: 38kHz</span><br><span class="line">          code: [9016, <span class="string">-4481</span>, 620, <span class="string">-570</span>, 620, <span class="string">-570</span>, 619, <span class="string">-1670</span>, 620, <span class="string">-1671</span>, 620, <span class="string">-570</span>, 621, <span class="string">-569</span>, 621, <span class="string">-1668</span>, 619, <span class="string">-572</span>, 620, <span class="string">-569</span>, 620, <span class="string">-570</span>, 621, <span class="string">-1669</span>, 621, <span class="string">-570</span>, 621, <span class="string">-568</span>, 620, <span class="string">-570</span>, 621, <span class="string">-569</span>, 621, <span class="string">-569</span>, 622, <span class="string">-568</span>, 619, <span class="string">-572</span>, 619, <span class="string">-570</span>, 621, <span class="string">-569</span>, 619, <span class="string">-572</span>, 619, <span class="string">-1671</span>, 618, <span class="string">-571</span>, 620, <span class="string">-1670</span>, 620, <span class="string">-571</span>, 619, <span class="string">-571</span>, 618, <span class="string">-571</span>, 619, <span class="string">-570</span>, 621, <span class="string">-1670</span>, 620, <span class="string">-570</span>, 646, <span class="string">-1643</span>, 621, <span class="string">-569</span>, 621, <span class="string">-569</span>, 621, <span class="string">-1669</span>, 620, <span class="string">-571</span>, 619, <span class="string">-19990</span>, 620, <span class="string">-1670</span>, 620, <span class="string">-571</span>, 620, <span class="string">-568</span>, 622, <span class="string">-569</span>, 621, <span class="string">-1669</span>, 621, <span class="string">-569</span>, 617, <span class="string">-573</span>, 617, <span class="string">-573</span>, 620, <span class="string">-570</span>, 645, <span class="string">-545</span>, 621, <span class="string">-569</span>, 620, <span class="string">-570</span>, 619, <span class="string">-570</span>, 621, <span class="string">-1669</span>, 618, <span class="string">-572</span>, 645, <span class="string">-546</span>, 619, <span class="string">-571</span>, 645, <span class="string">-544</span>, 620, <span class="string">-571</span>, 617, <span class="string">-573</span>, 643, <span class="string">-547</span>, 620, <span class="string">-569</span>, 620, <span class="string">-571</span>, 617, <span class="string">-572</span>, 644, <span class="string">-546</span>, 618, <span class="string">-572</span>, 612, <span class="string">-578</span>, 621, <span class="string">-569</span>, 619, <span class="string">-1671</span>, 617, <span class="string">-573</span>, 620, <span class="string">-1670</span>, 644, <span class="string">-1646</span>, 619, <span class="string">-7223</span>, 9010, <span class="string">-4489</span>, 617, <span class="string">-573</span>, 615, <span class="string">-575</span>, 643, <span class="string">-1647</span>, 620, <span class="string">-1670</span>, 643, <span class="string">-546</span>, 619, <span class="string">-572</span>, 616, <span class="string">-1674</span>, 617, <span class="string">-573</span>, 644, <span class="string">-545</span>, 618, <span class="string">-573</span>, 617, <span class="string">-1673</span>, 615, <span class="string">-574</span>, 642, <span class="string">-549</span>, 617, <span class="string">-572</span>, 618, <span class="string">-572</span>, 617, <span class="string">-573</span>, 643, <span class="string">-547</span>, 644, <span class="string">-546</span>, 614, <span class="string">-576</span>, 643, <span class="string">-547</span>, 593, <span class="string">-598</span>, 643, <span class="string">-1646</span>, 643, <span class="string">-547</span>, 616, <span class="string">-1674</span>, 639, <span class="string">-551</span>, 610, <span class="string">-580</span>, 616, <span class="string">-574</span>, 641, <span class="string">-549</span>, 617, <span class="string">-1673</span>, 592, <span class="string">-1699</span>, 617, <span class="string">-1672</span>, 639, <span class="string">-551</span>, 642, <span class="string">-547</span>, 593, <span class="string">-1698</span>, 592, <span class="string">-598</span>, 640, <span class="string">-19969</span>, 637, <span class="string">-553</span>, 593, <span class="string">-597</span>, 642, <span class="string">-548</span>, 642, <span class="string">-548</span>, 640, <span class="string">-550</span>, 592, <span class="string">-598</span>, 592, <span class="string">-598</span>, 593, <span class="string">-597</span>, 592, <span class="string">-597</span>, 642, <span class="string">-549</span>, 593, <span class="string">-597</span>, 594, <span class="string">-596</span>, 593, <span class="string">-597</span>, 592, <span class="string">-598</span>, 640, <span class="string">-550</span>, 593, <span class="string">-597</span>, 593, <span class="string">-597</span>, 593, <span class="string">-597</span>, 592, <span class="string">-597</span>, 593, <span class="string">-598</span>, 641, <span class="string">-548</span>, 640, <span class="string">-551</span>, 592, <span class="string">-597</span>, 642, <span class="string">-549</span>, 593, <span class="string">-597</span>, 593, <span class="string">-596</span>, 594, <span class="string">-597</span>, 593, <span class="string">-596</span>, 594, <span class="string">-596</span>, 593, <span class="string">-1697</span>, 594, <span class="string">-596</span>, 594, <span class="string">-1696</span>, 594]</span><br><span class="line">  - id: turn_ac_off</span><br><span class="line">    then:</span><br><span class="line">      - remote_transmitter.transmit_raw:</span><br><span class="line">          carrier_frequency: 38kHz</span><br><span class="line">          code: [9021, <span class="string">-4476</span>, 625, <span class="string">-1666</span>, 624, <span class="string">-565</span>, 624, <span class="string">-567</span>, 625, <span class="string">-567</span>, 621, <span class="string">-567</span>, 626, <span class="string">-566</span>, 622, <span class="string">-1666</span>, 624, <span class="string">-566</span>, 623, <span class="string">-1666</span>, 626, <span class="string">-1691</span>, 597, <span class="string">-566</span>, 626, <span class="string">-1664</span>, 625, <span class="string">-593</span>, 597, <span class="string">-566</span>, 624, <span class="string">-566</span>, 625, <span class="string">-565</span>, 624, <span class="string">-565</span>, 622, <span class="string">-569</span>, 624, <span class="string">-565</span>, 625, <span class="string">-565</span>, 625, <span class="string">-592</span>, 599, <span class="string">-564</span>, 624, <span class="string">-566</span>, 626, <span class="string">-564</span>, 626, <span class="string">-565</span>, 625, <span class="string">-566</span>, 623, <span class="string">-565</span>, 624, <span class="string">-566</span>, 624, <span class="string">-1666</span>, 625, <span class="string">-565</span>, 625, <span class="string">-1665</span>, 626, <span class="string">-564</span>, 623, <span class="string">-567</span>, 624, <span class="string">-1666</span>, 623, <span class="string">-567</span>, 626, <span class="string">-19983</span>, 625, <span class="string">-1665</span>, 624, <span class="string">-567</span>, 625, <span class="string">-564</span>, 624, <span class="string">-566</span>, 626, <span class="string">-1664</span>, 623, <span class="string">-593</span>, 599, <span class="string">-565</span>, 624, <span class="string">-566</span>, 624, <span class="string">-566</span>, 624, <span class="string">-594</span>, 598, <span class="string">-566</span>, 622, <span class="string">-567</span>, 624, <span class="string">-591</span>, 598, <span class="string">-1666</span>, 625, <span class="string">-565</span>, 623, <span class="string">-567</span>, 624, <span class="string">-569</span>, 622, <span class="string">-564</span>, 625, <span class="string">-568</span>, 621, <span class="string">-569</span>, 624, <span class="string">-564</span>, 623, <span class="string">-567</span>, 625, <span class="string">-564</span>, 624, <span class="string">-566</span>, 623, <span class="string">-568</span>, 624, <span class="string">-566</span>, 623, <span class="string">-566</span>, 626, <span class="string">-566</span>, 622, <span class="string">-1666</span>, 623, <span class="string">-568</span>, 623, <span class="string">-567</span>, 624, <span class="string">-1665</span>, 624, <span class="string">-7194</span>, 9041, <span class="string">-4481</span>, 626, <span class="string">-1665</span>, 624, <span class="string">-568</span>, 621, <span class="string">-566</span>, 622, <span class="string">-569</span>, 625, <span class="string">-567</span>, 622, <span class="string">-568</span>, 621, <span class="string">-1668</span>, 622, <span class="string">-566</span>, 624, <span class="string">-1666</span>, 625, <span class="string">-1666</span>, 623, <span class="string">-567</span>, 625, <span class="string">-1664</span>, 623, <span class="string">-594</span>, 598, <span class="string">-591</span>, 599, <span class="string">-566</span>, 621, <span class="string">-595</span>, 599, <span class="string">-565</span>, 625, <span class="string">-564</span>, 624, <span class="string">-566</span>, 625, <span class="string">-567</span>, 622, <span class="string">-569</span>, 622, <span class="string">-565</span>, 623, <span class="string">-569</span>, 623, <span class="string">-568</span>, 622, <span class="string">-567</span>, 622, <span class="string">-568</span>, 621, <span class="string">-567</span>, 624, <span class="string">-566</span>, 623, <span class="string">-1669</span>, 623, <span class="string">-1692</span>, 597, <span class="string">-1666</span>, 624, <span class="string">-565</span>, 625, <span class="string">-566</span>, 624, <span class="string">-1668</span>, 622, <span class="string">-565</span>, 623, <span class="string">-19985</span>, 627, <span class="string">-565</span>, 626, <span class="string">-564</span>, 626, <span class="string">-565</span>, 623, <span class="string">-566</span>, 625, <span class="string">-566</span>, 623, <span class="string">-593</span>, 595, <span class="string">-594</span>, 600, <span class="string">-565</span>, 622, <span class="string">-593</span>, 597, <span class="string">-567</span>, 624, <span class="string">-566</span>, 623, <span class="string">-567</span>, 624, <span class="string">-566</span>, 625, <span class="string">-565</span>, 625, <span class="string">-565</span>, 626, <span class="string">-564</span>, 623, <span class="string">-567</span>, 623, <span class="string">-567</span>, 623, <span class="string">-569</span>, 622, <span class="string">-566</span>, 622, <span class="string">-568</span>, 622, <span class="string">-569</span>, 623, <span class="string">-566</span>, 623, <span class="string">-567</span>, 623, <span class="string">-566</span>, 624, <span class="string">-567</span>, 623, <span class="string">-566</span>, 624, <span class="string">-568</span>, 623, <span class="string">-566</span>, 622, <span class="string">-1667</span>, 625, <span class="string">-1665</span>, 623, <span class="string">-594</span>, 596]</span><br><span class="line">  - id: turn_ac_27c</span><br><span class="line">    then:</span><br><span class="line">      - remote_transmitter.transmit_raw:</span><br><span class="line">          carrier_frequency: 38kHz</span><br><span class="line">          code: [9048, <span class="string">-4448</span>, 653, <span class="string">-1665</span>, 623, <span class="string">-539</span>, 653, <span class="string">-537</span>, 650, <span class="string">-1668</span>, 625, <span class="string">-537</span>, 654, <span class="string">-537</span>, 650, <span class="string">-1640</span>, 650, <span class="string">-539</span>, 652, <span class="string">-1639</span>, 651, <span class="string">-1638</span>, 651, <span class="string">-539</span>, 652, <span class="string">-1638</span>, 653, <span class="string">-538</span>, 651, <span class="string">-539</span>, 650, <span class="string">-540</span>, 652, <span class="string">-538</span>, 650, <span class="string">-539</span>, 652, <span class="string">-539</span>, 651, <span class="string">-537</span>, 652, <span class="string">-538</span>, 652, <span class="string">-538</span>, 652, <span class="string">-1638</span>, 651, <span class="string">-540</span>, 652, <span class="string">-537</span>, 653, <span class="string">-538</span>, 650, <span class="string">-567</span>, 623, <span class="string">-539</span>, 651, <span class="string">-539</span>, 651, <span class="string">-1639</span>, 652, <span class="string">-566</span>, 623, <span class="string">-1639</span>, 652, <span class="string">-538</span>, 653, <span class="string">-537</span>, 652, <span class="string">-1638</span>, 652, <span class="string">-539</span>, 651, <span class="string">-19956</span>, 653, <span class="string">-1638</span>, 653, <span class="string">-539</span>, 652, <span class="string">-536</span>, 650, <span class="string">-541</span>, 650, <span class="string">-1666</span>, 627, <span class="string">-536</span>, 654, <span class="string">-536</span>, 650, <span class="string">-541</span>, 653, <span class="string">-537</span>, 650, <span class="string">-539</span>, 653, <span class="string">-565</span>, 625, <span class="string">-537</span>, 652, <span class="string">-538</span>, 652, <span class="string">-1638</span>, 652, <span class="string">-540</span>, 650, <span class="string">-541</span>, 649, <span class="string">-565</span>, 625, <span class="string">-566</span>, 624, <span class="string">-538</span>, 651, <span class="string">-539</span>, 651, <span class="string">-539</span>, 653, <span class="string">-537</span>, 652, <span class="string">-565</span>, 624, <span class="string">-539</span>, 652, <span class="string">-538</span>, 652, <span class="string">-539</span>, 649, <span class="string">-539</span>, 653, <span class="string">-564</span>, 625, <span class="string">-1639</span>, 652, <span class="string">-539</span>, 650, <span class="string">-539</span>, 652, <span class="string">-565</span>, 625, <span class="string">-7187</span>, 9047, <span class="string">-4453</span>, 653, <span class="string">-1640</span>, 649, <span class="string">-566</span>, 625, <span class="string">-540</span>, 651, <span class="string">-1637</span>, 652, <span class="string">-538</span>, 651, <span class="string">-539</span>, 651, <span class="string">-1638</span>, 653, <span class="string">-538</span>, 650, <span class="string">-1640</span>, 651, <span class="string">-1640</span>, 652, <span class="string">-537</span>, 652, <span class="string">-1637</span>, 653, <span class="string">-537</span>, 652, <span class="string">-541</span>, 649, <span class="string">-538</span>, 653, <span class="string">-538</span>, 652,  <span class="string">-540</span>, 649, <span class="string">-565</span>, 626, <span class="string">-539</span>, 651, <span class="string">-539</span>, 653, <span class="string">-537</span>, 652, <span class="string">-1637</span>, 652, <span class="string">-538</span>, 653, <span class="string">-537</span>, 652, <span class="string">-565</span>, 625, <span class="string">-564</span>, 627, <span class="string">-537</span>, 653, <span class="string">-537</span>, 652, <span class="string">-1664</span>, 627, <span class="string">-1636</span>, 653, <span class="string">-1637</span>, 654, <span class="string">-563</span>, 626, <span class="string">-538</span>, 653, <span class="string">-1637</span>, 653, <span class="string">-537</span>, 651, <span class="string">-19956</span>, 653, <span class="string">-539</span>, 654, <span class="string">-537</span>, 650,  <span class="string">-566</span>, 625, <span class="string">-538</span>, 652, <span class="string">-538</span>, 652, <span class="string">-538</span>, 654, <span class="string">-536</span>, 651, <span class="string">-539</span>, 652, <span class="string">-538</span>, 653, <span class="string">-564</span>, 624, <span class="string">-539</span>, 651, <span class="string">-539</span>, 651, <span class="string">-539</span>, 651, <span class="string">-538</span>, 651, <span class="string">-540</span>, 651, <span class="string">-538</span>, 653, <span class="string">-538</span>, 652, <span class="string">-537</span>, 652, <span class="string">-538</span>, 652, <span class="string">-565</span>, 624, <span class="string">-567</span>, 625, <span class="string">-538</span>, 653, <span class="string">-562</span>, 626, <span class="string">-538</span>, 652, <span class="string">-538</span>, 651,  <span class="string">-540</span>, 651, <span class="string">-538</span>, 654, <span class="string">-536</span>, 653, <span class="string">-537</span>, 651, <span class="string">-1665</span>, 627, <span class="string">-1637</span>, 652, <span class="string">-1638</span>, 652]</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>改好配置文件后，点击“install”，然后用“Wireless”模式，也就是OTA升级就可以把新固件烧写进ESP32了。<br>这里只详细讲述配置中的<code>binary_sensor:</code>字键，其余配置详见我的另外三篇文章<a href="/2022/03/06/ESPHome-IRomte/" title="利用ESPHome自制万能遥控器">利用ESPHome自制万能遥控器</a>和<a href="/2022/03/06/ESPHome-ble-tracker/" title="利用ESPHome进行蓝牙设备定位">利用ESPHome进行蓝牙设备定位</a>里面都有提到。 <code>binary_sensor:</code>里我创建了4个传感器去检测上文提到的4个GPIO的电平变化，其中<code>on_click:</code>就是在GPIO口从低电平到高电平再回落到低电平的这个过程被检测到后执行的动作。所以<code>min_length:</code>是高电平状态最小的保持时间，必须高于这个值才会被认为是一次“click”。而之前我们对SU-03T编程时，设置一次脉冲周期是200ms，高电平和低电平时间在一个周期内应该是一半一半，所以理论上触发一次动作高电平会保持100ms，<code>min_length:</code>应该低于这个值，但不能太低，不然供电一个不稳定也可能会引起误触。</p>
]]></content>
      <tags>
        <tag>HomeAssistant</tag>
        <tag>ESP芯片</tag>
      </tags>
  </entry>
  <entry>
    <title>Xray+Nginx实现Trojan+TLS伪装代理</title>
    <url>/2021/12/03/Xray-trojan/</url>
    <content><![CDATA[<p>记录一下Xray用Trojan协议（兼容Trojan）+ Nginx伪装代理</p>
<span id="more"></span>
<h1 id="安装Xray和Nginx"><a href="#安装Xray和Nginx" class="headerlink" title="安装Xray和Nginx"></a>安装Xray和Nginx</h1><p>参考以下两个链接分别在服务器上安装Xray和Nginx。</p>
<a href="/2019/10/26/Nginx-FancyIndex/" title="编译安装Nginx+FancyIndex">编译安装和配置Nginx</a>
<p> <a target="_blank" rel="noopener" href="https://github.com/XTLS/Xray-install">Xray官方Linux下安装指南</a></p>
<h1 id="Nginx配置"><a href="#Nginx配置" class="headerlink" title="Nginx配置"></a>Nginx配置</h1><p> 编辑<code>/etc/nginx/nginx.conf</code>, https的域名以weiyangbo.com为例</p>
<figure class="highlight pgsql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">user</span>  root;</span><br><span class="line">worker_processes  <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">pid        /var/run/nginx.pid;</span><br><span class="line">error_log /var/<span class="keyword">log</span>/nginx_error.<span class="keyword">log</span>;</span><br><span class="line"></span><br><span class="line">events &#123;</span><br><span class="line">	use epoll;</span><br><span class="line">	worker_connections  <span class="number">1024</span>;</span><br><span class="line">	multi_accept <span class="keyword">on</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">http &#123;</span><br><span class="line">	<span class="keyword">include</span>       /etc/nginx/mime.<span class="keyword">types</span>;</span><br><span class="line">	default_type  application/octet-stream;</span><br><span class="line">	charset ISO<span class="number">-88509</span><span class="number">-1</span>;</span><br><span class="line">	sendfile <span class="keyword">on</span>;</span><br><span class="line">	tcp_nopush     <span class="keyword">on</span>;</span><br><span class="line">	tcp_nodelay <span class="keyword">on</span>;</span><br><span class="line">	keepalive_timeout  <span class="number">60</span>;</span><br><span class="line">	client_header_buffer_size <span class="number">4</span>k;</span><br><span class="line">	open_file_cache max=<span class="number">102400</span> inactive=<span class="number">20</span>s;</span><br><span class="line">	open_file_cache_valid <span class="number">30</span>s;</span><br><span class="line">	open_file_cache_min_uses <span class="number">1</span>;</span><br><span class="line">	client_header_timeout <span class="number">15</span>;</span><br><span class="line">	client_body_timeout <span class="number">15</span>;</span><br><span class="line">	reset_timedout_connection <span class="keyword">on</span>;</span><br><span class="line">	send_timeout <span class="number">15</span>;</span><br><span class="line">	gzip <span class="keyword">on</span>;</span><br><span class="line">	gzip_disable &quot;msie6&quot;;</span><br><span class="line">	gzip_vary <span class="keyword">on</span>;</span><br><span class="line">	gzip_proxied <span class="keyword">any</span>;</span><br><span class="line">	gzip_comp_level <span class="number">3</span>;</span><br><span class="line">	gzip_buffers <span class="number">16</span> <span class="number">8</span>k;</span><br><span class="line">	gzip_http_version <span class="number">1.1</span>;</span><br><span class="line">	gzip_types <span class="type">text</span>/plain <span class="type">text</span>/css application/<span class="type">json</span> application/javascript <span class="type">text</span>/<span class="type">xml</span> application/<span class="type">xml</span> application/<span class="type">xml</span>+rss <span class="type">text</span>/javascript;</span><br><span class="line">	server_tokens <span class="keyword">off</span>;</span><br><span class="line">	access_log  /var/<span class="keyword">log</span>/nginx_access.<span class="keyword">log</span>;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">server</span> &#123;</span><br><span class="line">		<span class="keyword">listen</span> <span class="number">80</span> default_server;</span><br><span class="line">		server_name weiyangbo.com www.weiyangbo.com;</span><br><span class="line">		<span class="keyword">return</span> <span class="number">301</span> https://$server_name$<span class="language-pgsql">request_uri;</span></span><br><span class="line"><span class="language-pgsql">	&#125;</span></span><br><span class="line"><span class="language-pgsql"></span></span><br><span class="line"><span class="language-pgsql">	<span class="keyword">server</span> &#123;</span></span><br><span class="line"><span class="language-pgsql">        	<span class="keyword">listen</span>       unix:/dev/shm/<span class="keyword">default</span>.sock proxy_protocol;</span></span><br><span class="line"><span class="language-pgsql">        	<span class="keyword">listen</span>       unix:/dev/shm/h2c.sock http2 proxy_protocol;</span></span><br><span class="line"><span class="language-pgsql">		charset ISO<span class="number">-88509</span><span class="number">-1</span>;</span></span><br><span class="line"><span class="language-pgsql">		server_name  weiyangbo.com www.weiyangbo.com;</span></span><br><span class="line"><span class="language-pgsql">		set_real_ip_from <span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>;</span></span><br><span class="line"><span class="language-pgsql">		add_header <span class="keyword">Strict</span>-Transport-<span class="keyword">Security</span> &quot;max-age=63072000&quot; <span class="keyword">always</span>;</span></span><br><span class="line"><span class="language-pgsql">		root /root/mokee;</span></span><br><span class="line"><span class="language-pgsql">		<span class="keyword">location</span> / &#123;</span></span><br><span class="line"><span class="language-pgsql">			expires <span class="number">10</span>h;</span></span><br><span class="line"><span class="language-pgsql">			fancyindex <span class="keyword">on</span>;</span></span><br><span class="line"><span class="language-pgsql">			fancyindex_exact_size <span class="keyword">off</span>;</span></span><br><span class="line"><span class="language-pgsql">			fancyindex_localtime <span class="keyword">on</span>;</span></span><br><span class="line"><span class="language-pgsql">			fancyindex_header &quot;/fancyindex/header.html&quot;;</span></span><br><span class="line"><span class="language-pgsql">			fancyindex_footer &quot;/fancyindex/footer.html&quot;;</span></span><br><span class="line"><span class="language-pgsql">			fancyindex_ignore &quot;donate&quot; &quot;fancyindex&quot; &quot;Download&quot;;</span></span><br><span class="line"><span class="language-pgsql">			fancyindex_name_length <span class="number">500</span>;</span></span><br><span class="line"><span class="language-pgsql">		&#125;</span></span><br><span class="line"><span class="language-pgsql">		<span class="keyword">location</span> ~*  ^.+\.(jpg|gif|png|img|apk|tar.gz|wmv|jpeg|mp3|mp4|zip|rar)$ &#123;</span></span><br><span class="line"><span class="language-pgsql">			valid_referers <span class="keyword">none</span> blocked www.weiyangbo.com weiyangbo.com;</span></span><br><span class="line"><span class="language-pgsql">			<span class="keyword">if</span> ($invalid_referer)&#123;</span></span><br><span class="line"><span class="language-pgsql">				<span class="keyword">return</span> <span class="number">403</span>;</span></span><br><span class="line"><span class="language-pgsql">				break;</span></span><br><span class="line"><span class="language-pgsql">			&#125;</span></span><br><span class="line"><span class="language-pgsql">			access_log <span class="keyword">off</span>;</span></span><br><span class="line"><span class="language-pgsql">		&#125;</span></span><br><span class="line"><span class="language-pgsql">	&#125;</span></span><br><span class="line"><span class="language-pgsql">&#125; </span></span><br></pre></td></tr></table></figure>
<p><code>sudo systemctl restart nginx</code></p>
<h1 id="Xray配置"><a href="#Xray配置" class="headerlink" title="Xray配置"></a>Xray配置</h1><p>  编辑<code>/usr/local/etc/xray/config.json</code></p>
<figure class="highlight prolog"><table><tr><td class="code"><pre><span class="line">  &#123;</span><br><span class="line">    <span class="string">&quot;log&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;loglevel&quot;</span>: <span class="string">&quot;warning&quot;</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="string">&quot;inbounds&quot;</span>: [</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="string">&quot;port&quot;</span>: <span class="number">443</span>,</span><br><span class="line">            <span class="string">&quot;protocol&quot;</span>: <span class="string">&quot;trojan&quot;</span>,</span><br><span class="line">            <span class="string">&quot;settings&quot;</span>: &#123;</span><br><span class="line">                <span class="string">&quot;clients&quot;</span>: [</span><br><span class="line">                    &#123;</span><br><span class="line">                        <span class="string">&quot;password&quot;</span>:<span class="string">&quot;填你的密码&quot;</span></span><br><span class="line">                    &#125;</span><br><span class="line">                ],</span><br><span class="line">				<span class="string">&quot;fallbacks&quot;</span>: [</span><br><span class="line">				&#123;</span><br><span class="line">				        <span class="string">&quot;dest&quot;</span>: <span class="string">&quot;/dev/shm/default.sock&quot;</span>,</span><br><span class="line">				        <span class="string">&quot;xver&quot;</span>: <span class="number">1</span></span><br><span class="line">				 &#125;,</span><br><span class="line">				 &#123;</span><br><span class="line">				        <span class="string">&quot;alpn&quot;</span>: <span class="string">&quot;h2&quot;</span>,</span><br><span class="line">				        <span class="string">&quot;dest&quot;</span>: <span class="string">&quot;/dev/shm/h2c.sock&quot;</span>,</span><br><span class="line">				        <span class="string">&quot;xver&quot;</span>: <span class="number">1</span></span><br><span class="line">				  &#125;</span><br><span class="line">				]</span><br><span class="line">            &#125;,</span><br><span class="line">            <span class="string">&quot;streamSettings&quot;</span>: &#123;</span><br><span class="line">                <span class="string">&quot;network&quot;</span>: <span class="string">&quot;tcp&quot;</span>,</span><br><span class="line">                <span class="string">&quot;security&quot;</span>: <span class="string">&quot;tls&quot;</span>,</span><br><span class="line">                <span class="string">&quot;tlsSettings&quot;</span>: &#123;</span><br><span class="line">                	<span class="string">&quot;alpn&quot;</span>:[<span class="string">&quot;http/1.1&quot;</span>,<span class="string">&quot;h2&quot;</span>],</span><br><span class="line">                    <span class="string">&quot;certificates&quot;</span>: [</span><br><span class="line">                        &#123;//自己搞定域名和证书</span><br><span class="line">                            <span class="string">&quot;certificateFile&quot;</span>: <span class="string">&quot;/etc/nginx/cert/2994039_weiyangbo.com.pem&quot;</span>,</span><br><span class="line">                            <span class="string">&quot;keyFile&quot;</span>: <span class="string">&quot;/etc/nginx/cert/2994039_weiyangbo.com.key&quot;</span></span><br><span class="line">                        &#125;</span><br><span class="line">                    ]</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    ],</span><br><span class="line">    <span class="string">&quot;outbounds&quot;</span>: [</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="string">&quot;protocol&quot;</span>: <span class="string">&quot;freedom&quot;</span></span><br><span class="line">        &#125;</span><br><span class="line">    ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>sudo systemctl restart xray</code></p>
]]></content>
      <tags>
        <tag>Nginx</tag>
        <tag>梯子</tag>
      </tags>
  </entry>
  <entry>
    <title>Armbian下配置成无线接入点</title>
    <url>/2022/03/23/armbian-ap/</url>
    <content><![CDATA[<p>捡了一个S912盒子，想要作为一个无线AP接入点。</p>
<h1 id="前期准备"><a href="#前期准备" class="headerlink" title="前期准备"></a>前期准备</h1><p>首先要解除NetworkManager对wlan0的占用，先<code>nmcli -s</code>记下wlan0的mac地址，比如<code>ff:ff:ff:ff:ff:ff</code>，编辑<code>/etc/NetworkManager/NetworkManager.conf</code>，改一下下面的字段，把你的wlan0划为<code>unmanageable-devices</code></p>
<figure class="highlight ini"><table><tr><td class="code"><pre><span class="line"><span class="section">[keyfile]</span></span><br><span class="line"><span class="attr">unmanaged-devices</span>=mac:ff:ff:ff:ff:ff:ff</span><br></pre></td></tr></table></figure>
<p>最后重启NetworkManager生效</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="built_in">sudo</span> service NetworkManager restart</span><br></pre></td></tr></table></figure>
<h1 id="配置WiFi"><a href="#配置WiFi" class="headerlink" title="配置WiFi"></a>配置WiFi</h1><p>然后我们安装hostapd、bridge-utils</p>
<figure class="highlight mipsasm"><table><tr><td class="code"><pre><span class="line">sudo apt-get <span class="keyword">install </span>hostapd <span class="keyword">bridge-utils </span>-y</span><br></pre></td></tr></table></figure>
<p>hostapd负责发射WiFi，先编辑他的配置文件<code>/etc/default/hostapd</code>，去掉下面这行注释并修改</p>
<figure class="highlight ini"><table><tr><td class="code"><pre><span class="line"><span class="attr">DAEMON_CONF</span>=<span class="string">&quot;/etc/hostapd/hostapd.conf&quot;</span></span><br></pre></td></tr></table></figure>
<p>再编辑他的配置文件<code>/etc/hostapd/hostapd.conf</code>，我把我的配置粘贴一下</p>
<figure class="highlight ini"><table><tr><td class="code"><pre><span class="line"><span class="attr">interface</span>=wlan0</span><br><span class="line"><span class="attr">bridge</span>=br0</span><br><span class="line"><span class="attr">driver</span>=nl80211</span><br><span class="line"><span class="attr">ssid</span>=Armbian</span><br><span class="line"><span class="attr">hw_mode</span>=g</span><br><span class="line"><span class="attr">channel</span>=<span class="number">7</span></span><br><span class="line"><span class="attr">wmm_enabled</span>=<span class="number">0</span></span><br><span class="line"><span class="attr">macaddr_acl</span>=<span class="number">0</span></span><br><span class="line"><span class="attr">auth_algs</span>=<span class="number">1</span></span><br><span class="line"><span class="attr">ignore_broadcast_ssid</span>=<span class="number">0</span></span><br><span class="line"><span class="attr">wpa</span>=<span class="number">2</span></span><br><span class="line"><span class="attr">wpa_passphrase</span>=<span class="number">1234567890</span></span><br><span class="line"><span class="attr">wpa_key_mgmt</span>=WPA-PSK</span><br><span class="line"><span class="attr">wpa_pairwise</span>=TKIP</span><br><span class="line"><span class="attr">rsn_pairwise</span>=CCMP</span><br></pre></td></tr></table></figure>
<p>最后启动hostapd</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="built_in">sudo</span> systemctl start hostapd.service &amp;&amp; <span class="built_in">sudo</span> systemctl <span class="built_in">enable</span> hostapd.service</span><br></pre></td></tr></table></figure>
<p>打开你的手机搜索WiFi试试，能不能搜到WiFi。搜到就行了，连不上的，因为wlan0啥都不是，下面要做桥接。</p>
<h1 id="配置eth0和wlan0桥接"><a href="#配置eth0和wlan0桥接" class="headerlink" title="配置eth0和wlan0桥接"></a>配置eth0和wlan0桥接</h1><p>编辑<code>/etc/network/interfaces</code>，我直接贴出我完整的配置</p>
<figure class="highlight apache"><table><tr><td class="code"><pre><span class="line"><span class="attribute">source</span> /etc/network/interfaces.d/*</span><br><span class="line"></span><br><span class="line"><span class="attribute">auto</span> lo br0</span><br><span class="line"><span class="attribute">iface</span> lo inet loopback</span><br><span class="line"></span><br><span class="line"><span class="attribute">allow</span>-hotplug wlan0</span><br><span class="line"><span class="attribute">iface</span> wlan0 inet manual</span><br><span class="line"></span><br><span class="line"><span class="comment"># eth0 connected to the ISP router</span></span><br><span class="line"><span class="attribute">allow</span>-hotplug eth0</span><br><span class="line"><span class="attribute">iface</span> eth0 inet manual</span><br><span class="line"></span><br><span class="line"><span class="comment"># Setup bridge</span></span><br><span class="line"><span class="attribute">auto</span> br0</span><br><span class="line"><span class="attribute">iface</span> br0 inet dhcp</span><br><span class="line">      <span class="attribute">bridge_ports</span> eth0 wlan0</span><br><span class="line">      <span class="attribute">bridge_stp</span> <span class="literal">off</span></span><br><span class="line">      <span class="attribute">bridge_maxwait</span> <span class="number">0</span></span><br></pre></td></tr></table></figure>
<h1 id="重启生效"><a href="#重启生效" class="headerlink" title="重启生效"></a>重启生效</h1><figure class="highlight ebnf"><table><tr><td class="code"><pre><span class="line"><span class="attribute">reboot</span></span><br></pre></td></tr></table></figure>
<p>到此结束~</p>
]]></content>
  </entry>
  <entry>
    <title>Armbian下配置成无线路由器</title>
    <url>/2022/03/23/armbian-router/</url>
    <content><![CDATA[<p>捡了一个S912盒子，想要作为一个无线网关，用作智能家居的网关。有线网口接路由器，通过无线网卡发射WiFi等待其他物联网设备连接。其实说白了就是无线路由器。</p>
<h1 id="前期准备"><a href="#前期准备" class="headerlink" title="前期准备"></a>前期准备</h1><p>首先我们改一下systemd-resolved，解除53端口占用。</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="built_in">echo</span> <span class="string">&quot;DNS=114.114.114.114&quot;</span>&gt;&gt;/etc/systemd/resolved.conf</span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;DNSStubListener=no&quot;</span>&gt;&gt;/etc/systemd/resolved.conf</span><br><span class="line"><span class="built_in">sudo</span> systemctl restart systemd-resolved</span><br></pre></td></tr></table></figure>
<p>然后要解除NetworkManager对wlan0的占用，先<code>nmcli -s</code>记下wlan0的mac地址，比如<code>ff:ff:ff:ff:ff:ff</code>，编辑<code>/etc/NetworkManager/NetworkManager.conf</code>，改一下下面的字段，把你的wlan0划为<code>unmanageable-devices</code></p>
<figure class="highlight ini"><table><tr><td class="code"><pre><span class="line"><span class="section">[keyfile]</span></span><br><span class="line"><span class="attr">unmanaged-devices</span>=mac:ff:ff:ff:ff:ff:ff</span><br></pre></td></tr></table></figure>
<p>最后重启NetworkManager生效</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="built_in">sudo</span> service NetworkManager restart</span><br></pre></td></tr></table></figure>
<h1 id="配置WiFi"><a href="#配置WiFi" class="headerlink" title="配置WiFi"></a>配置WiFi</h1><p>然后我们安装hostapd、dnsmasq</p>
<figure class="highlight routeros"><table><tr><td class="code"><pre><span class="line">sudo apt-<span class="built_in">get</span> install hostapd dnsmasq -y</span><br></pre></td></tr></table></figure>
<p>hostapd负责发射WiFi，先编辑他的配置文件<code>/etc/default/hostapd</code>，去掉下面这行注释并修改</p>
<figure class="highlight ini"><table><tr><td class="code"><pre><span class="line"><span class="attr">DAEMON_CONF</span>=<span class="string">&quot;/etc/hostapd/hostapd.conf&quot;</span></span><br></pre></td></tr></table></figure>
<p>再编辑他的配置文件<code>/etc/hostapd/hostapd.conf</code>，我把我的配置粘贴一下</p>
<figure class="highlight ini"><table><tr><td class="code"><pre><span class="line"><span class="attr">interface</span>=wlan0</span><br><span class="line"><span class="attr">driver</span>=nl80211</span><br><span class="line"><span class="attr">ssid</span>=Armbian</span><br><span class="line"><span class="attr">hw_mode</span>=g</span><br><span class="line"><span class="attr">channel</span>=<span class="number">7</span></span><br><span class="line"><span class="attr">wmm_enabled</span>=<span class="number">0</span></span><br><span class="line"><span class="attr">macaddr_acl</span>=<span class="number">0</span></span><br><span class="line"><span class="attr">auth_algs</span>=<span class="number">1</span></span><br><span class="line"><span class="attr">ignore_broadcast_ssid</span>=<span class="number">0</span></span><br><span class="line"><span class="attr">wpa</span>=<span class="number">2</span></span><br><span class="line"><span class="attr">wpa_passphrase</span>=<span class="number">1234567890</span></span><br><span class="line"><span class="attr">wpa_key_mgmt</span>=WPA-PSK</span><br><span class="line"><span class="attr">wpa_pairwise</span>=TKIP</span><br><span class="line"><span class="attr">rsn_pairwise</span>=CCMP</span><br></pre></td></tr></table></figure>
<p>最后启动hostapd</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="built_in">sudo</span> systemctl start hostapd.service &amp;&amp; <span class="built_in">sudo</span> systemctl <span class="built_in">enable</span> hostapd.service</span><br></pre></td></tr></table></figure>
<p>打开你的手机搜索WiFi试试，能不能搜到WiFi。搜到就行了，连不上的，因为接下来才开始配置dhcp和dns呢。</p>
<h1 id="配置DHCP和DNS"><a href="#配置DHCP和DNS" class="headerlink" title="配置DHCP和DNS"></a>配置DHCP和DNS</h1><p>首先固定wlan0的IP地址，编辑<code>/etc/network/interfaces</code></p>
<figure class="highlight nginx"><table><tr><td class="code"><pre><span class="line"><span class="attribute">auto</span> wlan0</span><br><span class="line">iface wlan0 inet static</span><br><span class="line">address <span class="number">192.168.99.1</span></span><br><span class="line">netmask <span class="number">255.255.255.0</span></span><br></pre></td></tr></table></figure>
<p>Dnsmasq是集DHCP和DNS服务器于一体的程序，我们编辑它的配置文件<code>/etc/dnsmasq.conf</code><br>我把我的<code>/etc/dnsmasq.conf</code>配置粘贴上，每个项字段在<code>dnsmasq.conf</code>里面都有解释，我就不做解释了。</p>
<figure class="highlight routeros"><table><tr><td class="code"><pre><span class="line"><span class="attribute">interface</span>=wlan0</span><br><span class="line"><span class="attribute">dhcp-range</span>=192.168.99.2,192.168.99.254,255.255.255.0,12h</span><br><span class="line">no-hosts</span><br><span class="line"><span class="attribute">addn-hosts</span>=/etc/hosts.dnsmasq</span><br></pre></td></tr></table></figure>
<p>我把我的<code>/etc/hosts.dnsmasq</code>配置粘贴上，其实就一行</p>
<figure class="highlight accesslog"><table><tr><td class="code"><pre><span class="line"><span class="number">192.168.99.1</span> armbian.lan</span><br></pre></td></tr></table></figure>
<p>最后我们启动dnsmasq</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="built_in">sudo</span> systemctl start dnsmasq.service &amp;&amp; <span class="built_in">sudo</span> systemctl <span class="built_in">enable</span> dnsmasq.service</span><br></pre></td></tr></table></figure>
<p>打开你的手机连接WiFi试试，这回可以连上，但是不能连接互联网，因为eth0和wlan0之间没有配置网络转发。</p>
<h1 id="配置iptables"><a href="#配置iptables" class="headerlink" title="配置iptables"></a>配置iptables</h1><p>首先我们要允许内核进行网络转发，在<code>/etc/sysctl.conf</code>中注意修改以下内容</p>
<figure class="highlight ini"><table><tr><td class="code"><pre><span class="line"><span class="attr">net.ipv4.ip_forward</span> = <span class="number">1</span></span><br></pre></td></tr></table></figure>
<p>然后让内核参数即时生效</p>
<figure class="highlight css"><table><tr><td class="code"><pre><span class="line">sysctl -<span class="selector-tag">p</span></span><br></pre></td></tr></table></figure>
<p>配置路由表，开启转发</p>
<figure class="highlight css"><table><tr><td class="code"><pre><span class="line">iptables -t nat -<span class="selector-tag">A</span> POSTROUTING -o eth0 -j MASQUERADE </span><br><span class="line">iptables -<span class="selector-tag">A</span> FORWARD -<span class="selector-tag">i</span> eth0 -o wlan0 -m state <span class="attr">--state</span> RELATED,ESTABLISHED -j ACCEPT </span><br><span class="line">iptables -<span class="selector-tag">A</span> FORWARD -<span class="selector-tag">i</span> wlan0 -o eth0 -j ACCEPT</span><br></pre></td></tr></table></figure>
<p>如果一切正常现在应该可以通过WiFi热点连接互联网了，但是iptables配置是重启不会保存的，我们需要先保存iptables</p>
<figure class="highlight arcade"><table><tr><td class="code"><pre><span class="line">iptables-save &gt; <span class="regexp">/etc/i</span>ptables.rules</span><br></pre></td></tr></table></figure>
<p>然后每次ifup时恢复，编辑<code>/etc/network/interfaces</code>，在wlan0那一段添加<code>up iptables-restore &lt; /etc/iptables.rules</code>，下面贴上我完整的<code>/etc/network/interfaces</code>。</p>
<figure class="highlight gradle"><table><tr><td class="code"><pre><span class="line"><span class="keyword">source</span> <span class="regexp">/etc/</span>network<span class="regexp">/interfaces.d/</span>*</span><br><span class="line"></span><br><span class="line">auto lo</span><br><span class="line">iface lo inet loopback</span><br><span class="line"></span><br><span class="line">auto wlan0</span><br><span class="line">iface wlan0 inet <span class="keyword">static</span></span><br><span class="line">address <span class="number">192.168</span>.<span class="number">99.1</span></span><br><span class="line">netmask <span class="number">255.255</span>.<span class="number">255.0</span></span><br><span class="line">up iptables-restore &lt; <span class="regexp">/etc/i</span>ptables.rules</span><br></pre></td></tr></table></figure>
<p>到此结束~</p>
]]></content>
  </entry>
  <entry>
    <title>定位Docker占用过多磁盘空间的问题</title>
    <url>/2024/02/01/docker-clean/</url>
    <content><![CDATA[<h1 id="定位爆闪存问题"><a href="#定位爆闪存问题" class="headerlink" title="定位爆闪存问题"></a>定位爆闪存问题</h1><p>从根目录开始使用<code>du -h --max-depth=1</code>一级一级往下找，最终定位到<code>/var/lib/docker/overlay2</code>占用了过多空间<br><code>docker system df -v</code>列出所有images、containers、volumes所占用的大小，发现是有一个volume占用了过多，而且并不属于任何一个container</p>
<h1 id="问题解决"><a href="#问题解决" class="headerlink" title="问题解决"></a>问题解决</h1><figure class="highlight livecodeserver"><table><tr><td class="code"><pre><span class="line">docker <span class="keyword">system</span> prune</span><br><span class="line">docker <span class="keyword">system</span> prune -<span class="keyword">a</span></span><br><span class="line">docker <span class="keyword">system</span> prune <span class="comment">--volumes</span></span><br></pre></td></tr></table></figure>

]]></content>
  </entry>
  <entry>
    <title>利用Frp+Nginx将http转化为https</title>
    <url>/2025/08/21/frp-nginx-proxy/</url>
    <content><![CDATA[<p>Home Assistant一般安装好之后都是需要通过公网来访问使用的，而Home Assistant的Web端默认只提供http访问，肯定不如https让人放心，这里一般就是用反向代理来实现了。</p>
<span id="more"></span>
<h1 id="方案选定"><a href="#方案选定" class="headerlink" title="方案选定"></a>方案选定</h1><p>我是使用frp将本地Home Assistant的Web端口(默认8123)，映射到公网主机的8080端口。之前一直是裸奔的http，但是毕竟不安全，需要升级一下。有以下几个方案备选</p>
<ul>
<li>frp本身支持将http流量转化为https。但是我觉得有些麻烦，因为证书需要在本地frpc设置好。但是我的证书每个月定时在服务器上更新(acme.sh定时任务)。</li>
<li>Home Assistant通过NGINX Home Assistant SSL proxy这个Adds-on，可以在本地实现反向代理。因为我的本地客户端没有公网IP，若配置证书只能用远程服务器的域名和证书，原因同上，维护起来太麻烦。</li>
<li>frp将流量转发到公网主机的8081端口，再由公网主机上的Nginx反向代理8081端口，并监听8082端口提供https服务。因为我已经在公网主机的Nginx上配置过TLS证书的每月自动更新，这个方法可以让我免维护。</li>
</ul>
<p>综上所述，我选择frp内网穿透+nginx反向代理的方式来完成https访问homeassistant的管理页面。示意图如下：<br><img src="diagram.svg" alt="diagram"></p>
<h1 id="配置过程"><a href="#配置过程" class="headerlink" title="配置过程"></a>配置过程</h1><p>前提条件：我远程服务器的域名是yangbo.party，已经按照之前的博文<a href="/2025/08/13/xray-reality/" title="Xray配置Vless-Reality-Vision">Xray配置Vless-Reality-Vision</a>配置好Nginx和证书。</p>
<h2 id="公网服务器配置"><a href="#公网服务器配置" class="headerlink" title="公网服务器配置"></a>公网服务器配置</h2><p>先配置frps的配置文件<code>/etc/frp/frps.toml</code></p>
<figure class="highlight ini"><table><tr><td class="code"><pre><span class="line"><span class="attr">bindPort</span> = <span class="number">7000</span></span><br><span class="line"><span class="attr">webServer.port</span> = <span class="number">7001</span></span><br><span class="line"><span class="attr">webServer.user</span> = <span class="string">&quot;admin&quot;</span></span><br><span class="line"><span class="attr">webServer.password</span> = <span class="string">&quot;xxxxx&quot;</span></span><br></pre></td></tr></table></figure>
<p>其中frp的后台管理密码自行设定。<br>再配置Nginx的配置文件<code>/etc/nginx/nginx.conf</code>，因为之前已经配置好了，所以在之前的基础上加入新的server字段:</p>
<figure class="highlight nginx"><table><tr><td class="code"><pre><span class="line"><span class="section">server</span> &#123;</span><br><span class="line">    <span class="attribute">listen</span> <span class="number">8082</span> ssl  fastopen=<span class="number">3</span>;</span><br><span class="line">    <span class="attribute">server_name</span> yangbo.party;</span><br><span class="line"></span><br><span class="line">    <span class="comment"># SSL 配置</span></span><br><span class="line">    <span class="attribute">ssl_certificate</span> /root/.acme.sh/yangbo.party_ecc/yangbo.party.cer;</span><br><span class="line">    <span class="attribute">ssl_certificate_key</span> /root/.acme.sh/yangbo.party_ecc/yangbo.party.key;</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 推荐的 SSL 安全设置</span></span><br><span class="line">    <span class="attribute">ssl_protocols</span> TLSv1.<span class="number">2</span> TLSv1.<span class="number">3</span>;</span><br><span class="line">    <span class="attribute">ssl_prefer_server_ciphers</span> <span class="literal">on</span>;</span><br><span class="line">    <span class="attribute">ssl_ciphers</span> <span class="string">&#x27;ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256&#x27;</span>;</span><br><span class="line">    <span class="attribute">ssl_session_cache</span> shared:SSL:<span class="number">10m</span>;</span><br><span class="line">    <span class="attribute">ssl_session_timeout</span> <span class="number">10m</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 安全头</span></span><br><span class="line">    <span class="attribute">add_header</span> Strict-Transport-Security <span class="string">&quot;max-age=31536000; includeSubDomains&quot;</span> always;</span><br><span class="line">    <span class="attribute">add_header</span> X-Content-Type-Options nosniff;</span><br><span class="line">    <span class="attribute">add_header</span> X-Frame-Options <span class="string">&quot;SAMEORIGIN&quot;</span>;</span><br><span class="line">    <span class="attribute">add_header</span> X-XSS-Protection <span class="string">&quot;1; mode=block&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="section">location</span> / &#123;</span><br><span class="line">        <span class="attribute">proxy_pass</span> http://127.0.0.1:8081;</span><br><span class="line"></span><br><span class="line">        <span class="comment"># 保留原始请求信息</span></span><br><span class="line">        <span class="attribute">proxy_set_header</span> Host <span class="variable">$host</span>;</span><br><span class="line">        <span class="attribute">proxy_set_header</span> X-Real-IP <span class="variable">$remote_addr</span>;</span><br><span class="line">        <span class="attribute">proxy_set_header</span> X-Forwarded-For <span class="variable">$proxy_add_x_forwarded_for</span>;</span><br><span class="line">        <span class="attribute">proxy_set_header</span> X-Forwarded-Proto <span class="variable">$scheme</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment"># WebSocket 支持（HomeAssistant 需要）</span></span><br><span class="line">        <span class="attribute">proxy_http_version</span> <span class="number">1</span>.<span class="number">1</span>;</span><br><span class="line">        <span class="attribute">proxy_set_header</span> Upgrade <span class="variable">$http_upgrade</span>;</span><br><span class="line">        <span class="attribute">proxy_set_header</span> Connection <span class="string">&quot;upgrade&quot;</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment"># 超时设置</span></span><br><span class="line">        <span class="attribute">proxy_connect_timeout</span> <span class="number">300s</span>;</span><br><span class="line">        <span class="attribute">proxy_send_timeout</span> <span class="number">300s</span>;</span><br><span class="line">        <span class="attribute">proxy_read_timeout</span> <span class="number">300s</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>全部配置好可以重启两个程序:<code>systemctl restart nginx &amp;&amp; systemctl restart frps &amp;&amp; echo &#39;OK&#39;</code></p>
<h2 id="本地客户端配置"><a href="#本地客户端配置" class="headerlink" title="本地客户端配置"></a>本地客户端配置</h2><p>HomeAssistant会验证Host头，当127.0.0.1作为代理服务器时，Home Assistant默认不信任它提供的代理头信息，而我们利用Nginx做反向代理时就是监听127.0.0.1。同时暴露在公网也要防止别人暴力破解密码。所以Home Assistant需要修改一下配置，打开<code>configuration.yaml</code>，添加以下内容:</p>
<figure class="highlight nix"><table><tr><td class="code"><pre><span class="line"><span class="params">http:</span></span><br><span class="line">  <span class="params">use_x_forwarded_for:</span> <span class="literal">true</span></span><br><span class="line">  <span class="params">trusted_proxies:</span> <span class="number">127.0</span>.<span class="number">0.1</span></span><br><span class="line">  <span class="params">ip_ban_enabled:</span> <span class="literal">true</span></span><br><span class="line">  <span class="params">login_attempts_threshold:</span> <span class="number">100</span></span><br></pre></td></tr></table></figure>
<p>修改后手动重启Home Assistant<br>本地frpc的配置文件<code>/etc/frp/frpc.toml</code>:</p>
<figure class="highlight ini"><table><tr><td class="code"><pre><span class="line"><span class="attr">serverAddr</span> = <span class="string">&quot;yangbo.party&quot;</span></span><br><span class="line"><span class="attr">serverPort</span> = <span class="number">7000</span></span><br><span class="line"></span><br><span class="line"><span class="section">[[proxies]]</span></span><br><span class="line"><span class="attr">name</span> = <span class="string">&quot;homeassistant&quot;</span></span><br><span class="line"><span class="attr">type</span> = <span class="string">&quot;tcp&quot;</span></span><br><span class="line"><span class="attr">localIP</span> = <span class="string">&quot;127.0.0.1&quot;</span></span><br><span class="line"><span class="attr">localPort</span> = <span class="number">8123</span></span><br><span class="line"><span class="attr">remotePort</span> = <span class="number">8081</span></span><br><span class="line"><span class="attr">transport.useEncryption</span> = <span class="literal">true</span></span><br><span class="line"><span class="attr">transport.useCompression</span> = <span class="literal">true</span></span><br></pre></td></tr></table></figure>
<p>这里启用了frp的<a target="_blank" rel="noopener" href="https://gofrp.org/zh-cn/docs/features/common/network/network-tls/">自定义TLS协议加密</a>，来保障内网穿透过程的信息安全。<br>配置好可以重启frpc程序:<code>systemctl restart frpc &amp;&amp; echo &#39;OK&#39;</code></p>
<h1 id="调试"><a href="#调试" class="headerlink" title="调试"></a>调试</h1><p>如果一切顺利，这个时候浏览器访问<code>https://yangbo.party:8082</code>就可以访问内网的Home Assistant了。若不行，可以直接测试nginx监听的8082端口是否可以访问：<code>curl -vk https://127.0.0.1:8082</code>或检查frps转发的8081端口是否可以访问:<code>curl -vk http://127.0.0.1:8081</code>或者查看端口占用情况：<code>ss -tulnp</code>。</p>
]]></content>
      <tags>
        <tag>HomeAssistant</tag>
        <tag>Nginx</tag>
      </tags>
  </entry>
  <entry>
    <title>移动dt741-csf改桥接</title>
    <url>/2024/02/01/dt741-bridge/</url>
    <content><![CDATA[<h1 id="无用功"><a href="#无用功" class="headerlink" title="无用功"></a>无用功</h1><p>1、网上流传的各种超级管理员密码是不管用的，因为没有通用密码，每台设备密码是绑定时随机生成的<br>2、进入控制台之后改网页源代码也是不行的，因为按钮是可以点击的，但是就是不生效<br>3、进入hidden_version_switch.html里面开启telnet也是不行的，或许联通版的可以吧，反正移动版没这个隐藏入口</p>
<h1 id="简单方法"><a href="#简单方法" class="headerlink" title="简单方法"></a>简单方法</h1><p>先按照光猫背后的普通用户和密码登陆<br>然后输入网址 <a target="_blank" rel="noopener" href="http://192.168.1.1/bridge_route.gch">http://192.168.1.1/bridge_route.gch</a><br>是的，没错，一键切换。<br>不过好像只有第一个网口是桥接的</p>
]]></content>
  </entry>
  <entry>
    <title>推送代码报错kex_exchange_identification</title>
    <url>/2024/01/24/git-push-error/</url>
    <content><![CDATA[<p>最近通过<a target="_blank" rel="noopener" href="https://weiyangbo.gitee.io/2019/10/06/Android-envsetup/#%E7%94%9F%E6%88%90-ssh-%E5%B9%B6%E6%B7%BB%E5%8A%A0%E5%88%B0-github">sshkey的方式</a>推送GitHub代码报错：<code>kex_exchange_identification: Connection closed by remote host</code></p>
<h1 id="解决方案"><a href="#解决方案" class="headerlink" title="解决方案"></a>解决方案</h1><h2 id="1、关掉梯子"><a href="#1、关掉梯子" class="headerlink" title="1、关掉梯子"></a>1、关掉梯子</h2><h2 id="2、-将-Github-的连接端口从-22-改为-443-即可"><a href="#2、-将-Github-的连接端口从-22-改为-443-即可" class="headerlink" title="2、 将 Github 的连接端口从 22 改为 443 即可"></a>2、 将 Github 的连接端口从 22 改为 443 即可</h2><p>编辑<code> ~/.ssh/config</code>文件（没有就新增），windows在用户目录下的.ssh目录，添加如下内容</p>
<figure class="highlight crmsh"><table><tr><td class="code"><pre><span class="line">Host github.com</span><br><span class="line">    HostName ssh.github.com</span><br><span class="line">    <span class="keyword">User</span> <span class="title">git</span></span><br><span class="line">    Port <span class="number">443</span></span><br><span class="line">    </span><br><span class="line">Host gitlab.com</span><br><span class="line">    HostName altssh.gitlab.com</span><br><span class="line">    <span class="keyword">User</span> <span class="title">git</span></span><br><span class="line">    Port <span class="number">443</span></span><br></pre></td></tr></table></figure>
]]></content>
  </entry>
  <entry>
    <title>利用nginx做Google镜像站</title>
    <url>/2024/01/24/nginx-google-mirror/</url>
    <content><![CDATA[<h1 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h1><p><a target="_blank" rel="noopener" href="https://github.com/cuber/ngx_http_google_filter_module">ngx_http_google_filter_module</a><br><a target="_blank" rel="noopener" href="https://github.com/cuber/ngx_http_google_filter_module/issues/152">高版本nginx兼容情况的issues</a></p>
<h1 id="先卸载已有的Nginx"><a href="#先卸载已有的Nginx" class="headerlink" title="先卸载已有的Nginx"></a>先卸载已有的Nginx</h1><figure class="highlight routeros"><table><tr><td class="code"><pre><span class="line">sudo apt <span class="built_in">remove</span> nginx -y</span><br></pre></td></tr></table></figure>

<h1 id="编译安装Nginx"><a href="#编译安装Nginx" class="headerlink" title="编译安装Nginx"></a>编译安装Nginx</h1><h2 id="下载源码"><a href="#下载源码" class="headerlink" title="下载源码"></a>下载源码</h2><figure class="highlight awk"><table><tr><td class="code"><pre><span class="line">git clone https:<span class="regexp">//gi</span>thub.com<span class="regexp">/aperezdc/</span>ngx-fancyindex.git ngx-fancyindex</span><br><span class="line">git clone https:<span class="regexp">//gi</span>thub.com<span class="regexp">/cuber/</span>ngx_http_google_filter_module</span><br><span class="line">git clone https:<span class="regexp">//gi</span>thub.com<span class="regexp">/yaoweibin/</span>ngx_http_substitutions_filter_module</span><br><span class="line">wget http:<span class="regexp">//</span>ftp.cs.stanford.edu<span class="regexp">/pub/</span>exim<span class="regexp">/pcre/</span>pcre-<span class="number">8.45</span>.zip</span><br><span class="line">wget https:<span class="regexp">//</span>www.openssl.org<span class="regexp">/source/</span>old<span class="regexp">/1.0.1/</span>openssl-<span class="number">1.0</span>.<span class="number">1</span>u.tar.gz</span><br><span class="line">wget http:<span class="regexp">//</span>zlib.net<span class="regexp">/fossils/</span>zlib-<span class="number">1.2</span>.<span class="number">11</span>.tar.gz</span><br><span class="line">wget http:<span class="regexp">//</span>nginx.org<span class="regexp">/download/</span>nginx-<span class="number">1.9</span>.<span class="number">15</span>.tar.gz</span><br><span class="line">wget http:<span class="regexp">//</span>ftp.cs.stanford.edu<span class="regexp">/pub/</span>exim<span class="regexp">/pcre/</span>pcre-<span class="number">8.45</span>.zip</span><br></pre></td></tr></table></figure>
<h2 id="解压源码"><a href="#解压源码" class="headerlink" title="解压源码"></a>解压源码</h2><figure class="highlight apache"><table><tr><td class="code"><pre><span class="line"><span class="attribute">tar</span> xzvf nginx-<span class="number">1</span>.<span class="number">9</span>.<span class="number">15</span>.tar.gz</span><br><span class="line"><span class="attribute">unzip</span> pcre-<span class="number">8</span>.<span class="number">45</span>.zip </span><br><span class="line"><span class="attribute">tar</span> xzvf openssl-<span class="number">1</span>.<span class="number">0</span>.<span class="number">1</span>u.tar.gz</span><br><span class="line"><span class="attribute">tar</span> xzvf zlib-<span class="number">1</span>.<span class="number">2</span>.<span class="number">11</span>.tar.gz </span><br></pre></td></tr></table></figure>

<h2 id="编译与安装"><a href="#编译与安装" class="headerlink" title="编译与安装"></a>编译与安装</h2><figure class="highlight jboss-cli"><table><tr><td class="code"><pre><span class="line"><span class="keyword">cd</span> nginx-1.9.15/</span><br><span class="line"><span class="string">./configure</span> <span class="params">--prefix=/usr</span> <span class="params">--sbin-path=/usr/sbin/nginx</span> <span class="params">--conf-path=/etc/nginx/nginx</span>.conf <span class="params">--error-log-path=/var/log/nginx_error</span>.log <span class="params">--http-log-path=/var/log/nginx_access</span>.log <span class="params">--pid-path=/var/run/nginx</span>.pid <span class="params">--lock-path=/var/lock/nginx</span>.lock <span class="params">--user=root</span> <span class="params">--group=root</span> <span class="params">--with-http_ssl_module</span> <span class="params">--without-http_ssi_module</span> <span class="params">--without-http_memcached_module</span> <span class="params">--without-http_browser_module</span> <span class="params">--without-http_geo_module</span>  <span class="params">--without-http_scgi_module</span>  <span class="params">--without-http_uwsgi_module</span> <span class="params">--without-select_module</span> <span class="params">--add-module=</span><span class="string">../ngx-fancyindex</span> <span class="params">--add-dynamic-module=</span><span class="string">../ngx_http_google_filter_module</span> <span class="params">--add-module=</span><span class="string">../ngx_http_substitutions_filter_module</span> <span class="params">--with-pcre=</span><span class="string">../pcre-8.45</span> <span class="params">--with-openssl=</span><span class="string">../openssl-1.0.1u</span> <span class="params">--with-zlib=</span><span class="string">../zlib-1.2.11</span> <span class="params">--with-http_v2_module</span> <span class="params">--with-http_realip_module</span></span><br><span class="line">sed -i &#x27;s/-Werror <span class="string">//g</span>&#x27; objs/Makefile</span><br><span class="line">make</span><br><span class="line">make install</span><br></pre></td></tr></table></figure>

<h1 id="Nginx加入开机自启动"><a href="#Nginx加入开机自启动" class="headerlink" title="Nginx加入开机自启动"></a>Nginx加入开机自启动</h1><figure class="highlight routeros"><table><tr><td class="code"><pre><span class="line">sudo tee /etc/systemd/system/nginx.service &gt;/dev/<span class="literal">null</span> &lt;&lt;<span class="string">&#x27;EOF&#x27;</span></span><br><span class="line">[Unit]</span><br><span class="line"><span class="attribute">Description</span>=nginx</span><br><span class="line"><span class="attribute">After</span>=network.target</span><br><span class="line"></span><br><span class="line">[Service]</span><br><span class="line"><span class="attribute">User</span>=root</span><br><span class="line"><span class="attribute">Type</span>=forking</span><br><span class="line"><span class="attribute">PIDFile</span>=/var/run/nginx.pid</span><br><span class="line"><span class="attribute">ExecStart</span>=/usr/sbin/nginx</span><br><span class="line"><span class="attribute">ExecReload</span>=/usr/sbin/nginx -s reload</span><br><span class="line"><span class="attribute">ExecStop</span>=/usr/sbin/nginx -s stop</span><br><span class="line"><span class="attribute">PrivateTmp</span>=<span class="literal">true</span></span><br><span class="line"></span><br><span class="line">[Install]</span><br><span class="line"><span class="attribute">WantedBy</span>=multi-user.target</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>
<p>将Nginx交给Systemd托管，设置Nginx下次开机启动</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="built_in">sudo</span> systemctl daemon-reload &amp;&amp; <span class="built_in">sudo</span> systemctl <span class="built_in">enable</span> nginx.service</span><br></pre></td></tr></table></figure>

<h1 id="修改Nginx配置"><a href="#修改Nginx配置" class="headerlink" title="修改Nginx配置"></a>修改Nginx配置</h1><p>1、配置文件中要加载动态模块ngx_http_google_filter_module，所以添加如下语句<code>load_module modules/ngx_http_google_filter_module.so;</code><br>2、在二级域名中添加ngx_http_google_filter_module相关配置，在我这里的二级域名是<code>go.kexie.party</code></p>
<figure class="highlight pgsql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">user</span>  root;</span><br><span class="line">worker_processes  <span class="number">1</span>;</span><br><span class="line">load_module modules/ngx_http_google_filter_module.so;</span><br><span class="line">pid        /var/run/nginx.pid;</span><br><span class="line">error_log /var/<span class="keyword">log</span>/nginx_error.<span class="keyword">log</span>;</span><br><span class="line"></span><br><span class="line">events &#123;</span><br><span class="line">    use epoll;</span><br><span class="line">    worker_connections  <span class="number">1024</span>;</span><br><span class="line">    multi_accept <span class="keyword">on</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">http &#123;</span><br><span class="line">    <span class="keyword">include</span>       /etc/nginx/mime.<span class="keyword">types</span>;</span><br><span class="line">    default_type  application/octet-stream;</span><br><span class="line">    charset ISO<span class="number">-88509</span><span class="number">-1</span>;</span><br><span class="line">    sendfile <span class="keyword">on</span>;</span><br><span class="line">    tcp_nopush     <span class="keyword">on</span>;</span><br><span class="line">    tcp_nodelay <span class="keyword">on</span>;</span><br><span class="line">    keepalive_timeout  <span class="number">60</span>;</span><br><span class="line">    client_header_buffer_size <span class="number">4</span>k;</span><br><span class="line">    open_file_cache max=<span class="number">102400</span> inactive=<span class="number">20</span>s;</span><br><span class="line">    open_file_cache_valid <span class="number">30</span>s;</span><br><span class="line">    open_file_cache_min_uses <span class="number">1</span>;</span><br><span class="line">    client_header_timeout <span class="number">15</span>;</span><br><span class="line">    client_body_timeout <span class="number">15</span>;</span><br><span class="line">    reset_timedout_connection <span class="keyword">on</span>;</span><br><span class="line">    send_timeout <span class="number">15</span>;</span><br><span class="line">    gzip <span class="keyword">on</span>;</span><br><span class="line">    gzip_disable &quot;msie6&quot;;</span><br><span class="line">    gzip_vary <span class="keyword">on</span>;</span><br><span class="line">    gzip_proxied <span class="keyword">any</span>;</span><br><span class="line">    gzip_comp_level <span class="number">3</span>;</span><br><span class="line">    gzip_buffers <span class="number">16</span> <span class="number">8</span>k;</span><br><span class="line">    gzip_http_version <span class="number">1.1</span>;</span><br><span class="line">    gzip_types <span class="type">text</span>/plain <span class="type">text</span>/css application/<span class="type">json</span> application/javascript <span class="type">text</span>/<span class="type">xml</span> application/<span class="type">xml</span> application/<span class="type">xml</span>+rss <span class="type">text</span>/javascript;</span><br><span class="line">    server_tokens <span class="keyword">off</span>;</span><br><span class="line">    access_log  /var/<span class="keyword">log</span>/nginx_access.<span class="keyword">log</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">server</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> ($host = www.kexie.party) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">301</span> https://$host$<span class="language-perl">request_uri;</span></span><br><span class="line"><span class="language-perl">    &#125; <span class="comment"># managed by Certbot</span></span></span><br><span class="line"><span class="language-perl"></span></span><br><span class="line"><span class="language-perl"></span></span><br><span class="line"><span class="language-perl">    <span class="keyword">if</span> (<span class="variable">$host</span> = kexie.party) &#123;</span></span><br><span class="line"><span class="language-perl">        <span class="keyword">return</span> <span class="number">301</span> https:<span class="regexp">//</span>$host$</span>request_uri;</span><br><span class="line">    &#125; # managed <span class="keyword">by</span> Certbot</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> ($host = go.kexie.party) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">301</span> https://$host$<span class="language-pgsql">request_uri;</span></span><br><span class="line"><span class="language-pgsql">    &#125; # managed <span class="keyword">by</span> Certbot</span></span><br><span class="line"><span class="language-pgsql"></span></span><br><span class="line"><span class="language-pgsql">        <span class="keyword">listen</span> <span class="number">80</span> default_server;</span></span><br><span class="line"><span class="language-pgsql">        <span class="keyword">return</span> <span class="number">301</span> https://$server_name$<span class="language-pgsql">request_uri;</span></span></span><br><span class="line"><span class="language-pgsql"><span class="language-pgsql"></span></span></span><br><span class="line"><span class="language-pgsql"><span class="language-pgsql">&#125;</span></span></span><br><span class="line"><span class="language-pgsql"><span class="language-pgsql"></span></span></span><br><span class="line"><span class="language-pgsql"><span class="language-pgsql">    <span class="keyword">server</span> &#123;</span></span></span><br><span class="line"><span class="language-pgsql"><span class="language-pgsql">        <span class="keyword">listen</span>       <span class="number">443</span> ssl;</span></span></span><br><span class="line"><span class="language-pgsql"><span class="language-pgsql"></span></span></span><br><span class="line"><span class="language-pgsql"><span class="language-pgsql">        # 把example.com换成你的域名</span></span></span><br><span class="line"><span class="language-pgsql"><span class="language-pgsql">        server_name  www.kexie.party kexie.party;</span></span></span><br><span class="line"><span class="language-pgsql"><span class="language-pgsql">        root         /root/mokee;</span></span></span><br><span class="line"><span class="language-pgsql"><span class="language-pgsql">        <span class="keyword">location</span> / &#123;</span></span></span><br><span class="line"><span class="language-pgsql"><span class="language-pgsql">            expires <span class="number">10</span>h;</span></span></span><br><span class="line"><span class="language-pgsql"><span class="language-pgsql">            fancyindex <span class="keyword">on</span>;</span></span></span><br><span class="line"><span class="language-pgsql"><span class="language-pgsql">            fancyindex_exact_size <span class="keyword">off</span>;</span></span></span><br><span class="line"><span class="language-pgsql"><span class="language-pgsql">            fancyindex_localtime <span class="keyword">on</span>;</span></span></span><br><span class="line"><span class="language-pgsql"><span class="language-pgsql">            fancyindex_header &quot;/fancyindex/header.html&quot;;</span></span></span><br><span class="line"><span class="language-pgsql"><span class="language-pgsql">            fancyindex_footer &quot;/fancyindex/footer.html&quot;;</span></span></span><br><span class="line"><span class="language-pgsql"><span class="language-pgsql">            fancyindex_ignore &quot;donate&quot; &quot;fancyindex&quot; &quot;Download&quot;;</span></span></span><br><span class="line"><span class="language-pgsql"><span class="language-pgsql">        &#125;</span></span></span><br><span class="line"><span class="language-pgsql"><span class="language-pgsql">        <span class="keyword">location</span> ~*  ^.+\.(jpg|gif|png|img|apk|tar.gz|wmv|jpeg|mp3|mp4|zip|rar)$ &#123;</span></span></span><br><span class="line"><span class="language-pgsql"><span class="language-pgsql">            valid_referers <span class="keyword">none</span> blocked www.kexie.party kexie.party;</span></span></span><br><span class="line"><span class="language-pgsql"><span class="language-pgsql">            <span class="keyword">if</span> ($invalid_referer)&#123;</span></span></span><br><span class="line"><span class="language-pgsql"><span class="language-pgsql">                <span class="keyword">return</span> <span class="number">403</span>;</span></span></span><br><span class="line"><span class="language-pgsql"><span class="language-pgsql">                break;</span></span></span><br><span class="line"><span class="language-pgsql"><span class="language-pgsql">            &#125;</span></span></span><br><span class="line"><span class="language-pgsql"><span class="language-pgsql">            access_log <span class="keyword">off</span>;</span></span></span><br><span class="line"><span class="language-pgsql"><span class="language-pgsql">        &#125;</span></span></span><br><span class="line"><span class="language-pgsql"><span class="language-pgsql">    &#125;</span></span></span><br><span class="line"><span class="language-pgsql"><span class="language-pgsql"></span></span></span><br><span class="line"><span class="language-pgsql"><span class="language-pgsql">    <span class="keyword">server</span> &#123;</span></span></span><br><span class="line"><span class="language-pgsql"><span class="language-pgsql">        <span class="keyword">listen</span>       <span class="number">443</span> ssl;</span></span></span><br><span class="line"><span class="language-pgsql"><span class="language-pgsql">        # 把example.com换成你的域名</span></span></span><br><span class="line"><span class="language-pgsql"><span class="language-pgsql">        server_name  go.kexie.party;</span></span></span><br><span class="line"><span class="language-pgsql"><span class="language-pgsql">        resolver <span class="number">8.8</span><span class="number">.8</span><span class="number">.8</span>;</span></span></span><br><span class="line"><span class="language-pgsql"><span class="language-pgsql">        <span class="keyword">location</span> / &#123;</span></span></span><br><span class="line"><span class="language-pgsql"><span class="language-pgsql">            google <span class="keyword">on</span>;</span></span></span><br><span class="line"><span class="language-pgsql"><span class="language-pgsql">            google_scholar <span class="keyword">on</span>;</span></span></span><br><span class="line"><span class="language-pgsql"><span class="language-pgsql">      &#125;</span></span></span><br><span class="line"><span class="language-pgsql"><span class="language-pgsql">    &#125;</span></span></span><br><span class="line"><span class="language-pgsql"><span class="language-pgsql">&#125;</span></span></span><br><span class="line"><span class="language-pgsql"><span class="language-pgsql"></span></span></span><br></pre></td></tr></table></figure>

<h1 id="安装cerbot自动申请证书"><a href="#安装cerbot自动申请证书" class="headerlink" title="安装cerbot自动申请证书"></a>安装cerbot自动申请证书</h1><p>前提是为二级域名添加dns记录，一般半小时不到生效。</p>
<figure class="highlight ada"><table><tr><td class="code"><pre><span class="line">apt install python3-certbot-nginx</span><br><span class="line">certbot <span class="comment">--nginx</span></span><br></pre></td></tr></table></figure>
<p>非常傻瓜，按照指引来就好了</p>
]]></content>
      <tags>
        <tag>Nginx</tag>
      </tags>
  </entry>
  <entry>
    <title>记录一下Openwrt的ipv6相关设置</title>
    <url>/2024/03/13/openwrt-ipv6/</url>
    <content><![CDATA[<p>OpenWRT支持ipv6有两种情况，一种是有ipv6-PD地址的（一般对应光猫桥接，路由器拨号的情况），反之就是没有ipv6-PD地址（一般对应自动获取ip）</p>
<h1 id="有IPv6-PD地址的情况"><a href="#有IPv6-PD地址的情况" class="headerlink" title="有IPv6-PD地址的情况"></a>有IPv6-PD地址的情况</h1><p>luci界面配置要点：</p>
<ul>
<li>“网络”-“接口”-“LAN”-“DHCP服务器”-“IPv6设置”<br>“RA服务”和“DHCPv6服务”都是服务器模式，“NDP 代理”设置为“混合模式”，通告的IPv6 DNS服务器填两个“2400:3200::1”、“2400:3200:baba::1”。</li>
<li>“网络”-“接口”-“LAN”-“DHCP服务器”-“IPv6 RA 设置”<br>“启用 SLAAC”打钩，“RA标记”只选一个“其他配置”。</li>
<li>“网络”-“接口”-“全局网络选项”<br>“IPv6 ULA 前缀”全部删掉，留空。</li>
<li>“网络”-“接口”-“WAN”-“高级设置”<br>“获取ipv6地址”选择“自动”。<figure class="highlight stylus"><table><tr><td class="code"><pre><span class="line">#/etc/config/network</span><br><span class="line"></span><br><span class="line">config interface <span class="string">&#x27;loopback&#x27;</span></span><br><span class="line">	<span class="selector-tag">option</span> device <span class="string">&#x27;lo&#x27;</span></span><br><span class="line">	<span class="selector-tag">option</span> proto <span class="string">&#x27;static&#x27;</span></span><br><span class="line">	<span class="selector-tag">option</span> ipaddr <span class="string">&#x27;127.0.0.1&#x27;</span></span><br><span class="line">	<span class="selector-tag">option</span> netmask <span class="string">&#x27;255.0.0.0&#x27;</span></span><br><span class="line"></span><br><span class="line">config globals <span class="string">&#x27;globals&#x27;</span></span><br><span class="line">	<span class="selector-tag">option</span> packet_steering <span class="string">&#x27;1&#x27;</span></span><br><span class="line"></span><br><span class="line">config device</span><br><span class="line">	<span class="selector-tag">option</span> name <span class="string">&#x27;br-lan&#x27;</span></span><br><span class="line">	<span class="selector-tag">option</span> type <span class="string">&#x27;bridge&#x27;</span></span><br><span class="line">	list ports <span class="string">&#x27;eth1&#x27;</span></span><br><span class="line">	<span class="selector-tag">option</span> promisc <span class="string">&#x27;1&#x27;</span></span><br><span class="line"></span><br><span class="line">config device</span><br><span class="line">	<span class="selector-tag">option</span> name <span class="string">&#x27;eth1&#x27;</span></span><br><span class="line">	<span class="selector-tag">option</span> macaddr <span class="string">&#x27;76:1d:0b:98:e3:55&#x27;</span></span><br><span class="line"></span><br><span class="line">config interface <span class="string">&#x27;lan&#x27;</span></span><br><span class="line">	<span class="selector-tag">option</span> device <span class="string">&#x27;br-lan&#x27;</span></span><br><span class="line">	<span class="selector-tag">option</span> proto <span class="string">&#x27;static&#x27;</span></span><br><span class="line">	<span class="selector-tag">option</span> ipaddr <span class="string">&#x27;192.168.0.1&#x27;</span></span><br><span class="line">	<span class="selector-tag">option</span> netmask <span class="string">&#x27;255.255.255.0&#x27;</span></span><br><span class="line">	<span class="selector-tag">option</span> ip6assign <span class="string">&#x27;64&#x27;</span></span><br><span class="line"></span><br><span class="line">config device</span><br><span class="line">	<span class="selector-tag">option</span> name <span class="string">&#x27;eth0&#x27;</span></span><br><span class="line">	<span class="selector-tag">option</span> macaddr <span class="string">&#x27;76:1d:0b:98:e3:54&#x27;</span></span><br><span class="line"></span><br><span class="line">config interface <span class="string">&#x27;wan&#x27;</span></span><br><span class="line">	<span class="selector-tag">option</span> device <span class="string">&#x27;eth0&#x27;</span></span><br><span class="line">	<span class="selector-tag">option</span> proto <span class="string">&#x27;pppoe&#x27;</span></span><br><span class="line">	<span class="selector-tag">option</span> username <span class="string">&#x27;your_username&#x27;</span></span><br><span class="line">	<span class="selector-tag">option</span> password <span class="string">&#x27;your_password&#x27;</span></span><br></pre></td></tr></table></figure>
<figure class="highlight stylus"><table><tr><td class="code"><pre><span class="line">#/etc/config/dhcp</span><br><span class="line">config dnsmasq</span><br><span class="line">	<span class="selector-tag">option</span> domainneeded <span class="string">&#x27;1&#x27;</span></span><br><span class="line">	<span class="selector-tag">option</span> boguspriv <span class="string">&#x27;1&#x27;</span></span><br><span class="line">	<span class="selector-tag">option</span> filterwin2k <span class="string">&#x27;0&#x27;</span></span><br><span class="line">	<span class="selector-tag">option</span> localise_queries <span class="string">&#x27;1&#x27;</span></span><br><span class="line">	<span class="selector-tag">option</span> rebind_protection <span class="string">&#x27;0&#x27;</span></span><br><span class="line">	<span class="selector-tag">option</span> rebind_localhost <span class="string">&#x27;1&#x27;</span></span><br><span class="line">	<span class="selector-tag">option</span> local <span class="string">&#x27;/lan/&#x27;</span></span><br><span class="line">	<span class="selector-tag">option</span> domain <span class="string">&#x27;lan&#x27;</span></span><br><span class="line">	<span class="selector-tag">option</span> expandhosts <span class="string">&#x27;1&#x27;</span></span><br><span class="line">	<span class="selector-tag">option</span> nonegcache <span class="string">&#x27;0&#x27;</span></span><br><span class="line">	<span class="selector-tag">option</span> authoritative <span class="string">&#x27;1&#x27;</span></span><br><span class="line">	<span class="selector-tag">option</span> readethers <span class="string">&#x27;1&#x27;</span></span><br><span class="line">	<span class="selector-tag">option</span> leasefile <span class="string">&#x27;/tmp/dhcp.leases&#x27;</span></span><br><span class="line">	<span class="selector-tag">option</span> nonwildcard <span class="string">&#x27;1&#x27;</span></span><br><span class="line">	<span class="selector-tag">option</span> localservice <span class="string">&#x27;0&#x27;</span></span><br><span class="line">	<span class="selector-tag">option</span> ednspacket_max <span class="string">&#x27;1232&#x27;</span></span><br><span class="line">	<span class="selector-tag">option</span> filter_aaaa <span class="string">&#x27;0&#x27;</span></span><br><span class="line">	<span class="selector-tag">option</span> filter_a <span class="string">&#x27;0&#x27;</span></span><br><span class="line">	<span class="selector-tag">option</span> port <span class="string">&#x27;53&#x27;</span></span><br><span class="line">	<span class="selector-tag">option</span> dns_redirect <span class="string">&#x27;1&#x27;</span></span><br><span class="line">	<span class="selector-tag">option</span> allservers <span class="string">&#x27;1&#x27;</span></span><br><span class="line">	<span class="selector-tag">option</span> min_ttl <span class="string">&#x27;3600&#x27;</span></span><br><span class="line">	<span class="selector-tag">option</span> dnsforwardmax <span class="string">&#x27;10000&#x27;</span></span><br><span class="line">	<span class="selector-tag">option</span> localuse <span class="string">&#x27;1&#x27;</span></span><br><span class="line">	<span class="selector-tag">option</span> noresolv <span class="string">&#x27;1&#x27;</span></span><br><span class="line">	list server <span class="string">&#x27;127.0.0.1#7874&#x27;</span></span><br><span class="line">	<span class="selector-tag">option</span> cachesize <span class="string">&#x27;0&#x27;</span></span><br><span class="line"></span><br><span class="line">config dhcp <span class="string">&#x27;lan&#x27;</span></span><br><span class="line">	<span class="selector-tag">option</span> interface <span class="string">&#x27;lan&#x27;</span></span><br><span class="line">	<span class="selector-tag">option</span> start <span class="string">&#x27;100&#x27;</span></span><br><span class="line">	<span class="selector-tag">option</span> limit <span class="string">&#x27;150&#x27;</span></span><br><span class="line">	<span class="selector-tag">option</span> leasetime <span class="string">&#x27;12h&#x27;</span></span><br><span class="line">	<span class="selector-tag">option</span> dhcpv4 <span class="string">&#x27;server&#x27;</span></span><br><span class="line">	<span class="selector-tag">option</span> ra <span class="string">&#x27;server&#x27;</span></span><br><span class="line">	<span class="selector-tag">option</span> force <span class="string">&#x27;1&#x27;</span></span><br><span class="line">	<span class="selector-tag">option</span> ndp <span class="string">&#x27;hybrid&#x27;</span></span><br><span class="line">	list dns <span class="string">&#x27;2400:3200::1&#x27;</span></span><br><span class="line">	list dns <span class="string">&#x27;2400:3200:baba::1&#x27;</span></span><br><span class="line">	list ra_flags <span class="string">&#x27;other-config&#x27;</span></span><br><span class="line">	<span class="selector-tag">option</span> dhcpv6 <span class="string">&#x27;server&#x27;</span></span><br><span class="line"></span><br><span class="line">config dhcp <span class="string">&#x27;wan&#x27;</span></span><br><span class="line">	<span class="selector-tag">option</span> interface <span class="string">&#x27;wan&#x27;</span></span><br><span class="line">	<span class="selector-tag">option</span> ignore <span class="string">&#x27;1&#x27;</span></span><br><span class="line"></span><br><span class="line">config odhcpd <span class="string">&#x27;odhcpd&#x27;</span></span><br><span class="line">	<span class="selector-tag">option</span> maindhcp <span class="string">&#x27;0&#x27;</span></span><br><span class="line">	<span class="selector-tag">option</span> leasefile <span class="string">&#x27;/tmp/hosts/odhcpd&#x27;</span></span><br><span class="line">	<span class="selector-tag">option</span> leasetrigger <span class="string">&#x27;/usr/sbin/odhcpd-update&#x27;</span></span><br><span class="line">	<span class="selector-tag">option</span> loglevel <span class="string">&#x27;4&#x27;</span></span><br></pre></td></tr></table></figure>

</li>
</ul>
<h1 id="无IPv6-PD地址的情况"><a href="#无IPv6-PD地址的情况" class="headerlink" title="无IPv6-PD地址的情况"></a>无IPv6-PD地址的情况</h1><p>luci界面配置要点：</p>
<ul>
<li>“网络”-“接口”-“LAN”-“DHCP服务器”-“IPv6设置”<br>“RA服务”、“DHCPv6服务”和“NDP 代理”都是中继模式。</li>
<li>“网络”-“接口”-“全局网络选项”<br>“IPv6 ULA 前缀”全部删掉，留空。</li>
<li>“网络”-“接口”-“WAN”-“高级设置”<br>“获取ipv6地址”选择“自动”。</li>
<li>“网络”-“接口”-“WAN”-“DHCP服务器”-“IPv6设置”<br>“指定的主接口”打钩。</li>
</ul>
<h1 id="DDNS设置"><a href="#DDNS设置" class="headerlink" title="DDNS设置"></a>DDNS设置</h1><p>我想要ipv6主要是想要公网ip，这当然需要DDNS。设置的时候ip地址来源选择“网络”，ipv6地址对应一个虚拟动态接口，在我这里叫“wan_6”。</p>
]]></content>
      <tags>
        <tag>openwrt</tag>
      </tags>
  </entry>
  <entry>
    <title>Windows下Samba的匿名访问</title>
    <url>/2023/07/02/samba-anonymous/</url>
    <content><![CDATA[<p>Windows下搞定samba匿名访问是件很困难的事情</p>
<h1 id="Windows客户端设置"><a href="#Windows客户端设置" class="headerlink" title="Windows客户端设置"></a>Windows客户端设置</h1><p>Win+S，输入 <code>cmd.exe</code>，以管理员身份运行命令提示符。</p>
<figure class="highlight dockerfile"><table><tr><td class="code"><pre><span class="line">reg <span class="keyword">add</span><span class="language-bash"> HKLM\SYSTEM\CurrentControlSet\Services\LanmanWorkstation\Parameters /v AllowInsecureGuestAuth /t reg_dword /d 00000001 /f</span></span><br></pre></td></tr></table></figure>

<p>Win+S，输入 启用或关闭 Windows 功能<br>启用 SMBv1 协议</p>
<p>Win+S，输入 secpol.msc，以管理员身份启动本地安全策略管理控制台。<br>转到 “本地策略 -&gt; 安全选项”，将 Microsoft 网络客户端：对通信进行数字签名（如果服务器允许） 和 Microsoft 网络客户端：对通信进行数字签名（始终） 的安全设置设为 已禁用。</p>
<h1 id="Windows服务端设置"><a href="#Windows服务端设置" class="headerlink" title="Windows服务端设置"></a>Windows服务端设置</h1><p>在计算机管理窗口中，依次打开，计算机管理（本地）-&gt; 本地用户和组 -&gt; 用户, 在guest属性弹窗中取消勾选“账户已禁用”，并点击“应用”、“确定”即可。</p>
<p>win+R调出运行，输入“gpedit.msc”，回车。在本地组策略编辑器中，依次展开：计算机配置 -&gt; Windows设置 -&gt; 安全设置 -&gt; 本地策略 -&gt; 用户权限分配 -&gt; 拒绝从网络访问这台计算机，右击属性，在弹出的属性中删除guest账户（假如有的话，没有就不管），点击确定。</p>
<p>win+R调出运行，输入“gpedit.msc”，回车。在本地组策略编辑器中，依次展开：计算机配置 -&gt; Windows设置 -&gt; 安全设置 -&gt; 本地策略 -&gt; 安全选项 -&gt; 将“网络访问：本地帐户的共享和安全模式”，修改为“仅来宾-本地帐户以来宾身份验证”将“帐户：使用空白密码的本地帐户只允许通过控制台登录”，设置为已禁用。 </p>
<p>在cmd窗口中输入“gpupdate /force”，回车，等待更新策略，完成。</p>
<p>当然肯定要在控制面板里面关闭密码共享，开启文件夹共享，如果权限里面没有GUEST的话你要添加GUEST账户。</p>
<h1 id="Linux服务端设置"><a href="#Linux服务端设置" class="headerlink" title="Linux服务端设置"></a>Linux服务端设置</h1><p><code>sudo apt install samba wsdd</code>,然后编辑文件<code>/etc/samba/smb.conf</code></p>
<figure class="highlight abnf"><table><tr><td class="code"><pre><span class="line">[global]</span><br><span class="line">        workgroup <span class="operator">=</span> WORKGROUP</span><br><span class="line">	server string <span class="operator">=</span> %h server</span><br><span class="line">	log file <span class="operator">=</span> /var/log/samba/log.%m</span><br><span class="line">	max log size <span class="operator">=</span> <span class="number">1000</span></span><br><span class="line">	syslog <span class="operator">=</span> <span class="number">0</span></span><br><span class="line">	panic action <span class="operator">=</span> /usr/share/samba/panic-action %d</span><br><span class="line">	write cache size <span class="operator">=</span> <span class="number">524288</span></span><br><span class="line">	getwd cache <span class="operator">=</span> yes</span><br><span class="line">	socket options <span class="operator">=</span> TCP_NODELAY IPTOS_LOWDELAY</span><br><span class="line">        map to guest <span class="operator">=</span> Bad User</span><br><span class="line">        server role <span class="operator">=</span> standalone server</span><br><span class="line">        usershare allow guests <span class="operator">=</span> yes</span><br><span class="line">        wins support <span class="operator">=</span> yes</span><br><span class="line">        local master <span class="operator">=</span> yes</span><br><span class="line">        preferred master <span class="operator">=</span> yes</span><br><span class="line">        server min protocol <span class="operator">=</span> NT1</span><br><span class="line">        lanman auth <span class="operator">=</span> no</span><br><span class="line">        ntlm auth <span class="operator">=</span> yes</span><br><span class="line">        client lanman auth <span class="operator">=</span> no</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[TN3399_Share]</span><br><span class="line">	comment <span class="operator">=</span> TN3399_SATA</span><br><span class="line">	path <span class="operator">=</span> /mnt/sata</span><br><span class="line">	writable <span class="operator">=</span> yes</span><br><span class="line">	guest only <span class="operator">=</span> yes</span><br><span class="line">	force create mode <span class="operator">=</span> <span class="number">0777</span></span><br><span class="line">        public <span class="operator">=</span> yes</span><br><span class="line">        browseable <span class="operator">=</span> yes</span><br></pre></td></tr></table></figure>
<p><code>sudo systemctl restart smbd.service &amp;&amp; sudo systemctl enable --now wsdd</code></p>
]]></content>
  </entry>
  <entry>
    <title>vsftpd配置root用户登录</title>
    <url>/2024/01/27/vsftpd-root/</url>
    <content><![CDATA[<p><code>nano /etc/vsftpd.conf</code></p>
<figure class="highlight ini"><table><tr><td class="code"><pre><span class="line"><span class="attr">listen</span>=<span class="literal">yes</span></span><br><span class="line"><span class="attr">listen_ipv6</span>=<span class="literal">no</span></span><br><span class="line"><span class="attr">anonymous_enable</span>=<span class="literal">NO</span></span><br><span class="line"><span class="attr">local_enable</span>=<span class="literal">YES</span></span><br><span class="line"><span class="attr">write_enable</span>=<span class="literal">YES</span></span><br><span class="line"><span class="attr">local_umask</span>=<span class="number">022</span></span><br><span class="line"><span class="attr">dirmessage_enable</span>=<span class="literal">YES</span></span><br><span class="line"><span class="attr">use_localtime</span>=<span class="literal">YES</span></span><br><span class="line"><span class="attr">chown_uploads</span>=<span class="literal">YES</span></span><br><span class="line"><span class="attr">chown_username</span>=root</span><br><span class="line"><span class="attr">rsa_cert_file</span>=/etc/ssl/certs/ssl-cert-snakeoil.pem</span><br><span class="line"><span class="attr">rsa_private_key_file</span>=/etc/ssl/private/ssl-cert-snakeoil.key</span><br><span class="line"><span class="attr">ssl_enable</span>=<span class="literal">NO</span></span><br><span class="line"><span class="attr">utf8_filesystem</span>=<span class="literal">YES</span></span><br><span class="line"><span class="attr">pasv_enable</span>=<span class="literal">YES</span></span><br><span class="line"><span class="attr">pasv_min_port</span>=<span class="number">21</span></span><br><span class="line"><span class="attr">pasv_max_port</span>=<span class="number">21</span></span><br><span class="line"><span class="attr">local_root</span>=/mnt/sata</span><br></pre></td></tr></table></figure>
<p>注释掉<code>/etc/ftpusers</code>中的<code>root</code><br>最后<code>service restart vsftpd</code></p>
]]></content>
  </entry>
  <entry>
    <title>用WLED控制流光灯带并接入Home Assistant</title>
    <url>/2022/03/08/wled-HA/</url>
    <content><![CDATA[<h1 id="引言"><a href="#引言" class="headerlink" title="引言"></a>引言</h1>bad asset path...
<p>视频中的LED灯条，是由许多5050型RGB灯组成，其中每个RGB灯集成了红色、绿色、蓝色的三色LED灯和非常紧凑的WS2812B LED驱动器IC。根据三个红色、绿色和蓝色LED的强度，我们可以模拟出我们想要的任何颜色和亮度。 把许多RGB的连在一起并单独控制，就可以形成动态的灯带。<br><img src="ws2812.webp" alt="ws2812"><br>WLED固件既可以方便无门槛刷入ESP系列芯片、接入Home Assistant控制，而且各种自定义设置直接拉满，你想怎么自定义都行。</p>
<h1 id="硬件准备"><a href="#硬件准备" class="headerlink" title="硬件准备"></a>硬件准备</h1><ul>
<li>ESP8266/ESP32开发板（推荐FLASH大于1MB的ESP开发板，否则不支持OTA升级）</li>
<li>WS2812B灯带</li>
<li>足功率的5V电源（具体咨询卖灯带的客服）</li>
<li>电脑一台和USB数据线(用于为ESP8266刷写固件)</li>
</ul>
<h1 id="刷写固件"><a href="#刷写固件" class="headerlink" title="刷写固件"></a>刷写固件</h1><p>如果你的ESP8266/ESP32的FLASH大小是4MB的，官方推荐<a target="_blank" rel="noopener" href="https://install.wled.me/">WLED web installer</a>网页方式刷入固件。<br>否则的话需要手动下载<a target="_blank" rel="noopener" href="https://github.com/Aircoookie/WLED/releases">最新的WLED固件</a>和<a target="_blank" rel="noopener" href="https://github.com/esphome/esphome-flasher/releases">ESP Home Flasher</a>，用ESP Home Flasher将最新固件刷入你的ESP开发板。<br>刷机过程略过，大家自行百度。只要第一次刷如WLED，后期升级可以使用OTA方式升级，无需接线。</p>
<h1 id="硬件连接"><a href="#硬件连接" class="headerlink" title="硬件连接"></a>硬件连接</h1><p><img src="wled_hw.png" alt="wled_hw"><br>其中的电源建议6V-5V的输入，电流一定要根据灯带中LED的数量选择足瓦的电源。电容是为了稳定性建议加的，不加也行。</p>
<h1 id="首次设置"><a href="#首次设置" class="headerlink" title="首次设置"></a>首次设置</h1><p>将整个灯带和开发板通电，用手机或者其他设备，打开wifi，连接<code>WLED-AP</code>,密码是<code>wled1234</code>。在浏览器中访问<a target="_blank" rel="noopener" href="http://4.3.2.1/">4.3.2.1</a>，选择”WIFI SETTINGS”<br><img src="welcome-to-wled.png" alt="welcome-to-wled"><br>输入你家WiFi的SSID和密码，其他的可以不设置，或者根据自己需要设置，拉到最下面点击”Save&amp;Connect”，你的开发板会自动重启并连接上WiFi。<br>等待几秒钟重启完成后，可以访问wled从路由器自动获取的IP地址来进入WLED的管理页面。<br>也可以进入Home Assistant的面板，在通知中找找被自动发现的WLED设备并按照向导配置。如果没有自动发现，可以手动点击“添加集成”，然后搜索“WLED”添加即可。（图都是我从网上找的，懒得重新配置了）<br><img src="Home-Assistant-and-WLED-integration-scaled.png" alt="Home-Assistant-and-WLED-integration-scaled"></p>
]]></content>
      <tags>
        <tag>HomeAssistant</tag>
        <tag>ESP芯片</tag>
      </tags>
  </entry>
  <entry>
    <title>Xray配置Vless-Reality-Vision</title>
    <url>/2025/08/13/xray-reality/</url>
    <content><![CDATA[<p>随着人工智能发展，审查手段加入机器学习，使得原来Trojan方式因为含有<a target="_blank" rel="noopener" href="https://github.com/XTLS/Xray-core/discussions/1295">TLS in TLS</a>特征而有概率被筛选出来。现如今最隐蔽的手段莫过于利用Xray工具搭建vless通信协议+reality传输层安全协议+xtls-rprx-vision流量控制的组合，如此一来审查者看到的是一次正常的 HTTPS 连接（单层 TLS），而非嵌套的 TLS in TLS</p>
<span id="more"></span>
<h1 id="写在前面"><a href="#写在前面" class="headerlink" title="写在前面"></a>写在前面</h1><h2 id="适用情况"><a href="#适用情况" class="headerlink" title="适用情况"></a>适用情况</h2><ul>
<li>一台外网服务器</li>
<li>一个申请好的域名（假设为yangbo.party，自己处理好DNS解析)<br>整个方案的流量链路跟传统的trojan是一样的，只是改进了传输方式。<br><img src="diagram.svg" alt="diagram"></li>
</ul>
<p>本篇博文主要是介绍自己在服务器有网站，并且想把Xray隐藏在自己的网站后面。对自己而言，可以用浏览器正常访问自己的网站，可以通过Xray出墙；对审查者而言，只能看到我们的网站，以为我们的流量都是访问网站的。<br>如果你没有自己的网站，那就只需要把自己的Xray服务器伪装成一个国外网站的CDN，你也不需要建站、申请证书了，本篇教程不适合你，请转官方配置文档<a target="_blank" rel="noopener" href="https://github.com/XTLS/Xray-examples/tree/main/VLESS-TCP-XTLS-Vision-REALITY">VLESS-TCP-XTLS-Vision-REALITY</a></p>
<h2 id="本方案的优势"><a href="#本方案的优势" class="headerlink" title="本方案的优势"></a>本方案的优势</h2><p>传统的Trojan方式，用户的代理客户端与代理服务器建立一个真实的TLS连接，通过这个加密的隧道，应用程序（比如浏览器）再与目标服务器（比如Google）建立一个TLS连接。这时浏览器与Google服务器之间的端对端加密是建立在代理客户端与代理服务器的加密连接之上的。<br>浏览器 — 代理客户端 === 代理服务器 — Google<br>基于之前的技术手段，审查者只能看到我们通过443端口建立了TLS连接，看不到具体内容，以为我们在正常访问网页。但是随着机器学习的介入，这样的手段依旧有概率被识破：<br>代理客户端与代理服务器之间的加密套娃无可避免的一点就是在每个包都会增加一个数据包头，加密层数越多，包头就会越重。最重要的，由于每个包都增加了相同长度，它可能具有某些统计学特征。</p>
<p>目前新的方案中，我个人理解如下：</p>
<ul>
<li>Vless通信协议相当于是一个协议容器，它本身不对流量加密，对流量的处理也基本依靠传输协议和流量控制。</li>
<li>Reality传输层安全协议，从根本上解决了TLS in TLS的现象。在握手阶段模仿一个国外网站的CDN节点（比如Google）与客户端建立TLS连接（当然这个TLS连接证书肯定是无效的，不过两边都会忽略这个问题）。握手成功后，当传输内容是TLS加密后的内容时，就不对流量进行二次加密了。</li>
<li>Vision流量控制则会填充数据包长度，来消除统计学特征。<del>其实有了Reality就够了，不知道再使用vision流控会不会画蛇添足。</del>vision的全称是xtls-rprx-vision流量控制，从它的名称可以看出它曾是xtls的一部分，xtls慢慢被放弃之后，vision从传输协议降级为流量控制协议，总之官方有这种配置方法，说明两个可以协同工作。<br>这个方案不仅大大降低了被检测到几率，同时带来显而易见的好处：在本地路由器上部署Xray客户端时，可以减少90%的解密计算量，减少延时；如果是手机等移动客户端，同理也会优化功耗。缺点嘛。。。应该就是配置文件太长，没办法记住，要找个地方存一下。</li>
</ul>
<h1 id="服务器端配置"><a href="#服务器端配置" class="headerlink" title="服务器端配置"></a>服务器端配置</h1><h2 id="安装Nginx"><a href="#安装Nginx" class="headerlink" title="安装Nginx"></a>安装Nginx</h2><p>如果已经安装了Nginx，请<code>nginx -V</code>确认编译参数中是否含有<code>--with-http_ssl_module</code>、<code>--with-http_v2_module</code>、<code>--with-http_realip_module</code>、<code>TLS SNI support enabled</code><br>如果以上模块不齐全，建议按照下一行重新编译安装。本教程的配置在<code>1.29.0</code>版本中通过测试<br>Nginx安装参见我之前的文章<a href="/2019/10/26/Nginx-FancyIndex/" title="编译安装Nginx+FancyIndex">编译安装Nginx</a></p>
<h2 id="安装Xray"><a href="#安装Xray" class="headerlink" title="安装Xray"></a>安装Xray</h2><p>如果已经安装Xray，请<code>xray version</code>检查版本是否&gt;=24.9.30<br>如果版本过低，必须升级以支持最新的流控方式和传输模式。本教程的配置在<code>25.8.3</code>版本中通过测试<br>Xray采用脚本一键安装</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">bash -c <span class="string">&quot;<span class="subst">$(curl -L https://github.com/XTLS/Xray-install/raw/main/install-release.sh)</span>&quot;</span> @ install</span><br></pre></td></tr></table></figure>
<h2 id="申请SSL证书"><a href="#申请SSL证书" class="headerlink" title="申请SSL证书"></a>申请SSL证书</h2><p>一键安装acme.sh</p>
<figure class="highlight vim"><table><tr><td class="code"><pre><span class="line">sudo apt <span class="keyword">update</span> &amp;&amp; sudo apt install -<span class="keyword">y</span> curl socat &amp;&amp; curl https://<span class="built_in">get</span>.acme.<span class="keyword">sh</span> | <span class="keyword">sh</span> -s email=你的邮箱地址</span><br></pre></td></tr></table></figure>
<p>官方分为<a target="_blank" rel="noopener" href="https://github.com/acmesh-official/acme.sh/wiki/%E8%AF%B4%E6%98%8E#2-%E7%94%9F%E6%88%90%E8%AF%81%E4%B9%A6">两大类申请证书的方式</a>:<code>HTTP验证</code>和<code>DNS验证</code>，要是细分还有很多情况，这里我选择DNS验证，支持<a target="_blank" rel="noopener" href="https://github.com/acmesh-official/acme.sh/wiki/dnsapi">几乎所有的域名提供商</a>。我的域名提供商是Namesilo，只要去Namesilo网站获取API，然后写入系统变量就好了。</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="built_in">echo</span> <span class="string">&quot;export Namesilo_Key=&#x27;&lt;key&gt;&#x27;&quot;</span> &gt; ~/.bashrc &amp;&amp; <span class="built_in">source</span> bashrc</span><br></pre></td></tr></table></figure>
<p>然后尝试获取证书，成功之后记下证书路径就好了，其他的不用管了，每个月acme.sh会自动帮我续期证书。</p>
<figure class="highlight stylus"><table><tr><td class="code"><pre><span class="line">acme<span class="selector-class">.sh</span> <span class="attr">--issue</span> <span class="attr">--dns</span> dns_namesilo -d yangbo<span class="selector-class">.party</span> -d www<span class="selector-class">.yangbo</span><span class="selector-class">.party</span> <span class="attr">--dnssleep</span> <span class="number">900</span> <span class="attr">--server</span> letsencrypt <span class="attr">--force</span> <span class="attr">--reloadcmd</span> <span class="string">&quot;chmod -R 777 /root/.acme.sh/yangbo.party_ecc/ &amp;&amp; systemctl reload nginx&quot;</span></span><br></pre></td></tr></table></figure>
<h2 id="配置Nginx和Xray"><a href="#配置Nginx和Xray" class="headerlink" title="配置Nginx和Xray"></a>配置Nginx和Xray</h2><p>先说原理：Xray监听443端口，通过层层验证判断是否为代理请求，如果不是就回落到Nginx监听的8080，如果是就建立通道。（其实整体跟Trojan一样，只不过验证阶段使用TLS，建立完请求后，不再对正常访问https网站产生的TLS流量加密)。<br>Nginx默认配置文件路径:<code>/etc/nginx/nginx.conf</code></p>
<figure class="highlight pgsql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">user</span>  root;</span><br><span class="line">worker_processes  <span class="number">1</span>;</span><br><span class="line">pid /var/run/nginx.pid;</span><br><span class="line">error_log /var/<span class="keyword">log</span>/nginx_error.<span class="keyword">log</span>;</span><br><span class="line">events &#123;</span><br><span class="line">    use epoll;</span><br><span class="line">    worker_connections  <span class="number">1024</span>;</span><br><span class="line">    multi_accept <span class="keyword">on</span>;</span><br><span class="line">&#125;</span><br><span class="line">http &#123;</span><br><span class="line">    <span class="keyword">include</span>       /etc/nginx/mime.<span class="keyword">types</span>;</span><br><span class="line">    default_type  application/octet-stream;</span><br><span class="line">    charset utf<span class="number">-8</span>,gbk;</span><br><span class="line">    sendfile <span class="keyword">on</span>;</span><br><span class="line">    tcp_nopush     <span class="keyword">on</span>;</span><br><span class="line">    tcp_nodelay <span class="keyword">on</span>;</span><br><span class="line">    keepalive_timeout  <span class="number">60</span>;</span><br><span class="line">    client_header_buffer_size <span class="number">4</span>k;</span><br><span class="line">    open_file_cache max=<span class="number">102400</span> inactive=<span class="number">20</span>s;</span><br><span class="line">    open_file_cache_valid <span class="number">30</span>s;</span><br><span class="line">    open_file_cache_min_uses <span class="number">1</span>;</span><br><span class="line">    client_header_timeout <span class="number">15</span>;</span><br><span class="line">    client_body_timeout <span class="number">15</span>;</span><br><span class="line">    reset_timedout_connection <span class="keyword">on</span>;</span><br><span class="line">    send_timeout <span class="number">15</span>;</span><br><span class="line">    http2_recv_buffer_size <span class="number">32</span>k;</span><br><span class="line">    gzip <span class="keyword">on</span>;</span><br><span class="line">    gzip_disable &quot;msie6&quot;;</span><br><span class="line">    gzip_vary <span class="keyword">on</span>;</span><br><span class="line">    gzip_proxied <span class="keyword">any</span>;</span><br><span class="line">    gzip_comp_level <span class="number">3</span>;</span><br><span class="line">    gzip_buffers <span class="number">16</span> <span class="number">8</span>k;</span><br><span class="line">    gzip_http_version <span class="number">1.1</span>;</span><br><span class="line">    gzip_types <span class="type">text</span>/plain <span class="type">text</span>/css application/<span class="type">json</span> application/javascript <span class="type">text</span>/<span class="type">xml</span> application/<span class="type">xml</span> application/<span class="type">xml</span>+rss <span class="type">text</span>/javascript;</span><br><span class="line">    server_tokens <span class="keyword">off</span>;</span><br><span class="line">    access_log  /var/<span class="keyword">log</span>/nginx_access.<span class="keyword">log</span>;</span><br><span class="line">    <span class="keyword">server</span> &#123; #如果有人访问http端口，就把它重定向到<span class="number">443</span>端口，这就跟其他网站行为一致</span><br><span class="line">        <span class="keyword">listen</span> <span class="number">80</span>;</span><br><span class="line">        server_name  www.yangbo.party yangbo.party;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">301</span> https://$server_name$<span class="language-ruby">request_uri;</span></span><br><span class="line"><span class="language-ruby">    &#125;</span></span><br><span class="line"><span class="language-ruby"></span></span><br><span class="line"><span class="language-ruby">    server &#123; <span class="comment">#8080端口当作正常https网页去设置，注意替换证书路径</span></span></span><br><span class="line"><span class="language-ruby">        listen <span class="number">127.0</span>.<span class="number">0.1</span><span class="symbol">:</span><span class="number">8080</span> ssl fastopen=<span class="number">3</span>;</span></span><br><span class="line"><span class="language-ruby">        http2 on;</span></span><br><span class="line"><span class="language-ruby">        server_name www.yangbo.party yangbo.party;</span></span><br><span class="line"><span class="language-ruby">        ssl_early_data on;</span></span><br><span class="line"><span class="language-ruby">        ssl_buffer_size 4k;</span></span><br><span class="line"><span class="language-ruby">        keepalive_timeout 75s;</span></span><br><span class="line"><span class="language-ruby">        ssl_certificate /root/.acme.sh/yangbo.party_ecc/yangbo.party.cer;</span></span><br><span class="line"><span class="language-ruby">        ssl_certificate_key /root/.acme.sh/yangbo.party_ecc/yangbo.party.key;</span></span><br><span class="line"><span class="language-ruby">        ssl_protocols <span class="title class_">TLSv1</span>.<span class="number">2</span> <span class="title class_">TLSv1</span>.<span class="number">3</span>;</span></span><br><span class="line"><span class="language-ruby">        ssl_prefer_server_ciphers on;</span></span><br><span class="line"><span class="language-ruby">        ssl_ciphers <span class="variable constant_">ECDHE</span>-<span class="variable constant_">ECDSA</span>-<span class="variable constant_">AES128</span>-<span class="variable constant_">GCM</span>-<span class="variable constant_">SHA256</span><span class="symbol">:ECDHE-RSA-AES128-GCM-SHA256</span><span class="symbol">:ECDHE-ECDSA-AES256-GCM-SHA384</span><span class="symbol">:ECDHE-RSA-AES256-GCM-SHA384</span><span class="symbol">:ECDHE-ECDSA-CHACHA20-POLY1305</span><span class="symbol">:ECDHE-RSA-CHACHA20-POLY1305</span><span class="symbol">:DHE-RSA-AES128-GCM-SHA256</span><span class="symbol">:DHE-RSA-AES256-GCM-SHA384</span>;</span></span><br><span class="line"><span class="language-ruby">        ssl_session_cache <span class="symbol">shared:</span><span class="variable constant_">SSL</span><span class="symbol">:</span>10m;</span></span><br><span class="line"><span class="language-ruby">        ssl_session_timeout 10m;</span></span><br><span class="line"><span class="language-ruby">        client_max_body_size 20M;</span></span><br><span class="line"><span class="language-ruby">        client_body_timeout <span class="number">12</span>;</span></span><br><span class="line"><span class="language-ruby">        underscores_in_headers on;</span></span><br><span class="line"><span class="language-ruby">        location / &#123;</span></span><br><span class="line"><span class="language-ruby">            root /www/;</span></span><br><span class="line"><span class="language-ruby">            expires 10h;</span></span><br><span class="line"><span class="language-ruby">            fancyindex on;</span></span><br><span class="line"><span class="language-ruby">            fancyindex_exact_size off;</span></span><br><span class="line"><span class="language-ruby">            fancyindex_localtime on;</span></span><br><span class="line"><span class="language-ruby">            fancyindex_header <span class="string">&quot;/fancyindex/header.html&quot;</span>;</span></span><br><span class="line"><span class="language-ruby">            fancyindex_footer <span class="string">&quot;/fancyindex/footer.html&quot;</span>;</span></span><br><span class="line"><span class="language-ruby">            fancyindex_ignore <span class="string">&quot;fancyindex&quot;</span>;</span></span><br><span class="line"><span class="language-ruby">        &#125;</span></span><br><span class="line"><span class="language-ruby">        location ~*  ^.+\.(jpg|<span class="params">gif</span>|png|<span class="params">img</span>|apk|<span class="params">tar.gz</span>|wmv|<span class="params">jpeg</span>|mp3|<span class="params">mp4</span>|zip|<span class="params">rar)$ &#123;</span></span></span><br><span class="line"><span class="params"><span class="language-ruby">            valid_referers none blocked www.yangbo.party yangbo.party;</span></span></span><br><span class="line"><span class="params"><span class="language-ruby">            <span class="keyword">if</span> ($invalid_referer)&#123;</span></span></span><br><span class="line"><span class="params"><span class="language-ruby">                <span class="keyword">return</span> 403;</span></span></span><br><span class="line"><span class="params"><span class="language-ruby">                <span class="keyword">break</span>;</span></span></span><br><span class="line"><span class="params"><span class="language-ruby">            &#125;</span></span></span><br><span class="line"><span class="params"><span class="language-ruby">        &#125;</span></span></span><br><span class="line"><span class="params"><span class="language-ruby">    &#125;</span></span></span><br><span class="line"><span class="params"><span class="language-ruby">&#125;</span></span></span><br></pre></td></tr></table></figure>

<p>Xray默认配置文件路径:<code>/usr/local/etc/xray/config.json</code>,Xray配置较为复杂，可以参考<a target="_blank" rel="noopener" href="https://xtls.github.io/config/">官方wiki</a></p>
<figure class="highlight prolog"><table><tr><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="string">&quot;log&quot;</span>: &#123;</span><br><span class="line">      <span class="string">&quot;loglevel&quot;</span>: <span class="string">&quot;debug&quot;</span>,</span><br><span class="line">      <span class="string">&quot;access&quot;</span>: <span class="string">&quot;/var/log/xray/access.log&quot;</span>,</span><br><span class="line">      <span class="string">&quot;error&quot;</span>: <span class="string">&quot;/var/log/xray/error.log&quot;</span></span><br><span class="line">    &#125;,</span><br><span class="line">  <span class="string">&quot;inbounds&quot;</span>: [</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="string">&quot;port&quot;</span>: <span class="number">443</span>,</span><br><span class="line">      <span class="string">&quot;protocol&quot;</span>: <span class="string">&quot;vless&quot;</span>,</span><br><span class="line">      <span class="string">&quot;settings&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;clients&quot;</span>: [</span><br><span class="line">          &#123;</span><br><span class="line">            <span class="string">&quot;id&quot;</span>: <span class="string">&quot;使用xray uuid命令随机生成&quot;</span>,</span><br><span class="line">            <span class="string">&quot;flow&quot;</span>: <span class="string">&quot;xtls-rprx-vision&quot;</span></span><br><span class="line">          &#125;</span><br><span class="line">        ],</span><br><span class="line">        <span class="string">&quot;decryption&quot;</span>: <span class="string">&quot;none&quot;</span>,</span><br><span class="line">        <span class="string">&quot;fallbacks&quot;</span>: [</span><br><span class="line">          &#123;</span><br><span class="line">            <span class="string">&quot;dest&quot;</span>: <span class="string">&quot;127.0.0.1:8080&quot;</span>,</span><br><span class="line">            <span class="string">&quot;xver&quot;</span>: <span class="number">0</span></span><br><span class="line">          &#125;</span><br><span class="line">        ]</span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="string">&quot;streamSettings&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;network&quot;</span>: <span class="string">&quot;raw&quot;</span>,</span><br><span class="line">        <span class="string">&quot;security&quot;</span>: <span class="string">&quot;reality&quot;</span>,</span><br><span class="line">        <span class="string">&quot;realitySettings&quot;</span>: &#123;</span><br><span class="line">          <span class="string">&quot;show&quot;</span>: false,</span><br><span class="line">          <span class="string">&quot;target&quot;</span>: <span class="string">&quot;127.0.0.1:8080&quot;</span>,</span><br><span class="line">          <span class="string">&quot;xver&quot;</span>: <span class="number">0</span>,</span><br><span class="line">          <span class="string">&quot;serverNames&quot;</span>: [<span class="string">&quot;yangbo.party&quot;</span>,<span class="string">&quot;www.yangbo.party&quot;</span>],</span><br><span class="line">          <span class="string">&quot;privateKey&quot;</span>: <span class="string">&quot;运行命令xray x25519生成，其中的privateKey&quot;</span>,</span><br><span class="line">          <span class="string">&quot;password&quot;</span>: <span class="string">&quot;上一条命令xray x25519生成，其中的publicKey&quot;</span>,</span><br><span class="line">          <span class="string">&quot;fingerprint&quot;</span>: <span class="string">&quot;chrome&quot;</span>,</span><br><span class="line">          <span class="string">&quot;shortIds&quot;</span>: [<span class="string">&quot;运行 openssl rand -hex 4 命令生成&quot;</span>]</span><br><span class="line">        &#125;,</span><br><span class="line">          <span class="string">&quot;sockopt&quot;</span>: &#123;</span><br><span class="line">              <span class="string">&quot;tcpNoDelay&quot;</span>: true,</span><br><span class="line">              <span class="string">&quot;tcpFastOpen&quot;</span>: true,</span><br><span class="line">              <span class="string">&quot;tcpKeepAliveInterval&quot;</span>: <span class="number">30</span>,</span><br><span class="line">              <span class="string">&quot;tcpcongestion&quot;</span>: <span class="string">&quot;bbr&quot;</span></span><br><span class="line">		  &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  ],</span><br><span class="line">  <span class="string">&quot;outbounds&quot;</span>: [</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="string">&quot;protocol&quot;</span>: <span class="string">&quot;freedom&quot;</span>,</span><br><span class="line">      <span class="string">&quot;settings&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;sockopt&quot;</span>: &#123;</span><br><span class="line">          <span class="string">&quot;tcpNoDelay&quot;</span>: true,</span><br><span class="line">          <span class="string">&quot;tcpFastOpen&quot;</span>: true,</span><br><span class="line">          <span class="string">&quot;tcpKeepAliveInterval&quot;</span>: <span class="number">30</span>,</span><br><span class="line">          <span class="string">&quot;tcpcongestion&quot;</span>: <span class="string">&quot;bbr&quot;</span></span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="string">&quot;protocol&quot;</span>: <span class="string">&quot;blackhole&quot;</span>,</span><br><span class="line">      <span class="string">&quot;settings&quot;</span>: &#123;&#125;,</span><br><span class="line">      <span class="string">&quot;tag&quot;</span>: <span class="string">&quot;blocked&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">  ],</span><br><span class="line">    <span class="string">&quot;routing&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;rules&quot;</span>: [</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="string">&quot;type&quot;</span>: <span class="string">&quot;field&quot;</span>,</span><br><span class="line">        <span class="string">&quot;ip&quot;</span>: [<span class="string">&quot;geoip:private&quot;</span>],</span><br><span class="line">        <span class="string">&quot;outboundTag&quot;</span>: <span class="string">&quot;blocked&quot;</span></span><br><span class="line">      &#125;</span><br><span class="line">    ]</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>systemctl restart nginx &amp;&amp; systemctl restart xray</code></p>
<h3 id="排错指南"><a href="#排错指南" class="headerlink" title="排错指南"></a>排错指南</h3><p> 理论上这一步结束，就应该完成了。试试看直接浏览器访问网页能不能正常回落。若不能，可以直接测试nginx监听的8080端口是否可以访问：<code>curl -vk https://127.0.0.1:8080</code>或检查端口是否被监听：<code>ss -tulnp</code>或查看xray和nginx的日志（日志目录见配置文件）</p>
<h2 id="一些网络优化"><a href="#一些网络优化" class="headerlink" title="一些网络优化"></a>一些网络优化</h2><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="built_in">echo</span> <span class="string">&quot;net.ipv4.tcp_fastopen=3&quot;</span> &gt;&gt; /etc/sysctl.conf</span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;net.core.default_qdisc=fq&quot;</span> &gt;&gt; /etc/sysctl.conf</span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;net.ipv4.tcp_congestion_control=bbr&quot;</span> &gt;&gt; /etc/sysctl.conf</span><br><span class="line">sysctl -p</span><br></pre></td></tr></table></figure>
<h1 id="客户端推荐"><a href="#客户端推荐" class="headerlink" title="客户端推荐"></a>客户端推荐</h1><ul>
<li>电脑端推荐<a target="_blank" rel="noopener" href="https://github.com/2dust/v2rayN/releases">v2rayN</a></li>
<li>Android推荐<a target="_blank" rel="noopener" href="https://github.com/2dust/v2rayNG/releases">v2rayNG</a></li>
<li>OpenWrt推荐<a target="_blank" rel="noopener" href="https://github.com/immortalwrt/homeproxy">homeproxy</a>。是sing-box内核，但是兼容xray的vless+reality这种组合。</li>
</ul>
<h1 id="后记"><a href="#后记" class="headerlink" title="后记"></a>后记</h1><p>懂行的朋友可以看出我这种配置的弊端或者说可以改进的地方：</p>
<ul>
<li>xray配置中fallback到nginx的流量并不是xray官方建议的proxy protocol v1流量，而是原始流量。这样在nginx看来所有请求都是来自127.0.0.1这个IP，并不知道真实的访问者IP。如果nginx中想做一些基于ip地址的防护、日志排查就做不到了。我不启用proxy protocol的原因是reality协议中需要一个对外完全正常的https网站，这与处理proxy protocol类型的fallback流量冲突。如果想要完美解决这个问题，需要专门再开一个端口，nginx再专门监听fallback流量，想想就算了，反正就自己的静态网站，这么做何必呢。</li>
<li>本文用的传输方式(transport)是raw(旧称tcp)，是一个保守但稳妥的协议。明显xray目前的发展方向是<a target="_blank" rel="noopener" href="https://github.com/XTLS/Xray-core/discussions/4113">xhttp</a>，功能更强大，速度更快。但是一来这个特性目前只有xray支持，OpenWrt上没有好用的xray客户端。二来新功能的抗审查能力还有待观察。</li>
</ul>
]]></content>
      <tags>
        <tag>Nginx</tag>
        <tag>梯子</tag>
      </tags>
  </entry>
</search>
